This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.dockerignore
.env.example
.gitignore
.npmrc
Audit(29.01.2026).md
biome.json
docker-compose.yml
Dockerfile
drizzle.config.ts
drizzle/0000_flat_grandmaster.sql
drizzle/0001_pretty_whiplash.sql
drizzle/meta/_journal.json
drizzle/meta/0000_snapshot.json
drizzle/meta/0001_snapshot.json
eslint.config.mjs
next.config.ts
package.json
pnpm-workspace.yaml
postcss.config.mjs
public/file.svg
public/globe.svg
public/next.svg
public/vercel.svg
public/window.svg
README.md
scripts/test-rate-limit.ts
src/actions/auth.ts
src/actions/chat-actions.ts
src/app/auth/callback/route.ts
src/app/chat/[id]/page.tsx
src/app/chat/page.tsx
src/app/favicon.ico
src/app/globals.css
src/app/layout.tsx
src/app/page.tsx
src/components/auth/auth-buttons.tsx
src/components/auth/AuthProvider.tsx
src/components/chat/AttachmentPreview.tsx
src/components/chat/ChatInput.tsx
src/components/chat/ComposerAddons.tsx
src/components/chat/ImageModal.tsx
src/components/chat/MessageBubble.tsx
src/components/chat/MessageMediaGrid.tsx
src/components/chat/ReplyPreview.tsx
src/components/GlobalErrorBoundary.tsx
src/components/layout/ChatLayoutWrapper.tsx
src/components/layout/Navbar.tsx
src/components/layout/Sidebar.tsx
src/components/Providers.tsx
src/components/sidebar/ChatList.tsx
src/components/sidebar/ContactItem.tsx
src/components/sidebar/ContactsList.tsx
src/components/sidebar/NewChatButton.tsx
src/components/sidebar/PresenceIndicator.tsx
src/components/sidebar/SearchInput.tsx
src/components/sidebar/Sidebar.tsx
src/components/sidebar/SidebarShell.tsx
src/components/SupabaseAuthProvider.tsx
src/components/ui/alert-dialog.tsx
src/components/ui/button.tsx
src/components/ui/confirmation-dialog.tsx
src/components/ui/context-menu.tsx
src/components/ui/dialog.tsx
src/components/ui/dropdown-menu.tsx
src/components/ui/Logo.tsx
src/db/index.ts
src/db/schema.ts
src/hooks/useAttachment.ts
src/hooks/useChatHooks.ts
src/hooks/useGlobalRealtime.ts
src/lib/date-utils.ts
src/lib/supabase.ts
src/lib/supabase/client.ts
src/lib/supabase/middleware.ts
src/lib/supabase/server.ts
src/lib/supabase/utils.ts
src/lib/utils.ts
src/middleware.ts
src/store/useChatStore.ts
src/store/usePresenceStore.ts
src/types/index.ts
src/wdyr.ts
supabase/.gitignore
supabase/config.toml
supabase/migrations/20240127000000_remote_schema.sql
supabase/migrations/20260128000000_realtime_setup.sql
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".dockerignore">
# Dependencies
node_modules
.pnpm-store

# Build output
.next
out
build
dist

# Logs
*-debug.log*
*-error.log*
pnpm-debug.log*

# OS/IDE
.DS_Store
.idea
.vscode
*.tsbuildinfo

# Git
.git
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*
!.env.example

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path=".npmrc">
strict-peer-dependencies=true
engine-strict=true
frozen-lockfile=true
shamefully-hoist=false
</file>

<file path="Audit(29.01.2026).md">
The following structural audit highlights key strengths and critical areas for improvement in the Trace project.

üìä Executive Summary
The project is built on a modern, robust stack (Next.js App Router, Supabase, TanStack Query, Drizzle). It correctly implements virtualization (Virtuoso) and separates data fetching hooks from UI components.

However, the architecture relies heavily on a runtime transformation layer (humps) to bridge the gap between Database (snake_case) and UI (camelCase). This architectural choice, while convenient, introduces significant type safety gaps, performance overhead, and fragility in Realtime updates.

1. üèó Project Structure & Scalability
Directory Organization: The structure is logical (app, components, hooks, lib). Separation of concerns is generally good.
"Fat Component" Alert:
src/components/chat/MessageBubble.tsx
 (~255 lines): This component is doing too much. It handles:
Rendering logic (Message vs Image vs File).
Context Menus (Edit/Delete/Reply).
Complex Memoization logic.
Recommendation: Extract sub-components like <MessageAttachments />, <MessageContextMenu />, and <MessageStatus /> to reduce complexity and improve readability.
Virtualization: Usage of react-virtuoso in 
ChatPage
 is a strong scalability win, ensuring the app can handle thousands of messages without DOM bloat.
2. üîÑ Data Flow & State Management (Critical)
The "Humps" Bottleneck:
Observation: You are using a global 
fetch
 interceptor in 
src/lib/supabase/client.ts
 to convert all casing via humps.
Risk: This is a blocking synchronous operation on the main thread. For large payloads (e.g., fetching initial chat history of 50+ items), this JSON parsing and recursive key mapping can cause frame drops.
Inconsistency: Realtime payloads (WebSockets) do not pass through this fetch interceptor. This forces you to manually normalize them in 
useGlobalRealtime.ts
 (using 
normalizePayload
) or risk undefined values.
Redundant State Logic:
Logic for "Mark as Read" exists in three places:
useChatHooks.ts
 (Optimistic updates in mutations).
useGlobalRealtime.ts
 (Manual cache patching on socket events).
ChatPage.tsx (Derived state calculation recipientLastReadAt).
Risk: This redundancy increases the chance of "flickering" UI states where the optimistic update fights with the realtime patch.
3. üõ° Database & Type Safety
Type Safety Gap:
Observation: The Drizzle schema (
src/db/schema.ts
) uses strict snake_case, but your Types (
src/types/index.ts
) are a hybrid of camelCase with optional snake_case fields to satisfy the runtime conversion.
Evidence: In 
useGlobalRealtime.ts
, we see explicit casting like 
(message as any).created_at
. This "bypasses" TypeScript, hiding potential bugs where a field might be renamed in the DB but not in the code.
Loose Typing:
In 
src/types/index.ts
, attachments is typed as any[]. This defeats strict mode checks and risks runtime errors if the attachment structure changes (e.g., from url to path).
4. ‚ö° Real-time & Performance
Fragile Cache Patching:
Observation: 
useGlobalRealtime.ts
 manually iterates over oldData.pages (Infinite Query data) to patch messages.
Risk: This is O(N) complexity relative to the size of loaded history. If the internal structure of InfiniteData changes (which TanStack Query does major versions), this code will silently break.
Re-render Risks:
The 
MessageBubble
 custom memo comparator is complex. If recipientLastReadAt changes in the parent (
ChatPage
), it likely invalidates every message bubble's memo check simultaneously, causing a heavy re-render cycle even for old messages that don't need updating.
5. üîí Security & Edge Cases
Client-Side "Security":
useDeleteMessage
 relies on !data || data.length === 0 to detect failures. Ensure Row Level Security (RLS) policies strictly enforce delete permissions on the server. The client check is just a UX fallback.
Empty States:
Handling is good (
ChatPage
 has specific empty state UI).
Error Handling:
The global toaster interceptor in 
client.ts
 is a good pattern for consistent UX, but ensure it doesn't swallow errors that should be handled by specific components (e.g., a "404 Chat Not Found" should redirect, not just toast).
üìù Action Plan Recommendations
Strict Typing: Replace attachments: any[] with attachments: Attachment[] immediately.
Standardize Data Shape: Consider moving away from runtime humps conversion. It is often better to accept snake_case from the DB (matching Drizzle types) and only map to camelCase at the very edge (Component props) or just use snake_case consistently to avoid the O(N) runtime cost.
Refactor Realtime: Instead of manually patching deep nested arrays in 
useGlobalRealtime
, consider using queryClient.invalidateQueries for lists and queryClient.setQueryData only for single-item updates to reduce complexity.
Split Components: Break 
MessageBubble
 into smaller files to isolate the "Context Menu" logic from the "Render" logic.
</file>

<file path="biome.json">
{
  "$schema": "https://biomejs.dev/schemas/2.3.11/schema.json",
  "assist": { "actions": { "source": { "organizeImports": "on" } } },
  "linter": {
    "enabled": true,
    "rules": {
      "recommended": true,
      "correctness": {
        "noUnusedVariables": "warn"
      }
    }
  },
  "formatter": {
    "enabled": true,
    "indentStyle": "space",
    "indentWidth": 2,
    "lineWidth": 100
  },
  "css": {
    "parser": {
      "cssModules": true,
      "tailwindDirectives": true
    }
  },
  "javascript": {
    "formatter": {
      "quoteStyle": "single",
      "semicolons": "always"
    }
  }
}
</file>

<file path="docker-compose.yml">
services:
  app:
    build: .
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
</file>

<file path="Dockerfile">
# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π –æ–±—Ä–∞–∑ Node.js
FROM node:22-alpine

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É –≤–µ—Ä—Å—ñ—é pnpm, —è–∫ —É —Ç–≤–æ—î–º—É package.json
RUN npm install -g pnpm@10.28.1

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ä–æ–±–æ—á—É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
WORKDIR /app

# –ö–æ–ø—ñ—é—î–º–æ —Ñ–∞–π–ª–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
COPY package.json pnpm-lock.yaml .npmrc ./

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ frozen-lockfile –∑–≥—ñ–¥–Ω–æ –∑ –¥–æ–∫)
RUN pnpm install --frozen-lockfile

# –ö–æ–ø—ñ—é—î–º–æ –≤–µ—Å—å —ñ–Ω—à–∏–π –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç—É
COPY . .

# –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –ø–æ—Ä—Ç –¥–ª—è Next.js
EXPOSE 3000

# –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–æ–µ–∫—Ç —É –¥–µ–≤-—Ä–µ–∂–∏–º—ñ
CMD ["pnpm", "dev"]
</file>

<file path="drizzle/0000_flat_grandmaster.sql">
CREATE TABLE "chats" (
	"id" text PRIMARY KEY NOT NULL,
	"user_id" text NOT NULL,
	"recipient_id" text,
	"title" text DEFAULT 'New Chat' NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "messages" (
	"id" text PRIMARY KEY NOT NULL,
	"chat_id" text NOT NULL,
	"sender_id" text NOT NULL,
	"content" text,
	"attachments" jsonb DEFAULT '[]'::jsonb NOT NULL,
	"reply_to_id" text,
	"is_read" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "user" (
	"id" text PRIMARY KEY NOT NULL,
	"name" text,
	"email" text NOT NULL,
	"emailVerified" timestamp,
	"image" text,
	"last_seen" timestamp DEFAULT now(),
	CONSTRAINT "user_email_unique" UNIQUE("email")
);
--> statement-breakpoint
ALTER TABLE "chats" ADD CONSTRAINT "chats_user_id_user_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."user"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "chats" ADD CONSTRAINT "chats_recipient_id_user_id_fk" FOREIGN KEY ("recipient_id") REFERENCES "public"."user"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "messages" ADD CONSTRAINT "messages_chat_id_chats_id_fk" FOREIGN KEY ("chat_id") REFERENCES "public"."chats"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "messages" ADD CONSTRAINT "messages_sender_id_user_id_fk" FOREIGN KEY ("sender_id") REFERENCES "public"."user"("id") ON DELETE cascade ON UPDATE no action;
</file>

<file path="drizzle/0001_pretty_whiplash.sql">
CREATE TABLE "upload_audit" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
ALTER TABLE "chats" ALTER COLUMN "id" SET DATA TYPE uuid;--> statement-breakpoint
ALTER TABLE "chats" ALTER COLUMN "id" SET DEFAULT gen_random_uuid();--> statement-breakpoint
ALTER TABLE "chats" ALTER COLUMN "user_id" SET DATA TYPE uuid;--> statement-breakpoint
ALTER TABLE "chats" ALTER COLUMN "recipient_id" SET DATA TYPE uuid;--> statement-breakpoint
ALTER TABLE "messages" ALTER COLUMN "id" SET DATA TYPE uuid;--> statement-breakpoint
ALTER TABLE "messages" ALTER COLUMN "id" SET DEFAULT gen_random_uuid();--> statement-breakpoint
ALTER TABLE "messages" ALTER COLUMN "chat_id" SET DATA TYPE uuid;--> statement-breakpoint
ALTER TABLE "messages" ALTER COLUMN "sender_id" SET DATA TYPE uuid;--> statement-breakpoint
ALTER TABLE "messages" ALTER COLUMN "reply_to_id" SET DATA TYPE uuid;--> statement-breakpoint
ALTER TABLE "user" ALTER COLUMN "id" SET DATA TYPE uuid;--> statement-breakpoint
ALTER TABLE "chats" ADD COLUMN "user_last_read_id" uuid;--> statement-breakpoint
ALTER TABLE "chats" ADD COLUMN "recipient_last_read_id" uuid;--> statement-breakpoint
ALTER TABLE "upload_audit" ADD CONSTRAINT "upload_audit_user_id_user_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."user"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "idx_upload_audit_user_time" ON "upload_audit" USING btree ("user_id","created_at");--> statement-breakpoint
ALTER TABLE "chats" ADD CONSTRAINT "chats_user_last_read_id_messages_id_fk" FOREIGN KEY ("user_last_read_id") REFERENCES "public"."messages"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "chats" ADD CONSTRAINT "chats_recipient_last_read_id_messages_id_fk" FOREIGN KEY ("recipient_last_read_id") REFERENCES "public"."messages"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "messages" ADD CONSTRAINT "messages_reply_to_id_messages_id_fk" FOREIGN KEY ("reply_to_id") REFERENCES "public"."messages"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "idx_chats_users" ON "chats" USING btree ("user_id","recipient_id");--> statement-breakpoint
CREATE INDEX "idx_messages_chat_created" ON "messages" USING btree ("chat_id","created_at");--> statement-breakpoint
CREATE INDEX "idx_messages_sender" ON "messages" USING btree ("sender_id");--> statement-breakpoint
CREATE INDEX "idx_user_email" ON "user" USING btree ("email");--> statement-breakpoint
ALTER TABLE "messages" DROP COLUMN "is_read";
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";
// –Ü–º–ø–æ—Ä—Ç—É—î–º–æ –ø–ª–∞–≥—ñ–Ω (–≤–∞–∂–ª–∏–≤–æ: RC –≤–µ—Ä—Å—ñ—è –º–æ–∂–µ –≤–∏–º–∞–≥–∞—Ç–∏ —Ç–∞–∫–æ–≥–æ —ñ–º–ø–æ—Ä—Ç—É)
import reactCompiler from "eslint-plugin-react-compiler";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  
  // –î–æ–¥–∞—î–º–æ –∫–æ–Ω—Ñ—ñ–≥ –¥–ª—è React Compiler
  {
    plugins: {
      "react-compiler": reactCompiler,
    },
    rules: {
      "react-compiler/react-compiler": "error",
    },
  },

  globalIgnores([
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="pnpm-workspace.yaml">
packages:
  - .
ignoredBuiltDependencies:
  - sharp
  - unrs-resolver
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="scripts/test-rate-limit.ts">
async function testRateLimit() {
  const url = 'http://localhost:3000/api/upload'; // Testing against /api/upload
  console.log(`Starting rate limit test against ${url}...`);

  for (let i = 1; i <= 15; i++) {
    try {
      const res = await fetch(url, { method: 'GET' });
      const status = res.status;
      const body = await res.json().catch(() => ({}));
      
      console.log(`Request ${i}: Status ${status}`, body);

      if (status === 429) {
        console.log('SUCCESS: Rate limit hit at request', i);
        return;
      }
    } catch (error: any) {
      console.error(`Request ${i} failed:`, error.message);
    }
  }
}

testRateLimit();
</file>

<file path="src/app/chat/page.tsx">
'use client';

import { MessageSquare } from 'lucide-react';

export default function ChatEmptyPage() {
  return (
    <div className="flex flex-col items-center justify-center h-[calc(100vh-64px)] text-center px-4 bg-black/40">
      <div className="w-24 h-24 bg-white/[0.03] rounded-3xl flex items-center justify-center mb-8 border border-white/10 shadow-2xl">
        <MessageSquare className="w-12 h-12 text-gray-500/50" />
      </div>
      <h2 className="text-3xl font-bold text-white/80 mb-3 tracking-tight">Trace Messaging</h2>
      <p className="text-gray-500 max-w-[280px] mx-auto text-sm leading-relaxed">
        Select a chat from the sidebar to start messaging with your contacts.
      </p>
    </div>
  );
}
</file>

<file path="src/components/chat/ReplyPreview.tsx">
'use client';

import { X } from 'lucide-react';
import { Button } from '@/components/ui/button';

interface ReplyPreviewProps {
  replyingTo: {
    id: string;
    sender: string;
    content: string;
  } | null;
  onCancel: () => void;
}

export function ReplyPreview({ replyingTo, onCancel }: ReplyPreviewProps) {
  if (!replyingTo) return null;

  return (
    <div className="flex items-center justify-between px-4 py-2 bg-gray-800/50 border-t border-white/10 text-sm">
      <div className="flex flex-col overflow-hidden">
        <span className="text-blue-400 font-medium">Replying to {replyingTo.sender}</span>
        <span className="text-gray-400 truncate max-w-md">{replyingTo.content}</span>
      </div>
      <Button variant="ghost" size="icon" onClick={onCancel} className="h-8 w-8 hover:bg-white/10">
        <X className="w-4 h-4 text-gray-400" />
      </Button>
    </div>
  );
}
</file>

<file path="src/components/GlobalErrorBoundary.tsx">
'use client';

import { Component, ErrorInfo, ReactNode } from 'react';
import { Button } from '@/components/ui/button';
import { AlertCircle, RotateCcw } from 'lucide-react';

interface Props {
  children: ReactNode;
}

interface State {
  hasError: boolean;
  error?: Error;
}

export class GlobalErrorBoundary extends Component<Props, State> {
  public state: State = {
    hasError: false,
  };

  public static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  public componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error('Uncaught error:', error, errorInfo);
  }

  public render() {
    if (this.state.hasError) {
      return (
        <div className="flex min-h-screen flex-col items-center justify-center bg-black text-white p-4">
          <div className="flex flex-col items-center gap-4 max-w-md text-center">
            <div className="p-4 rounded-full bg-red-500/10 text-red-500">
              <AlertCircle size={48} />
            </div>
            <h2 className="text-2xl font-bold tracking-tight">Something went wrong</h2>
            <p className="text-zinc-400">
              We encountered an unexpected error. Our team has been notified.
            </p>
            <div className="flex gap-2 mt-4">
              <Button 
                onClick={() => window.location.reload()} 
                variant="outline"
                className="gap-2"
              >
                <RotateCcw size={16} />
                Reload Page
              </Button>
              <Button 
                onClick={() => this.setState({ hasError: false })}
                className="gap-2 bg-white text-black hover:bg-zinc-200"
              >
                Try Again
              </Button>
            </div>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}
</file>

<file path="src/components/layout/Sidebar.tsx">
'use client';

import { MessageSquare, Settings, User, Users } from 'lucide-react';
import Link from 'next/link';
import { usePathname } from 'next/navigation';

const navItems = [
  { icon: MessageSquare, label: 'Chats', href: '/' },
  { icon: Users, label: 'Contacts', href: '/contacts' },
  { icon: User, label: 'Profile', href: '/profile' },
  { icon: Settings, label: 'Settings', href: '/settings' },
];

export default function Sidebar() {
  const pathname = usePathname();

  return (
    <aside className="fixed left-0 top-16 bottom-0 w-20 md:w-64 border-r border-white/10 bg-black/50 backdrop-blur-md z-40 hidden sm:flex flex-col py-6">
      <div className="flex-1 px-4 space-y-2">
        {navItems.map((item) => {
          const isActive = pathname === item.href;
          return (
            <Link
              key={item.href}
              href={item.href}
              className={`flex items-center gap-3 px-4 py-3 rounded-xl transition-all group ${
                isActive
                  ? 'bg-white/10 text-white'
                  : 'text-gray-400 hover:bg-white/5 hover:text-white'
              }`}
            >
              <item.icon className="w-5 h-5" />
              <span className="hidden md:block font-medium">{item.label}</span>
            </Link>
          );
        })}
      </div>
    </aside>
  );
}
</file>

<file path="src/components/sidebar/NewChatButton.tsx">
'use client';

import { Plus } from 'lucide-react';
import { useRouter } from 'next/navigation';

export default function NewChatButton() {
  const router = useRouter();

  const handleCreateChat = async () => {
    // –¢—É—Ç –±—É–¥–µ –ª–æ–≥—ñ–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —á–∞—Ç—É –≤ –ë–î —á–µ—Ä–µ–∑ Server Action
    // –ê–ª–µ –¥–ª—è MVP –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏–º–æ –Ω–∞ –¥–æ–º–∞—à–Ω—é/–Ω–æ–≤—É —Å—Ç–æ—Ä—ñ–Ω–∫—É
    router.push('/');
  };

  return (
    <div className="px-4 mb-4">
      <button
        type="button"
        onClick={handleCreateChat}
        className="w-full flex items-center justify-center gap-2 bg-white text-black hover:bg-gray-200 transition-colors py-3 rounded-xl font-bold text-sm shadow-lg shadow-white/5 active:scale-95 duration-75"
      >
        <Plus className="w-4 h-4" />
        –ù–æ–≤–∏–π —á–∞—Ç
      </button>
    </div>
  );
}
</file>

<file path="src/components/sidebar/PresenceIndicator.tsx">
'use client';

import { usePresenceStore } from '@/store/usePresenceStore';
import { cn } from '@/lib/utils';
import { memo } from 'react';

interface PresenceIndicatorProps {
  userId: string;
  className?: string;
  showOffline?: boolean;
}

function PresenceIndicatorBase({ userId, className, showOffline = false }: PresenceIndicatorProps) {
  // Select ONLY the boolean value to prevent re-renders when other users change status
  const isOnline = usePresenceStore((state) => state.onlineUsers.has(userId));

  if (!isOnline && !showOffline) return null;

  return (
    <div 
      className={cn(
        "rounded-full border-2 border-black", 
        isOnline ? "bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.5)]" : "bg-gray-500",
        className
      )} 
    />
  );
}

export const PresenceIndicator = memo(PresenceIndicatorBase);
</file>

<file path="src/components/ui/button.tsx">
import { Slot } from '@radix-ui/react-slot';
import { cva, type VariantProps } from 'class-variance-authority';
import * as React from 'react';

import { cn } from '@/lib/utils';

const buttonVariants = cva(
  'inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50',
  {
    variants: {
      variant: {
        default: 'bg-primary text-primary-foreground hover:bg-primary/90',
        destructive: 'bg-destructive text-destructive-foreground hover:bg-destructive/90',
        outline: 'border border-input bg-background hover:bg-accent hover:text-accent-foreground',
        secondary: 'bg-secondary text-secondary-foreground hover:bg-secondary/80',
        ghost: 'hover:bg-accent hover:text-accent-foreground',
        link: 'text-primary underline-offset-4 hover:underline',
      },
      size: {
        default: 'h-10 px-4 py-2',
        sm: 'h-9 rounded-md px-3',
        lg: 'h-11 rounded-md px-8',
        icon: 'h-10 w-10',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'default',
    },
  },
);

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean;
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : 'button';
    return (
      <Comp className={cn(buttonVariants({ variant, size, className }))} ref={ref} {...props} />
    );
  },
);
Button.displayName = 'Button';

export { Button, buttonVariants };
</file>

<file path="src/components/ui/confirmation-dialog.tsx">
'use client';

import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';

interface ConfirmationDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  title: string;
  description: string;
  onConfirm: () => void;
  isLoading?: boolean;
}

export function ConfirmationDialog({
  open,
  onOpenChange,
  title,
  description,
  onConfirm,
  isLoading,
}: ConfirmationDialogProps) {
  return (
    <AlertDialog open={open} onOpenChange={onOpenChange}>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>{title}</AlertDialogTitle>
          <AlertDialogDescription>{description}</AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel disabled={isLoading}>Cancel</AlertDialogCancel>
          <AlertDialogAction
            onClick={onConfirm}
            disabled={isLoading}
            className="bg-red-600 hover:bg-red-700 text-white"
          >
            {isLoading ? 'Processing...' : 'Delete'}
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
</file>

<file path="src/components/ui/dialog.tsx">
'use client';

import * as DialogPrimitive from '@radix-ui/react-dialog';
import { X } from 'lucide-react';
import * as React from 'react';

import { cn } from '@/lib/utils';

const Dialog = DialogPrimitive.Root;

const DialogTrigger = DialogPrimitive.Trigger;

const DialogPortal = DialogPrimitive.Portal;

const DialogClose = DialogPrimitive.Close;

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      'fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0',
      className,
    )}
    {...props}
  />
));
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName;

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        'fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg',
        className,
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
));
DialogContent.displayName = DialogPrimitive.Content.displayName;

const DialogHeader = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn('flex flex-col space-y-1.5 text-center sm:text-left', className)} {...props} />
);
DialogHeader.displayName = 'DialogHeader';

const DialogFooter = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn('flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2', className)}
    {...props}
  />
);
DialogFooter.displayName = 'DialogFooter';

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn('text-lg font-semibold leading-none tracking-tight', className)}
    {...props}
  />
));
DialogTitle.displayName = DialogPrimitive.Title.displayName;

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn('text-sm text-muted-foreground', className)}
    {...props}
  />
));
DialogDescription.displayName = DialogPrimitive.Description.displayName;

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogClose,
  DialogTrigger,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
};
</file>

<file path="src/lib/supabase/utils.ts">
import { camelizeKeys } from 'humps';

/**
 * Standardizes Realtime payloads to match the format of fetch results.
 * Handles camelCase conversion and any necessary data mapping.
 */
export function normalizePayload<T>(payload: any): T {
  if (!payload) return payload;
  
  // 1. Camelize keys (snake_case from DB -> camelCase for UI)
  const camelized = camelizeKeys(payload);
  
  // 2. Add any custom mappings if needed (e.g. converting string IDs to numbers if necessary, 
  // but here we mostly use strings).
  // We can also ensure dates are handled consistently here if needed.
  
  return camelized as T;
}
</file>

<file path="src/lib/utils.ts">
import { type ClassValue, clsx } from 'clsx';
import { twMerge } from 'tailwind-merge';

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
</file>

<file path="src/store/usePresenceStore.ts">
import { create } from 'zustand';

interface PresenceState {
  onlineUsers: Set<string>;
  setOnlineUsers: (users: Set<string>) => void;
}

export const usePresenceStore = create<PresenceState>((set) => ({
  onlineUsers: new Set(),
  setOnlineUsers: (users) => set({ onlineUsers: users }),
}));
</file>

<file path="supabase/.gitignore">
# Supabase
.branches
.temp

# dotenvx
.env.keys
.env.local
.env.*.local
</file>

<file path="supabase/config.toml">
# For detailed configuration reference documentation, visit:
# https://supabase.com/docs/guides/local-development/cli/config
# A string used to distinguish different Supabase projects on the same host. Defaults to the
# working directory name when running `supabase init`.
project_id = "Trace"

[api]
enabled = true
# Port to use for the API URL.
port = 54321
# Schemas to expose in your API. Tables, views and stored procedures in this schema will get API
# endpoints. `public` and `graphql_public` schemas are included by default.
schemas = ["public", "graphql_public"]
# Extra schemas to add to the search_path of every request.
extra_search_path = ["public", "extensions"]
# The maximum number of rows returns from a view, table, or stored procedure. Limits payload size
# for accidental or malicious requests.
max_rows = 1000

[api.tls]
# Enable HTTPS endpoints locally using a self-signed certificate.
enabled = false
# Paths to self-signed certificate pair.
# cert_path = "../certs/my-cert.pem"
# key_path = "../certs/my-key.pem"

[db]
# Port to use for the local database URL.
port = 54322
# Port used by db diff command to initialize the shadow database.
shadow_port = 54320
# Maximum amount of time to wait for health check when starting the local database.
health_timeout = "2m"
# The database major version to use. This has to be the same as your remote database's. Run `SHOW
# server_version;` on the remote database to check.
major_version = 17

[db.pooler]
enabled = false
# Port to use for the local connection pooler.
port = 54329
# Specifies when a server connection can be reused by other clients.
# Configure one of the supported pooler modes: `transaction`, `session`.
pool_mode = "transaction"
# How many server connections to allow per user/database pair.
default_pool_size = 20
# Maximum number of client connections allowed.
max_client_conn = 100

# [db.vault]
# secret_key = "env(SECRET_VALUE)"

[db.migrations]
# If disabled, migrations will be skipped during a db push or reset.
enabled = true
# Specifies an ordered list of schema files that describe your database.
# Supports glob patterns relative to supabase directory: "./schemas/*.sql"
schema_paths = []

[db.seed]
# If enabled, seeds the database after migrations during a db reset.
enabled = true
# Specifies an ordered list of seed files to load during db reset.
# Supports glob patterns relative to supabase directory: "./seeds/*.sql"
sql_paths = ["./seed.sql"]

[db.network_restrictions]
# Enable management of network restrictions.
enabled = false
# List of IPv4 CIDR blocks allowed to connect to the database.
# Defaults to allow all IPv4 connections. Set empty array to block all IPs.
allowed_cidrs = ["0.0.0.0/0"]
# List of IPv6 CIDR blocks allowed to connect to the database.
# Defaults to allow all IPv6 connections. Set empty array to block all IPs.
allowed_cidrs_v6 = ["::/0"]

[realtime]
enabled = true
# Bind realtime via either IPv4 or IPv6. (default: IPv4)
# ip_version = "IPv6"
# The maximum length in bytes of HTTP request headers. (default: 4096)
# max_header_length = 4096

[studio]
enabled = true
# Port to use for Supabase Studio.
port = 54323
# External URL of the API server that frontend connects to.
api_url = "http://127.0.0.1"
# OpenAI API Key to use for Supabase AI in the Supabase Studio.
openai_api_key = "env(OPENAI_API_KEY)"

# Email testing server. Emails sent with the local dev setup are not actually sent - rather, they
# are monitored, and you can view the emails that would have been sent from the web interface.
[inbucket]
enabled = true
# Port to use for the email testing server web interface.
port = 54324
# Uncomment to expose additional ports for testing user applications that send emails.
# smtp_port = 54325
# pop3_port = 54326
# admin_email = "admin@email.com"
# sender_name = "Admin"

[storage]
enabled = true
# The maximum file size allowed (e.g. "5MB", "500KB").
file_size_limit = "50MiB"

# Uncomment to configure local storage buckets
# [storage.buckets.images]
# public = false
# file_size_limit = "50MiB"
# allowed_mime_types = ["image/png", "image/jpeg"]
# objects_path = "./images"

# Allow connections via S3 compatible clients
[storage.s3_protocol]
enabled = true

# Image transformation API is available to Supabase Pro plan.
# [storage.image_transformation]
# enabled = true

# Store analytical data in S3 for running ETL jobs over Iceberg Catalog
# This feature is only available on the hosted platform.
[storage.analytics]
enabled = false
max_namespaces = 5
max_tables = 10
max_catalogs = 2

# Analytics Buckets is available to Supabase Pro plan.
# [storage.analytics.buckets.my-warehouse]

# Store vector embeddings in S3 for large and durable datasets
# This feature is only available on the hosted platform.
[storage.vector]
enabled = false
max_buckets = 10
max_indexes = 5

# Vector Buckets is available to Supabase Pro plan.
# [storage.vector.buckets.documents-openai]

[auth]
enabled = true
# The base URL of your website. Used as an allow-list for redirects and for constructing URLs used
# in emails.
site_url = "http://127.0.0.1:3000"
# A list of *exact* URLs that auth providers are permitted to redirect to post authentication.
additional_redirect_urls = ["https://127.0.0.1:3000"]
# How long tokens are valid for, in seconds. Defaults to 3600 (1 hour), maximum 604,800 (1 week).
jwt_expiry = 3600
# JWT issuer URL. If not set, defaults to the local API URL (http://127.0.0.1:<port>/auth/v1).
# jwt_issuer = ""
# Path to JWT signing key. DO NOT commit your signing keys file to git.
# signing_keys_path = "./signing_keys.json"
# If disabled, the refresh token will never expire.
enable_refresh_token_rotation = true
# Allows refresh tokens to be reused after expiry, up to the specified interval in seconds.
# Requires enable_refresh_token_rotation = true.
refresh_token_reuse_interval = 10
# Allow/disallow new user signups to your project.
enable_signup = true
# Allow/disallow anonymous sign-ins to your project.
enable_anonymous_sign_ins = false
# Allow/disallow testing manual linking of accounts
enable_manual_linking = false
# Passwords shorter than this value will be rejected as weak. Minimum 6, recommended 8 or more.
minimum_password_length = 6
# Passwords that do not meet the following requirements will be rejected as weak. Supported values
# are: `letters_digits`, `lower_upper_letters_digits`, `lower_upper_letters_digits_symbols`
password_requirements = ""

[auth.rate_limit]
# Number of emails that can be sent per hour. Requires auth.email.smtp to be enabled.
email_sent = 2
# Number of SMS messages that can be sent per hour. Requires auth.sms to be enabled.
sms_sent = 30
# Number of anonymous sign-ins that can be made per hour per IP address. Requires enable_anonymous_sign_ins = true.
anonymous_users = 30
# Number of sessions that can be refreshed in a 5 minute interval per IP address.
token_refresh = 150
# Number of sign up and sign-in requests that can be made in a 5 minute interval per IP address (excludes anonymous users).
sign_in_sign_ups = 30
# Number of OTP / Magic link verifications that can be made in a 5 minute interval per IP address.
token_verifications = 30
# Number of Web3 logins that can be made in a 5 minute interval per IP address.
web3 = 30

# Configure one of the supported captcha providers: `hcaptcha`, `turnstile`.
# [auth.captcha]
# enabled = true
# provider = "hcaptcha"
# secret = ""

[auth.email]
# Allow/disallow new user signups via email to your project.
enable_signup = true
# If enabled, a user will be required to confirm any email change on both the old, and new email
# addresses. If disabled, only the new email is required to confirm.
double_confirm_changes = true
# If enabled, users need to confirm their email address before signing in.
enable_confirmations = false
# If enabled, users will need to reauthenticate or have logged in recently to change their password.
secure_password_change = false
# Controls the minimum amount of time that must pass before sending another signup confirmation or password reset email.
max_frequency = "1s"
# Number of characters used in the email OTP.
otp_length = 6
# Number of seconds before the email OTP expires (defaults to 1 hour).
otp_expiry = 3600

# Use a production-ready SMTP server
# [auth.email.smtp]
# enabled = true
# host = "smtp.sendgrid.net"
# port = 587
# user = "apikey"
# pass = "env(SENDGRID_API_KEY)"
# admin_email = "admin@email.com"
# sender_name = "Admin"

# Uncomment to customize email template
# [auth.email.template.invite]
# subject = "You have been invited"
# content_path = "./supabase/templates/invite.html"

# Uncomment to customize notification email template
# [auth.email.notification.password_changed]
# enabled = true
# subject = "Your password has been changed"
# content_path = "./templates/password_changed_notification.html"

[auth.sms]
# Allow/disallow new user signups via SMS to your project.
enable_signup = false
# If enabled, users need to confirm their phone number before signing in.
enable_confirmations = false
# Template for sending OTP to users
template = "Your code is {{ .Code }}"
# Controls the minimum amount of time that must pass before sending another sms otp.
max_frequency = "5s"

# Use pre-defined map of phone number to OTP for testing.
# [auth.sms.test_otp]
# 4152127777 = "123456"

# Configure logged in session timeouts.
# [auth.sessions]
# Force log out after the specified duration.
# timebox = "24h"
# Force log out if the user has been inactive longer than the specified duration.
# inactivity_timeout = "8h"

# This hook runs before a new user is created and allows developers to reject the request based on the incoming user object.
# [auth.hook.before_user_created]
# enabled = true
# uri = "pg-functions://postgres/auth/before-user-created-hook"

# This hook runs before a token is issued and allows you to add additional claims based on the authentication method used.
# [auth.hook.custom_access_token]
# enabled = true
# uri = "pg-functions://<database>/<schema>/<hook_name>"

# Configure one of the supported SMS providers: `twilio`, `twilio_verify`, `messagebird`, `textlocal`, `vonage`.
[auth.sms.twilio]
enabled = false
account_sid = ""
message_service_sid = ""
# DO NOT commit your Twilio auth token to git. Use environment variable substitution instead:
auth_token = "env(SUPABASE_AUTH_SMS_TWILIO_AUTH_TOKEN)"

# Multi-factor-authentication is available to Supabase Pro plan.
[auth.mfa]
# Control how many MFA factors can be enrolled at once per user.
max_enrolled_factors = 10

# Control MFA via App Authenticator (TOTP)
[auth.mfa.totp]
enroll_enabled = false
verify_enabled = false

# Configure MFA via Phone Messaging
[auth.mfa.phone]
enroll_enabled = false
verify_enabled = false
otp_length = 6
template = "Your code is {{ .Code }}"
max_frequency = "5s"

# Configure MFA via WebAuthn
# [auth.mfa.web_authn]
# enroll_enabled = true
# verify_enabled = true

# Use an external OAuth provider. The full list of providers are: `apple`, `azure`, `bitbucket`,
# `discord`, `facebook`, `github`, `gitlab`, `google`, `keycloak`, `linkedin_oidc`, `notion`, `twitch`,
# `twitter`, `x`, `slack`, `spotify`, `workos`, `zoom`.
[auth.external.apple]
enabled = false
client_id = ""
# DO NOT commit your OAuth provider secret to git. Use environment variable substitution instead:
secret = "env(SUPABASE_AUTH_EXTERNAL_APPLE_SECRET)"
# Overrides the default auth redirectUrl.
redirect_uri = ""
# Overrides the default auth provider URL. Used to support self-hosted gitlab, single-tenant Azure,
# or any other third-party OIDC providers.
url = ""
# If enabled, the nonce check will be skipped. Required for local sign in with Google auth.
skip_nonce_check = false
# If enabled, it will allow the user to successfully authenticate when the provider does not return an email address.
email_optional = false

# Allow Solana wallet holders to sign in to your project via the Sign in with Solana (SIWS, EIP-4361) standard.
# You can configure "web3" rate limit in the [auth.rate_limit] section and set up [auth.captcha] if self-hosting.
[auth.web3.solana]
enabled = false

# Use Firebase Auth as a third-party provider alongside Supabase Auth.
[auth.third_party.firebase]
enabled = false
# project_id = "my-firebase-project"

# Use Auth0 as a third-party provider alongside Supabase Auth.
[auth.third_party.auth0]
enabled = false
# tenant = "my-auth0-tenant"
# tenant_region = "us"

# Use AWS Cognito (Amplify) as a third-party provider alongside Supabase Auth.
[auth.third_party.aws_cognito]
enabled = false
# user_pool_id = "my-user-pool-id"
# user_pool_region = "us-east-1"

# Use Clerk as a third-party provider alongside Supabase Auth.
[auth.third_party.clerk]
enabled = false
# Obtain from https://clerk.com/setup/supabase
# domain = "example.clerk.accounts.dev"

# OAuth server configuration
[auth.oauth_server]
# Enable OAuth server functionality
enabled = false
# Path for OAuth consent flow UI
authorization_url_path = "/oauth/consent"
# Allow dynamic client registration
allow_dynamic_registration = false

[edge_runtime]
enabled = true
# Supported request policies: `oneshot`, `per_worker`.
# `per_worker` (default) ‚Äî enables hot reload during local development.
# `oneshot` ‚Äî fallback mode if hot reload causes issues (e.g. in large repos or with symlinks).
policy = "per_worker"
# Port to attach the Chrome inspector for debugging edge functions.
inspector_port = 8083
# The Deno major version to use.
deno_version = 2

# [edge_runtime.secrets]
# secret_key = "env(SECRET_VALUE)"

[analytics]
enabled = true
port = 54327
# Configure one of the supported backends: `postgres`, `bigquery`.
backend = "postgres"

# Experimental features may be deprecated any time
[experimental]
# Configures Postgres storage engine to use OrioleDB (S3)
orioledb_version = ""
# Configures S3 bucket URL, eg. <bucket_name>.s3-<region>.amazonaws.com
s3_host = "env(S3_HOST)"
# Configures S3 bucket region, eg. us-east-1
s3_region = "env(S3_REGION)"
# Configures AWS_ACCESS_KEY_ID for S3 bucket
s3_access_key = "env(S3_ACCESS_KEY)"
# Configures AWS_SECRET_ACCESS_KEY for S3 bucket
s3_secret_key = "env(S3_SECRET_KEY)"
</file>

<file path="supabase/migrations/20240127000000_remote_schema.sql">
-- ==========================================
-- 1. –°–ò–°–¢–ï–ú–ê –õ–Ü–ú–Ü–¢–Ü–í (RATE LIMITING)
-- ==========================================
CREATE TABLE IF NOT EXISTS public.upload_audit (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_upload_audit_user_created ON public.upload_audit(user_id, created_at);

CREATE OR REPLACE FUNCTION public.check_upload_rate_limit()
RETURNS TRIGGER AS $$
DECLARE
    upload_count INT;
BEGIN
    SELECT COUNT(*) INTO upload_count
    FROM public.upload_audit
    WHERE user_id = auth.uid()
    AND created_at > now() - interval '60 seconds';

    IF upload_count >= 10 THEN
        RAISE EXCEPTION 'Rate limit exceeded: You can only upload 10 files per minute.';
    END IF;

    INSERT INTO public.upload_audit (user_id) VALUES (auth.uid());
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- –ü—Ä–∏–≤'—è–∑–∫–∞ –ª—ñ–º—ñ—Ç—É –¥–æ —Å—Ö–æ–≤–∏—â–∞
DROP TRIGGER IF EXISTS tr_check_upload_rate_limit ON storage.objects;
CREATE TRIGGER tr_check_upload_rate_limit
BEFORE INSERT ON storage.objects
FOR EACH ROW EXECUTE FUNCTION public.check_upload_rate_limit();


-- ==========================================
-- 2. –£–í–Ü–ú–ö–ù–ï–ù–ù–Ø RLS (Row Level Security)
-- ==========================================
-- –í–∞–∂–ª–∏–≤–æ: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–∞–∑–≤–∏ —Ç–∞–±–ª–∏—Ü—å –∑ —Ç–≤–æ—î—ó Drizzle —Å—Ö–µ–º–∏
ALTER TABLE public.user ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.chats ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.messages ENABLE ROW LEVEL SECURITY;


-- ==========================================
-- 3. –ü–û–õ–Ü–¢–ò–ö–ò –î–õ–Ø –ö–û–†–ò–°–¢–£–í–ê–ß–Ü–í (–¢–∞–±–ª–∏—Ü—è "user")
-- ==========================================
DROP POLICY IF EXISTS "Profiles are viewable by everyone" ON public.user;
CREATE POLICY "Profiles are viewable by everyone" ON public.user
FOR SELECT USING (true);

DROP POLICY IF EXISTS "Users can update own profile" ON public.user;
CREATE POLICY "Users can update own profile" ON public.user
FOR UPDATE USING (auth.uid()::text = id);


-- ==========================================
-- 4. –ü–û–õ–Ü–¢–ò–ö–ò –î–õ–Ø –ß–ê–¢–Ü–í (chats)
-- ==========================================
DROP POLICY IF EXISTS "Users can view their chats" ON public.chats;
CREATE POLICY "Users can view their chats" ON public.chats
FOR SELECT USING (
    user_id = auth.uid()::text OR recipient_id = auth.uid()::text
);

DROP POLICY IF EXISTS "Users can create chats" ON public.chats;
CREATE POLICY "Users can create chats" ON public.chats
FOR INSERT WITH CHECK (
    user_id = auth.uid()::text
);


-- ==========================================
-- 5. –ü–û–õ–Ü–¢–ò–ö–ò –î–õ–Ø –ü–û–í–Ü–î–û–ú–õ–ï–ù–¨ (messages)
-- ==========================================
DROP POLICY IF EXISTS "Users can view messages in their chats" ON public.messages;
CREATE POLICY "Users can view messages in their chats" ON public.messages
FOR SELECT USING (
    EXISTS (
        SELECT 1 FROM public.chats c
        WHERE c.id = messages.chat_id
        AND (c.user_id = auth.uid()::text OR c.recipient_id = auth.uid()::text)
    )
);

DROP POLICY IF EXISTS "Users can insert messages in their chats" ON public.messages;
CREATE POLICY "Users can insert messages in their chats" ON public.messages
FOR INSERT WITH CHECK (
    sender_id = auth.uid()::text
    AND EXISTS (
        SELECT 1 FROM public.chats c
        WHERE c.id = messages.chat_id
        AND (c.user_id = auth.uid()::text OR c.recipient_id = auth.uid()::text)
    )
);


-- ==========================================
-- 6. –ü–û–õ–Ü–¢–ò–ö–ò –î–õ–Ø –°–•–û–í–ò–©–ê (storage)
-- ==========================================
-- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–∞–∫–µ—Ç–∞, —è–∫—â–æ –≤—ñ–Ω –Ω–µ —ñ—Å–Ω—É—î
INSERT INTO storage.buckets (id, name, public) 
VALUES ('attachments', 'attachments', true)
ON CONFLICT (id) DO NOTHING;

-- –î–æ—Å—Ç—É–ø –Ω–∞ —á–∏—Ç–∞–Ω–Ω—è —É—á–∞—Å–Ω–∏–∫–∞–º —á–∞—Ç—É
-- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ foldername(name)[1] —è–∫ chat_id
CREATE POLICY "Participants can view chat attachments"
ON storage.objects FOR SELECT USING (
    bucket_id = 'attachments'
    AND EXISTS (
        SELECT 1 FROM public.chats c
        WHERE c.id = (storage.foldername(name))[1]
        AND (c.user_id = auth.uid()::text OR c.recipient_id = auth.uid()::text)
    )
);

-- –î–æ—Å—Ç—É–ø –Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
CREATE POLICY "Participants can upload chat attachments"
ON storage.objects FOR INSERT WITH CHECK (
    bucket_id = 'attachments'
    AND auth.role() = 'authenticated'
    AND EXISTS (
        SELECT 1 FROM public.chats c
        WHERE c.id = (storage.foldername(name))[1]
        AND (c.user_id = auth.uid()::text OR c.recipient_id = auth.uid()::text)
    )
);

-- –í–∏–¥–∞–ª–µ–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ –≤–ª–∞—Å–Ω–∏–∫–æ–º (–∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á–µ–º)
CREATE POLICY "Users can delete own chat attachments"
ON storage.objects FOR DELETE USING (
    bucket_id = 'attachments'
    AND owner = auth.uid()
);
</file>

<file path="supabase/migrations/20260128000000_realtime_setup.sql">
-- Enable REPLICA IDENTITY FULL for the tables to provide full row data in payloads
ALTER TABLE public.user REPLICA IDENTITY FULL;
ALTER TABLE public.chats REPLICA IDENTITY FULL;
ALTER TABLE public.messages REPLICA IDENTITY FULL;

-- Ensure the supabase_realtime publication includes these tables
-- This allows Supabase to broadcast changes for these tables via WebSockets
DO $$ 
BEGIN
    -- Check if the publication exists
    IF EXISTS (SELECT 1 FROM pg_publication WHERE pubname = 'supabase_realtime') THEN
        -- Add tables to existing publication. 
        -- We use a sub-DO block to handle "already exists" errors for each table.
        BEGIN
            ALTER PUBLICATION supabase_realtime ADD TABLE public.user;
        EXCEPTION WHEN duplicate_object THEN
            NULL;
        END;
        
        BEGIN
            ALTER PUBLICATION supabase_realtime ADD TABLE public.chats;
        EXCEPTION WHEN duplicate_object THEN
            NULL;
        END;
        
        BEGIN
            ALTER PUBLICATION supabase_realtime ADD TABLE public.messages;
        EXCEPTION WHEN duplicate_object THEN
            NULL;
        END;
    ELSE
        -- Create publication and add tables
        CREATE PUBLICATION supabase_realtime FOR TABLE public.user, public.chats, public.messages;
    END IF;
END $$;
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path="drizzle.config.ts">
import * as dotenv from 'dotenv'; 
import { defineConfig } from 'drizzle-kit';


dotenv.config({
  path: '.env.local',
});
console.log("--- DEBUG: –ß–∏ –∑–Ω–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª? ---", process.env.DATABASE_URL ? "–¢–ê–ö" : "–ù–Ü");

const dbUrl = process.env.DATABASE_URL;

if (!dbUrl) {
  throw new Error('DATABASE_URL is missing in .env.local');
}

export default defineConfig({
  schema: './src/db/schema.ts',
  out: './drizzle',
  dialect: 'postgresql',
  dbCredentials: {
    url: dbUrl,
  },
});
</file>

<file path="drizzle/meta/0000_snapshot.json">
{
  "id": "fc0e4edc-3072-4f7e-adc9-72ce80ddddcf",
  "prevId": "00000000-0000-0000-0000-000000000000",
  "version": "7",
  "dialect": "postgresql",
  "tables": {
    "public.chats": {
      "name": "chats",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "text",
          "primaryKey": true,
          "notNull": true
        },
        "user_id": {
          "name": "user_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "recipient_id": {
          "name": "recipient_id",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "title": {
          "name": "title",
          "type": "text",
          "primaryKey": false,
          "notNull": true,
          "default": "'New Chat'"
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "chats_user_id_user_id_fk": {
          "name": "chats_user_id_user_id_fk",
          "tableFrom": "chats",
          "tableTo": "user",
          "columnsFrom": [
            "user_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "cascade",
          "onUpdate": "no action"
        },
        "chats_recipient_id_user_id_fk": {
          "name": "chats_recipient_id_user_id_fk",
          "tableFrom": "chats",
          "tableTo": "user",
          "columnsFrom": [
            "recipient_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "cascade",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.messages": {
      "name": "messages",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "text",
          "primaryKey": true,
          "notNull": true
        },
        "chat_id": {
          "name": "chat_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "sender_id": {
          "name": "sender_id",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "content": {
          "name": "content",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "attachments": {
          "name": "attachments",
          "type": "jsonb",
          "primaryKey": false,
          "notNull": true,
          "default": "'[]'::jsonb"
        },
        "reply_to_id": {
          "name": "reply_to_id",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "is_read": {
          "name": "is_read",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "messages_chat_id_chats_id_fk": {
          "name": "messages_chat_id_chats_id_fk",
          "tableFrom": "messages",
          "tableTo": "chats",
          "columnsFrom": [
            "chat_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "cascade",
          "onUpdate": "no action"
        },
        "messages_sender_id_user_id_fk": {
          "name": "messages_sender_id_user_id_fk",
          "tableFrom": "messages",
          "tableTo": "user",
          "columnsFrom": [
            "sender_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "cascade",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.user": {
      "name": "user",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "text",
          "primaryKey": true,
          "notNull": true
        },
        "name": {
          "name": "name",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "email": {
          "name": "email",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "emailVerified": {
          "name": "emailVerified",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": false
        },
        "image": {
          "name": "image",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "last_seen": {
          "name": "last_seen",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": false,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {},
      "compositePrimaryKeys": {},
      "uniqueConstraints": {
        "user_email_unique": {
          "name": "user_email_unique",
          "nullsNotDistinct": false,
          "columns": [
            "email"
          ]
        }
      },
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    }
  },
  "enums": {},
  "schemas": {},
  "sequences": {},
  "roles": {},
  "policies": {},
  "views": {},
  "_meta": {
    "columns": {},
    "schemas": {},
    "tables": {}
  }
}
</file>

<file path="README.md">
# üöÄ Trace Project Template
# üöÄ Trace Project Template

–°—Ç–∞–±—ñ–ª—å–Ω–∏–π, –≤–∏—Å–æ–∫–æ–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–∏–π —à–∞–±–ª–æ–Ω –¥–ª—è —Å—É—á–∞—Å–Ω–∏—Ö –≤–µ–±-–¥–æ–¥–∞—Ç–∫—ñ–≤ –Ω–∞ –±–∞–∑—ñ **Next.js 15** —Ç–∞ **React 19**. –ü–æ–±—É–¥–æ–≤–∞–Ω–∏–π –∑ –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ "–∑–∞–ª—ñ–∑–æ–±–µ—Ç–æ–Ω–Ω—É" –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É, —à–≤–∏–¥–∫—ñ—Å—Ç—å —Ä–æ–∑—Ä–æ–±–∫–∏ (DX) —Ç–∞ –ø–æ–≤–Ω—É —ñ–∑–æ–ª—è—Ü—ñ—é —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞.

## üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—á–Ω–∏–π —Å—Ç–µ–∫
- **Framework:** Next.js 15 (App Router)
- **Runtime:** React 19 (–∑ —É–≤—ñ–º–∫–Ω–µ–Ω–∏–º **React Compiler**)
- **Language:** TypeScript (Strict mode)
- **Package Manager:** PNPM (Strict & Deterministic)
- **Linter/Formatter:** Biome (Rust-based speed) + Next Lint
- **Containerization:** Docker (Alpine Linux)
- **Backend:** Supabase (PostgreSQL + Realtime)

## üèó –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω—ñ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ

### 1. –Ü–∑–æ–ª—è—Ü—ñ—è —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ (Docker)
–î–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è **Cross-Platform Stability** –ø—Ä–æ–µ–∫—Ç –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –≤ Docker. –¶–µ –≥–∞—Ä–∞–Ω—Ç—É—î —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ—Å—Ç—å –≤–µ—Ä—Å—ñ–π Node.js —Ç–∞ PNPM –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –û–° —Ö–æ—Å—Ç–∞, –∑–∞–ø–æ–±—ñ–≥–∞—é—á–∏ –ø–æ–º–∏–ª–∫–∞–º —Ñ–∞–π–ª–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏ Windows.

* **–ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç—É:** ```bash
  docker-compose up -d --build

* **–ó—É–ø–∏–Ω–∫–∞ –ø—Ä–æ–µ–∫—Ç—É:** ```bash
  docker-compose down

* **–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π:** ```bash
  docker exec -it trace-app pnpm install

### 2. –°—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å –ø–∞–∫–µ—Ç—ñ–≤ (Strict PNPM)
–ü—Ä–æ–µ–∫—Ç –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π —á–µ—Ä–µ–∑ `.npmrc` –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è "—Ñ–∞–Ω—Ç–æ–º–Ω–∏–º –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—è–º":
- `shamefully-hoist=false`: –ó–∞–±–æ—Ä–æ–Ω—è—î —ñ–º–ø–æ—Ä—Ç –±—ñ–±–ª—ñ–æ—Ç–µ–∫, —è–∫—ñ –Ω–µ –ø—Ä–æ–ø–∏—Å–∞–Ω—ñ –≤ `package.json`.
- `strict-peer-dependencies=true`: –ë–ª–æ–∫—É—î –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∞—Ö –≤–µ—Ä—Å—ñ–π.
- `engine-strict=true`: –ì–∞—Ä–∞–Ω—Ç—É—î —Ä–æ–±–æ—Ç—É –ª–∏—à–µ –Ω–∞ —Å—É–º—ñ—Å–Ω–∏—Ö –≤–µ—Ä—Å—ñ—è—Ö Node.js (>=20).
- `frozen-lockfile=true`: –ó–∞–±–µ–∑–ø–µ—á—É—î –¥–µ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω—ñ—Å—Ç—å ‚Äî —ñ–Ω—Å—Ç–∞–ª—è—Ü—ñ—è –ø–∞–∫–µ—Ç—ñ–≤ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —Å—Ç—Ä–æ–≥–æ –∑–∞ –ª–æ–∫-—Ñ–∞–π–ª–æ–º –±–µ–∑ –π–æ–≥–æ –≤–∏–ø–∞–¥–∫–æ–≤–æ—ó –∑–º—ñ–Ω–∏.

### 3. React Compiler
–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–∞ —Ñ—ñ—á–∞ `reactCompiler: true`. –ë—ñ–ª—å—à–µ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—Ä—É—á–Ω—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `useMemo` —Ç–∞ `useCallback`. –ö–æ–º–ø—ñ–ª—è—Ç–æ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–ø—Ç–∏–º—ñ–∑—É—î —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤.

### 4. –ü–æ–¥–≤—ñ–π–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å —è–∫–æ—Å—Ç—ñ
–ú–∏ –æ–±'—î–¥–Ω–∞–ª–∏ **Biome** (—à–≤–∏–¥–∫—ñ—Å—Ç—å) —Ç–∞ **Next Lint** (–≥–ª–∏–±–∏–Ω–∞):
- Biome –º–∏—Ç—Ç—î–≤–æ –≤–∏–ø—Ä–∞–≤–ª—è—î —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –±–∞–∑–æ–≤—ñ –ø–æ–º–∏–ª–∫–∏.
- Next Lint –ø–µ—Ä–µ–≤—ñ—Ä—è—î —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫—É –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ—î–º.

## üöÄ –ö–æ–º–∞–Ω–¥–∏ —Ä–æ–∑—Ä–æ–±–∫–∏

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å |
| :--- | :--- |
| `pnpm setup` | **–ë–µ–∑–ø–µ—á–Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è.** –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `--frozen-lockfile`, –≥–∞—Ä–∞–Ω—Ç—É—é—á–∏ —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ—Å—Ç—å –≤–µ—Ä—Å—ñ–π. |
| `pnpm dev` | –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ —Ä–æ–∑—Ä–æ–±–∫–∏ –∑ –¥–≤–∏–≥—É–Ω–æ–º **Turbopack** (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å). |
| `pnpm format` | –®–≤–∏–¥–∫–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è —Å—Ç–∏–ª—é –∫–æ–¥—É —á–µ—Ä–µ–∑ Biome. |
| `pnpm check` | **–ü–æ–≤–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞:** Biome + Next Lint. –í–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –ø–µ—Ä–µ–¥ –∫–æ–∂–Ω–∏–º commit-–æ–º. |
| `pnpm build` | –ó–±—ñ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç—É –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω—É. |
| `pnpm add-pkg` | –ê–ª—ñ–∞—Å –¥–ª—è `pnpm add`. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π. |

## ‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –æ—Ç–æ—á–µ–Ω–Ω—è

–°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `.env.local` —É –∫–æ—Ä–µ–Ω—ñ –ø—Ä–æ–µ–∫—Ç—É:

```ini
NEXT_PUBLIC_SUPABASE_URL=your_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key


## üîê –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó (Google OAuth)

–î–ª—è —Ä–æ–±–æ—Ç–∏ –≤—Ö–æ–¥—É —á–µ—Ä–µ–∑ Google –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –ø—Ä–æ–µ–∫—Ç —É [Google Cloud Console](https://console.cloud.google.com/).

### 1. Google Cloud Platform
- –°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π –ø—Ä–æ–µ–∫—Ç –∑ –Ω–∞–∑–≤–æ—é **Trace**.
- –ü–µ—Ä–µ–π–¥—ñ—Ç—å —É **APIs & Services > OAuth consent screen**:
  - –¢–∏–ø: **External**.
  - –î–æ–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–æ—à—Ç—É –≤ **Test Users** (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ –¥–ª—è —Ä–µ–∂–∏–º—É —Ä–æ–∑—Ä–æ–±–∫–∏).
- –ü–µ—Ä–µ–π–¥—ñ—Ç—å —É **Credentials**:
  - –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å **Create Credentials > OAuth client ID**.
  - –¢–∏–ø –¥–æ–¥–∞—Ç–∫—É: **Web application**.
  - Authorized redirect URIs: `http://localhost:3000/api/auth/callback/google`

### 2. –ó–º—ñ–Ω–Ω—ñ –æ—Ç–æ—á–µ–Ω–Ω—è (.env.local)
–°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `.env.local` —É –∫–æ—Ä–µ–Ω—ñ –ø—Ä–æ–µ–∫—Ç—É —Ç–∞ –¥–æ–¥–∞–π—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω—ñ –∫–ª—é—á—ñ:

```env
# Google OAuth Keys
AUTH_GOOGLE_ID=–≤–∞—à_client_id_–∑_google_console
AUTH_GOOGLE_SECRET=–≤–∞—à_client_secret_–∑_google_console

# Auth.js Config
# –ó–≥–µ–Ω–µ—Ä—É–π—Ç–µ —Å–µ–∫—Ä–µ—Ç –∫–æ–º–∞–Ω–¥–æ—é: npx auth secret
AUTH_SECRET=–≤–∞—à_–∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π_—Å–µ–∫—Ä–µ—Ç
NEXTAUTH_URL=http://localhost:3000
```
</file>

<file path="src/app/auth/callback/route.ts">
import { NextResponse } from 'next/server';
// The client you created from the Server-Side Auth instructions
import { createClient } from '@/lib/supabase/server';

export async function GET(request: Request) {
  const { searchParams, origin } = new URL(request.url);
  const code = searchParams.get('code');
  // if "next" is in search params, use it as the redirection URL after successful exchange
  const next = searchParams.get('next') ?? '/chat';

  if (code) {
    const supabase = await createClient();
    const { error } = await supabase.auth.exchangeCodeForSession(code);
    if (!error) {
      const forwardedHost = request.headers.get('x-forwarded-host'); // if available, use this for redirect
      const isLocalEnv = process.env.NODE_ENV === 'development';
      if (isLocalEnv) {
        // we can be sure that origin is http://localhost:3000
        return NextResponse.redirect(`${origin}${next}`);
      } else if (forwardedHost) {
        return NextResponse.redirect(`https://${forwardedHost}${next}`);
      } else {
        return NextResponse.redirect(`${origin}${next}`);
      }
    }
  }

  // return the user to an error page with instructions
  return NextResponse.redirect(`${origin}/auth/auth-code-error`);
}
</file>

<file path="src/components/sidebar/ContactItem.tsx">
'use client';

import { Loader2, MessageSquarePlus, User as UserIcon } from 'lucide-react';
import Image from 'next/image';
import { useTransition } from 'react';
import { getOrCreateChatAction } from '@/actions/chat-actions';
import { formatRelativeTime } from '@/lib/date-utils';
import type { User } from '@/types';
import { cn } from '@/lib/utils';

import { PresenceIndicator } from './PresenceIndicator';

interface ContactItemProps {
  user: User;
  disabled: boolean;
  onActionStart?: (id: string) => void;
  onActionEnd?: () => void;
}

export function ContactItem({ 
  user, 
  disabled,
  onActionStart,
  onActionEnd 
}: ContactItemProps) {
  const [isPending, startTransition] = useTransition();

  const handleStartChat = () => {
    if (disabled || isPending) return;
    
    onActionStart?.(user.id);
    startTransition(async () => {
      try {
        await getOrCreateChatAction(user.id);
      } finally {
        onActionEnd?.();
      }
    });
  };

  return (
    <div
      className={cn(
        "flex items-center gap-3 px-3 py-3 rounded-xl transition-all border border-transparent group",
        isPending ? "bg-white/10" : "hover:bg-white/5 hover:border-white/5"
      )}
    >
      <div className="relative w-10 h-10 rounded-full shrink-0">
        <div className="w-full h-full rounded-full overflow-hidden border border-white/10 bg-white/5 relative">
          {user.image ? (
            <Image 
              src={user.image} 
              alt={user.name || 'User'} 
              fill 
              className="object-cover" 
              sizes="40px"
            />
          ) : (
            <div className="w-full h-full flex items-center justify-center">
              <UserIcon className="w-5 h-5 text-gray-500" />
            </div>
          )}
        </div>
        <PresenceIndicator 
          userId={user.id} 
          className="absolute bottom-0 right-0 w-3 h-3" 
        />
      </div>
      
      <div className="flex-1 min-w-0">
        <p className="text-sm font-medium text-gray-200 truncate group-hover:text-white transition-colors">
          {user.name || 'Anonymous'}
        </p>
        <div className="flex items-center gap-2">
          <p className="text-[10px] text-gray-500 truncate lowercase">
            {user.email}
          </p>
          <PresenceIndicator 
             userId={user.id} 
             showOffline={false}
             className="hidden" 
          /> 
           {user.lastSeen && (
            <>
              <span className="text-[10px] text-gray-600">‚Ä¢</span>
              <p className="text-[10px] text-gray-500">
                {formatRelativeTime(user.lastSeen)}
              </p>
            </>
          )}
        </div>
      </div>

      <button
        type="button"
        disabled={disabled || isPending}
        onClick={handleStartChat}
        className={cn(
          "p-2 rounded-lg transition-all shrink-0",
          isPending 
            ? "bg-white text-black" 
            : "bg-white/5 text-gray-400 hover:bg-white hover:text-black lg:opacity-0 lg:group-hover:opacity-100",
          (disabled && !isPending) && "opacity-50 cursor-not-allowed pointer-events-none"
        )}
        title="Send Message"
      >
        {isPending ? (
          <Loader2 className="w-4 h-4 animate-spin" />
        ) : (
          <MessageSquarePlus className="w-4 h-4" />
        )}
      </button>
    </div>
  );
}
</file>

<file path="src/components/sidebar/SearchInput.tsx">
'use client';

import { Search } from 'lucide-react';
import { useRouter, useSearchParams } from 'next/navigation';
import { useEffect, useState } from 'react';

export default function SearchInput() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [query, setQuery] = useState(searchParams.get('q') || '');

  useEffect(() => {
    const timer = setTimeout(() => {
      const params = new URLSearchParams(searchParams.toString());
      const currentQuery = params.get('q') || '';

      if (query === currentQuery) return;

      if (query) {
        params.set('q', query);
      } else {
        params.delete('q');
      }
      router.push(`?${params.toString()}`, { scroll: false });
    }, 300);

    return () => clearTimeout(timer);
  }, [query, router, searchParams]);

  return (
    <div className="relative group px-4">
      <div className="absolute left-7 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-white transition-colors duration-300">
        <Search className="w-4 h-4" />
      </div>
      <input
        type="text"
        value={query}
        onChange={(e) => setQuery(e.target.value)}
        placeholder="–ü–æ—à—É–∫ –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤..."
        className="w-full bg-white/5 border border-white/5 rounded-xl py-2 pl-10 pr-4 text-sm focus:outline-none focus:ring-1 focus:ring-white/20 transition-all duration-300 placeholder:text-gray-500"
      />
    </div>
  );
}
</file>

<file path="src/components/ui/dropdown-menu.tsx">
'use client';

import * as DropdownMenuPrimitive from '@radix-ui/react-dropdown-menu';
import * as React from 'react';
import { cn } from '@/lib/utils';

const DropdownMenu = DropdownMenuPrimitive.Root;
const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger;
const DropdownMenuGroup = DropdownMenuPrimitive.Group;
const DropdownMenuPortal = DropdownMenuPrimitive.Portal;

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        'z-50 min-w-[10rem] overflow-hidden rounded-2xl border border-white/10 bg-neutral-950/90 p-1.5 text-white shadow-2xl backdrop-blur-xl animate-in fade-in-80 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95',
        className,
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
));
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName;

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & { inset?: boolean }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      'relative flex cursor-pointer select-none items-center rounded-xl px-3 py-2.5 text-sm outline-none transition-colors focus:bg-white/10 focus:text-white data-[disabled]:pointer-events-none data-[disabled]:opacity-50',
      inset && 'pl-8',
      className,
    )}
    {...props}
  />
));
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName;

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn('-mx-1 my-1 h-px bg-white/5', className)}
    {...props}
  />
));
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName;

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuGroup,
  DropdownMenuPortal,
};
</file>

<file path="src/components/ui/Logo.tsx">
import Link from 'next/link';

export default function Logo() {
  return (
    <Link href="/" className="hover:opacity-80 transition-opacity">
      <h1 className="text-xl font-black italic tracking-tighter text-white uppercase">
        Trace<span className="text-gray-500">.</span>
      </h1>
    </Link>
  );
}
</file>

<file path="src/db/index.ts">
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import * as schema from './schema';

if (!process.env.DATABASE_URL) {
  throw new Error('DATABASE_URL is not defined');
}

const client = postgres(process.env.DATABASE_URL);
export const db = drizzle(client, { schema });
</file>

<file path="src/lib/supabase/middleware.ts">
import { createServerClient } from '@supabase/ssr';
import { type NextRequest, NextResponse } from 'next/server';

export async function updateSession(request: NextRequest) {
  let supabaseResponse = NextResponse.next({
    request,
  });

  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL ?? '';
  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ?? '';

  const supabase = createServerClient(supabaseUrl, supabaseAnonKey, {
    cookies: {
      getAll() {
        return request.cookies.getAll();
      },
      setAll(cookiesToSet) {
        for (const { name, value } of cookiesToSet) {
          request.cookies.set(name, value);
        }
        supabaseResponse = NextResponse.next({
          request,
        });
        for (const { name, value, options } of cookiesToSet) {
          supabaseResponse.cookies.set(name, value, options);
        }
      },
    },
  });

  // IMPORTANT: Avoid writing any logic between createServerClient and
  // supabase.auth.getUser(). A simple mistake can make it very hard to debug
  // issues with users being randomly logged out.

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (
    !user &&
    !request.nextUrl.pathname.startsWith('/login') &&
    !request.nextUrl.pathname.startsWith('/auth') &&
    request.nextUrl.pathname !== '/'
  ) {
    // no user, potentially respond by redirecting the user to the login page
    const url = request.nextUrl.clone();
    url.pathname = '/';
    return NextResponse.redirect(url);
  }

  // IMPORTANT: You *must* return the supabaseResponse object as is. If you're
  // creating a new response object with NextResponse.next() make sure to:
  // 1. Pass the request in it, like so:
  //    const myNewResponse = NextResponse.next({ request })
  // 2. Copy over the cookies, like so:
  //    myNewResponse.cookies.setAll(supabaseResponse.cookies.getAll())
  // 3. Change the myNewResponse object to fit your needs, but avoid changing
  //    the cookies!
  // 4. Return the myNewResponse object.

  return supabaseResponse;
}
</file>

<file path="src/lib/supabase/server.ts">
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

export async function createClient() {
  const cookieStore = await cookies();

  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL ?? '';
  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ?? '';

  return createServerClient(supabaseUrl, supabaseAnonKey, {
    cookies: {
      getAll() {
        return cookieStore.getAll();
      },
      setAll(cookiesToSet) {
        try {
          for (const { name, value, options } of cookiesToSet) {
            cookieStore.set(name, value, options);
          }
        } catch {
          // The `setAll` method was called from a Server Component.
          // This can be ignored if you have middleware refreshing
          // user sessions.
        }
      },
    },
  });
}
</file>

<file path="src/wdyr.ts">
'use client';

import React from 'react';

if (process.env.NODE_ENV === 'development') {
  if (typeof window !== 'undefined') {
    // eslint-disable-next-line @typescript-eslint/no-require-imports
    const whyDidYouRender = require('@welldone-software/why-did-you-render');
    whyDidYouRender(React, {
      trackAllPureComponents: true,
    });
  }
}
</file>

<file path="drizzle/meta/0001_snapshot.json">
{
  "id": "46eb3859-3d1c-419a-a188-c696281b04fd",
  "prevId": "fc0e4edc-3072-4f7e-adc9-72ce80ddddcf",
  "version": "7",
  "dialect": "postgresql",
  "tables": {
    "public.chats": {
      "name": "chats",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "user_id": {
          "name": "user_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "recipient_id": {
          "name": "recipient_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "user_last_read_id": {
          "name": "user_last_read_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "recipient_last_read_id": {
          "name": "recipient_last_read_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "title": {
          "name": "title",
          "type": "text",
          "primaryKey": false,
          "notNull": true,
          "default": "'New Chat'"
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {
        "idx_chats_users": {
          "name": "idx_chats_users",
          "columns": [
            {
              "expression": "user_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            },
            {
              "expression": "recipient_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        }
      },
      "foreignKeys": {
        "chats_user_id_user_id_fk": {
          "name": "chats_user_id_user_id_fk",
          "tableFrom": "chats",
          "tableTo": "user",
          "columnsFrom": [
            "user_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "cascade",
          "onUpdate": "no action"
        },
        "chats_recipient_id_user_id_fk": {
          "name": "chats_recipient_id_user_id_fk",
          "tableFrom": "chats",
          "tableTo": "user",
          "columnsFrom": [
            "recipient_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "cascade",
          "onUpdate": "no action"
        },
        "chats_user_last_read_id_messages_id_fk": {
          "name": "chats_user_last_read_id_messages_id_fk",
          "tableFrom": "chats",
          "tableTo": "messages",
          "columnsFrom": [
            "user_last_read_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "set null",
          "onUpdate": "no action"
        },
        "chats_recipient_last_read_id_messages_id_fk": {
          "name": "chats_recipient_last_read_id_messages_id_fk",
          "tableFrom": "chats",
          "tableTo": "messages",
          "columnsFrom": [
            "recipient_last_read_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "set null",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.messages": {
      "name": "messages",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "chat_id": {
          "name": "chat_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "sender_id": {
          "name": "sender_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "content": {
          "name": "content",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "attachments": {
          "name": "attachments",
          "type": "jsonb",
          "primaryKey": false,
          "notNull": true,
          "default": "'[]'::jsonb"
        },
        "reply_to_id": {
          "name": "reply_to_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {
        "idx_messages_chat_created": {
          "name": "idx_messages_chat_created",
          "columns": [
            {
              "expression": "chat_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            },
            {
              "expression": "created_at",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        },
        "idx_messages_sender": {
          "name": "idx_messages_sender",
          "columns": [
            {
              "expression": "sender_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        }
      },
      "foreignKeys": {
        "messages_chat_id_chats_id_fk": {
          "name": "messages_chat_id_chats_id_fk",
          "tableFrom": "messages",
          "tableTo": "chats",
          "columnsFrom": [
            "chat_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "cascade",
          "onUpdate": "no action"
        },
        "messages_sender_id_user_id_fk": {
          "name": "messages_sender_id_user_id_fk",
          "tableFrom": "messages",
          "tableTo": "user",
          "columnsFrom": [
            "sender_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "cascade",
          "onUpdate": "no action"
        },
        "messages_reply_to_id_messages_id_fk": {
          "name": "messages_reply_to_id_messages_id_fk",
          "tableFrom": "messages",
          "tableTo": "messages",
          "columnsFrom": [
            "reply_to_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "set null",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.upload_audit": {
      "name": "upload_audit",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "user_id": {
          "name": "user_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {
        "idx_upload_audit_user_time": {
          "name": "idx_upload_audit_user_time",
          "columns": [
            {
              "expression": "user_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            },
            {
              "expression": "created_at",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        }
      },
      "foreignKeys": {
        "upload_audit_user_id_user_id_fk": {
          "name": "upload_audit_user_id_user_id_fk",
          "tableFrom": "upload_audit",
          "tableTo": "user",
          "columnsFrom": [
            "user_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.user": {
      "name": "user",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true
        },
        "name": {
          "name": "name",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "email": {
          "name": "email",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "emailVerified": {
          "name": "emailVerified",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": false
        },
        "image": {
          "name": "image",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "last_seen": {
          "name": "last_seen",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": false,
          "default": "now()"
        }
      },
      "indexes": {
        "idx_user_email": {
          "name": "idx_user_email",
          "columns": [
            {
              "expression": "email",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        }
      },
      "foreignKeys": {},
      "compositePrimaryKeys": {},
      "uniqueConstraints": {
        "user_email_unique": {
          "name": "user_email_unique",
          "nullsNotDistinct": false,
          "columns": [
            "email"
          ]
        }
      },
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    }
  },
  "enums": {},
  "schemas": {},
  "sequences": {},
  "roles": {},
  "policies": {},
  "views": {},
  "_meta": {
    "columns": {},
    "schemas": {},
    "tables": {}
  }
}
</file>

<file path="src/app/globals.css">
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #111111;

  /* Premium Design Tokens */
  --glass-bg: rgba(255, 255, 255, 0.03);
  --glass-border: rgba(255, 255, 255, 0.08);
  --glass-blur: 16px;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: "Inter", var(--font-geist-sans);
}

@media (prefers-color-scheme: dark) {
  :root {
    /* Pure Black for OLED & Deep Charcoal for depth */
    --background: #000000;
    --foreground: #f5f5f7;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;

  /* High-end typography rendering */
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
  letter-spacing: -0.015em;
}

/* Glassmorphism utility */
.glass-effect {
  background: var(--glass-bg);
  backdrop-filter: blur(var(--glass-blur));
  -webkit-backdrop-filter: blur(var(--glass-blur));
  border: 1px solid var(--glass-border);
}

/* Custom Premium Scrollbar */
::-webkit-scrollbar {
  width: 5px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 20px;
  transition: all 0.3s;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.2);
}
</file>

<file path="src/components/auth/auth-buttons.tsx">
'use client';

import { LogIn, LogOut } from 'lucide-react';
import { handleSignIn, handleSignOut } from '@/actions/auth';

export function SignInButton() {
  return (
    <button
      type="button"
      onClick={() => handleSignIn()}
      className="flex items-center gap-2 px-5 py-2 rounded-full bg-white text-black font-medium text-sm hover:bg-gray-200 transition-colors"
    >
      <LogIn className="w-4 h-4" />
      Log in
    </button>
  );
}

export function SignOutButton() {
  return (
    <button
      type="button"
      onClick={() => handleSignOut()}
      className="w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-white/5 flex items-center gap-2"
    >
      <LogOut className="w-4 h-4" />
      Logout
    </button>
  );
}
</file>

<file path="src/components/auth/AuthProvider.tsx">
import { SupabaseAuthProvider } from '../SupabaseAuthProvider';

export default function AuthProvider({ children }: { children: React.ReactNode }) {
  return <SupabaseAuthProvider>{children}</SupabaseAuthProvider>;
}
</file>

<file path="src/components/ui/alert-dialog.tsx">
'use client';

import * as AlertDialogPrimitive from '@radix-ui/react-alert-dialog';
import * as React from 'react';
import { buttonVariants } from '@/components/ui/button';
import { cn } from '@/lib/utils';

const AlertDialog = AlertDialogPrimitive.Root;

const AlertDialogTrigger = AlertDialogPrimitive.Trigger;

const AlertDialogPortal = AlertDialogPrimitive.Portal;

const AlertDialogOverlay = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Overlay
    className={cn(
      // –ü–Ü–î–ù–Ø–¢–û Z-INDEX –¢–ê –î–û–î–ê–ù–û BLUR
      'fixed inset-0 z-[998] bg-black/80 backdrop-blur-sm data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0',
      className,
    )}
    {...props}
    ref={ref}
  />
));
AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName;

const AlertDialogContent = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
>(({ className, ...props }, ref) => (
  <AlertDialogPortal>
    <AlertDialogOverlay />
    <AlertDialogPrimitive.Content
      ref={ref}
      className={cn(
        // –ü–Ü–î–ù–Ø–¢–û Z-INDEX –î–û –ú–ê–ö–°–ò–ú–£–ú–£
        'fixed left-[50%] top-[50%] z-[999] grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg',
        className,
      )}
      {...props}
    />
  </AlertDialogPortal>
));
AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName;

const AlertDialogHeader = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn('flex flex-col space-y-2 text-center sm:text-left', className)} {...props} />
);
AlertDialogHeader.displayName = 'AlertDialogHeader';

const AlertDialogFooter = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn('flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2', className)}
    {...props}
  />
);
AlertDialogFooter.displayName = 'AlertDialogFooter';

const AlertDialogTitle = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Title
    ref={ref}
    className={cn('text-lg font-semibold', className)}
    {...props}
  />
));
AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName;

const AlertDialogDescription = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Description
    ref={ref}
    className={cn('text-sm text-muted-foreground', className)}
    {...props}
  />
));
AlertDialogDescription.displayName = AlertDialogPrimitive.Description.displayName;

const AlertDialogAction = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Action>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Action ref={ref} className={cn(buttonVariants(), className)} {...props} />
));
AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName;

const AlertDialogCancel = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Cancel
    ref={ref}
    className={cn(buttonVariants({ variant: 'outline' }), 'mt-2 sm:mt-0', className)}
    {...props}
  />
));
AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName;

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
};
</file>

<file path="src/components/ui/context-menu.tsx">
'use client';

import * as ContextMenuPrimitive from '@radix-ui/react-context-menu';
import { ChevronRight } from 'lucide-react';
import * as React from 'react';
import { cn } from '@/lib/utils';

const ContextMenu = ContextMenuPrimitive.Root;
const ContextMenuTrigger = ContextMenuPrimitive.Trigger;
const ContextMenuGroup = ContextMenuPrimitive.Group;
const ContextMenuPortal = ContextMenuPrimitive.Portal;
const ContextMenuSub = ContextMenuPrimitive.Sub;
const ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup;

const ContextMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & { inset?: boolean }
>(({ className, inset, children, ...props }, ref) => (
  <ContextMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      'flex cursor-default select-none items-center rounded-xl px-3 py-2 text-sm outline-none focus:bg-white/10 focus:text-white data-[state=open]:bg-white/10 data-[state=open]:text-white',
      inset && 'pl-8',
      className,
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </ContextMenuPrimitive.SubTrigger>
));
ContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName;

const ContextMenuContent = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.Portal>
    <ContextMenuPrimitive.Content
      ref={ref}
      className={cn(
        'z-50 min-w-[12rem] overflow-hidden rounded-2xl border border-white/10 bg-neutral-950/90 p-1.5 text-white shadow-2xl backdrop-blur-xl animate-in fade-in-80 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95',
        className,
      )}
      {...props}
    />
  </ContextMenuPrimitive.Portal>
));
ContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName;

const ContextMenuItem = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & { inset?: boolean }
>(({ className, inset, ...props }, ref) => (
  <ContextMenuPrimitive.Item
    ref={ref}
    className={cn(
      'relative flex cursor-pointer select-none items-center rounded-xl px-3 py-2.5 text-sm outline-none transition-colors focus:bg-white/10 focus:text-white data-[disabled]:pointer-events-none data-[disabled]:opacity-50',
      inset && 'pl-8',
      className,
    )}
    {...props}
  />
));
ContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName;

const ContextMenuSeparator = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.Separator
    ref={ref}
    className={cn('-mx-1 my-1 h-px bg-white/5', className)}
    {...props}
  />
));
ContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName;

export {
  ContextMenu,
  ContextMenuTrigger,
  ContextMenuContent,
  ContextMenuItem,
  ContextMenuSeparator,
  ContextMenuGroup,
  ContextMenuPortal,
  ContextMenuSub,
  ContextMenuSubTrigger,
  ContextMenuRadioGroup,
};
</file>

<file path="src/store/useChatStore.ts">
import { create } from 'zustand';

interface UIState {
  activeChatId: string | null;
  isSidebarOpen: boolean;
  setActiveChatId: (id: string | null) => void;
  toggleSidebar: () => void;
}

export const useUIStore = create<UIState>((set) => ({
  activeChatId: null,
  isSidebarOpen: true,
  setActiveChatId: (id) => set({ activeChatId: id }),
  toggleSidebar: () => set((state) => ({ isSidebarOpen: !state.isSidebarOpen })),
}));
</file>

<file path="drizzle/meta/_journal.json">
{
  "version": "7",
  "dialect": "postgresql",
  "entries": [
    {
      "idx": 0,
      "version": "7",
      "when": 1769528855700,
      "tag": "0000_flat_grandmaster",
      "breakpoints": true
    },
    {
      "idx": 1,
      "version": "7",
      "when": 1769687175587,
      "tag": "0001_pretty_whiplash",
      "breakpoints": true
    }
  ]
}
</file>

<file path="next.config.ts">
const nextConfig = {
  reactCompiler: true,
  logging: {
    fetches: {
      fullUrl: true,
    },
  },
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'i.pravatar.cc',
        port: '',
        pathname: '/**',
      },
      {
        protocol: 'https',
        hostname: 'lh3.googleusercontent.com', // –û–¥—Ä–∞–∑—É –¥–æ–¥–∞—î–º–æ –¥–ª—è Google Auth –∞–≤–∞—Ç–∞—Ä—ñ–≤
        port: '',
        pathname: '/**',
      },
    ],
  },
};
export default nextConfig;
</file>

<file path="src/components/chat/AttachmentPreview.tsx">
'use client';

import { FileIcon, Loader2, X } from 'lucide-react';
import Image from 'next/image';
import type { PendingAttachment } from '@/hooks/useAttachment';

interface AttachmentPreviewProps {
  attachment: PendingAttachment;
  onRemove: (id: string) => void;
}

export function AttachmentPreview({ attachment, onRemove }: AttachmentPreviewProps) {
  const isImage = attachment.type === 'image';

  return (
    <div className="relative group w-20 h-20 rounded-lg overflow-hidden border border-white/10 bg-white/5 flex items-center justify-center">
      {attachment.uploading && (
        <div className="absolute inset-0 z-10 bg-black/40 flex items-center justify-center">
          <Loader2 className="w-5 h-5 text-white animate-spin" />
        </div>
      )}

      {attachment.error && (
        <div className="absolute inset-0 z-10 bg-red-500/20 flex items-center justify-center p-1 text-[8px] text-red-200 text-center">
          Error
        </div>
      )}

      {isImage ? (
        <Image
          src={attachment.previewUrl}
          alt={attachment.metadata.name}
          fill
          className="w-full h-full object-cover transition-transform group-hover:scale-110"
          unoptimized
        />
      ) : (
        <div className="flex flex-col items-center gap-1 p-2">
          <FileIcon className="w-8 h-8 text-blue-400" />
          <span className="text-[8px] text-gray-400 truncate w-full text-center">
            {attachment.metadata.name}
          </span>
        </div>
      )}

      <button
        type="button"
        onClick={() => onRemove(attachment.id)}
        className="absolute top-1 right-1 p-1 rounded-full bg-black/50 text-white opacity-100 lg:opacity-0 lg:group-hover:opacity-100 transition-opacity hover:bg-red-500 z-20"
      >
        <X size={12} />
      </button>
    </div>
  );
}
</file>

<file path="src/components/chat/ComposerAddons.tsx">
'use client';

import { X } from 'lucide-react';
import type { PendingAttachment } from '@/hooks/useAttachment';
import type { Message } from '@/types';
import { AttachmentPreview } from './AttachmentPreview';

interface ComposerAddonsProps {
  replyTo?: Message | null;
  onReplyCancel?: () => void;
  editingMessage?: Message | null;
  onEditCancel?: () => void;
  attachments: PendingAttachment[];
  onAttachmentRemove: (id: string) => void;
  otherParticipantName?: string;
}

export function ComposerAddons({
  replyTo,
  onReplyCancel,
  editingMessage,
  onEditCancel,
  attachments,
  onAttachmentRemove,
  otherParticipantName,
}: ComposerAddonsProps) {
  if (!replyTo && !editingMessage && attachments.length === 0) return null;

  return (
    <div
      className="px-4 py-3 border-t border-white/5 backdrop-blur-md bg-white/5 space-y-2"
      style={{ willChange: 'transform' }}
    >
      {/* Editing Preview */}
      {editingMessage && (
        <div className="flex items-center gap-3 py-2 border-s-4 border-amber-500 px-3 bg-amber-500/5 rounded-e-lg relative group">
          <div className="flex-1 min-w-0">
            <p className="text-xs font-semibold text-amber-400">
              Editing message
            </p>
            <p className="text-sm text-gray-300 truncate">{editingMessage.content}</p>
          </div>
          <button
            type="button"
            onClick={onEditCancel}
            className="p-1 hover:bg-white/10 rounded-full text-gray-400 transition-colors duration-300"
          >
            <X size={16} />
          </button>
        </div>
      )}

      {/* Reply Preview */}
      {replyTo && (
        <div className="flex items-center gap-3 py-2 border-s-4 border-blue-500 px-3 bg-blue-500/5 rounded-e-lg relative group">
          <div className="flex-1 min-w-0">
            <p className="text-xs font-semibold text-blue-400">
              {replyTo.senderId === 'me'
                ? 'Reply to yourself'
                : `Reply to ${otherParticipantName || 'user'}`}
            </p>
            <p className="text-sm text-gray-300 truncate">{replyTo.content}</p>
          </div>
          <button
            type="button"
            onClick={onReplyCancel}
            className="p-1 hover:bg-white/10 rounded-full text-gray-400 transition-colors duration-300"
          >
            <X size={16} />
          </button>
        </div>
      )}

      {/* Attachments Preview */}
      {attachments.length > 0 && (
        <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
          {attachments.map((attachment) => (
            <AttachmentPreview
              key={attachment.id}
              attachment={attachment}
              onRemove={onAttachmentRemove}
            />
          ))}
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/chat/ImageModal.tsx">
'use client';

import { AnimatePresence, motion } from 'framer-motion';
import { AlertCircle, ChevronLeft, ChevronRight, Download, ImageOff, X } from 'lucide-react';
import Image from 'next/image';
import { useCallback, useEffect, useState } from 'react';
import { createPortal } from 'react-dom';
import { cn } from '@/lib/utils';
import type { Attachment } from '@/types';

interface ImageModalProps {
  isOpen: boolean;
  images: Attachment[];
  initialIndex: number;
  onClose: () => void;
}

export function ImageModal({ isOpen, images, initialIndex, onClose }: ImageModalProps) {
  const [mounted, setMounted] = useState(false);
  const [currentIndex, setCurrentIndex] = useState(initialIndex);
  const [direction, setDirection] = useState(0);
  const [hasError, setHasError] = useState(false);

  // 1. –ë–µ–∑–ø–µ—á–Ω–µ –º–æ–Ω—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è SSR (–≤–∏–ø—Ä–∞–≤–ª—è—î cascading renders)
  useEffect(() => {
    const raf = requestAnimationFrame(() => {
      setMounted(true);
    });
    return () => cancelAnimationFrame(raf);
  }, []);

  // 2. –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —Å—Ç–µ–π—Ç—É (–ø–∞—Ç—Ç–µ—Ä–Ω Adjusting state based on props)
  const [prevInitialIndex, setPrevInitialIndex] = useState(initialIndex);

  if (initialIndex !== prevInitialIndex) {
    setPrevInitialIndex(initialIndex);
    setCurrentIndex(initialIndex);
    setHasError(false);
    setDirection(0);
  }

  const handleNext = useCallback(
    (e?: React.MouseEvent | KeyboardEvent) => {
      // –ë–µ–∑–ø–µ—á–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞: —Å–ø–æ—á–∞—Ç–∫—É —á–∏ —ñ—Å–Ω—É—î 'e', –ø–æ—Ç—ñ–º —á–∏ —î –≤ –Ω—å–æ–º—É –º–µ—Ç–æ–¥
      if (e && 'stopPropagation' in e) {
        e.stopPropagation();
      }

      if (currentIndex < images.length - 1) {
        setDirection(1);
        setCurrentIndex((prev) => prev + 1);
        setHasError(false);
      }
    },
    [currentIndex, images.length],
  );

  const handlePrev = useCallback(
    (e?: React.MouseEvent | KeyboardEvent) => {
      // –ê–Ω–∞–ª–æ–≥—ñ—á–Ω–æ —Ç—É—Ç
      if (e && 'stopPropagation' in e) {
        e.stopPropagation();
      }

      if (currentIndex > 0) {
        setDirection(-1);
        setCurrentIndex((prev) => prev - 1);
        setHasError(false);
      }
    },
    [currentIndex],
  );

  // 3. –û–±—Ä–æ–±–∫–∞ –∫–ª–∞–≤—ñ—à —Ç–∞ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è —Å–∫—Ä–æ–ª—É
  useEffect(() => {
    if (!isOpen) return;

    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'Escape') onClose();
      if (e.key === 'ArrowRight') handleNext(e);
      if (e.key === 'ArrowLeft') handlePrev(e);
    };

    document.addEventListener('keydown', handleKeyDown);
    const originalStyle = window.getComputedStyle(document.body).overflow;
    document.body.style.overflow = 'hidden';

    return () => {
      document.removeEventListener('keydown', handleKeyDown);
      document.body.style.overflow = originalStyle;
    };
  }, [isOpen, onClose, handleNext, handlePrev]);

  if (!mounted) return null;

  const currentImage = images[currentIndex];

  const variants = {
    enter: (dir: number) => ({
      x: dir > 0 ? 300 : dir < 0 ? -300 : 0,
      opacity: 0,
      scale: 0.95,
    }),
    center: {
      zIndex: 1,
      x: 0,
      opacity: 1,
      scale: 1,
    },
    exit: (dir: number) => ({
      zIndex: 0,
      x: dir < 0 ? 300 : dir > 0 ? -300 : 0,
      opacity: 0,
      scale: 0.95,
    }),
  };

  const modalContent = (
    <AnimatePresence initial={false}>
      {isOpen && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="fixed inset-0 z-[9999] flex flex-col bg-black/95 backdrop-blur-md"
          onClick={onClose}
        >
          {/* Header */}
          <div className="absolute top-0 left-0 right-0 h-20 px-6 flex items-center justify-between z-[10000] bg-gradient-to-b from-black/50 to-transparent">
            <div className="flex flex-col text-white">
              <span className="font-medium truncate max-w-[200px] sm:max-w-md text-sm">
                {currentImage?.metadata?.name || '–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è'}
              </span>
              <span className="text-white/40 text-[11px] uppercase tracking-wider">
                {currentIndex + 1} –∑ {images.length}
              </span>
            </div>

            <div className="flex items-center gap-2">
              {!hasError && currentImage?.url && (
                <a
                  href={currentImage.url}
                  download={currentImage.metadata?.name}
                  onClick={(e) => e.stopPropagation()}
                  className="p-2.5 rounded-full bg-white/5 hover:bg-white/10 text-white transition-all"
                >
                  <Download size={20} />
                </a>
              )}
              <button
                type="button"
                onClick={onClose}
                className="p-2.5 rounded-full bg-white/10 hover:bg-white/20 text-white transition-all shadow-xl"
              >
                <X size={20} />
              </button>
            </div>
          </div>

          {/* Main Content */}
          <div className="relative flex-1 flex items-center justify-center p-4">
            {currentIndex > 0 && (
              <button
                type="button"
                onClick={(e) => handlePrev(e)}
                className="absolute left-4 z-[10001] p-3 rounded-full bg-white/5 hover:bg-white/10 text-white transition-all backdrop-blur-sm border border-white/10"
              >
                <ChevronLeft size={28} />
              </button>
            )}

            <AnimatePresence initial={false} custom={direction} mode="popLayout">
              <motion.div
                key={currentIndex}
                custom={direction}
                variants={variants}
                initial={direction === 0 ? { opacity: 0, scale: 0.9 } : 'enter'}
                animate="center"
                exit="exit"
                transition={{
                  x: { type: 'spring', stiffness: 300, damping: 30 },
                  opacity: { duration: 0.2 },
                }}
                className="relative w-full h-full flex items-center justify-center"
                onClick={(e) => e.stopPropagation()}
              >
                {!hasError && currentImage?.url ? (
                  <Image
                    src={currentImage.url}
                    alt="–ì–∞–ª–µ—Ä–µ—è"
                    fill
                    className="object-contain select-none"
                    priority
                    unoptimized
                    onError={() => setHasError(true)}
                  />
                ) : (
                  <div className="flex flex-col items-center gap-4 text-white/50 bg-white/5 p-12 rounded-3xl border border-white/10 backdrop-blur-sm">
                    <div className="relative">
                      <ImageOff className="w-16 h-16 opacity-20" />
                      <AlertCircle className="w-8 h-8 text-red-500 absolute -bottom-1 -right-1" />
                    </div>
                    <div className="text-center">
                      <p className="text-lg font-medium text-white/80 uppercase tracking-tight">Media not available</p>
                      <p className="text-sm text-white/40 mt-1">The file has been deleted or expired</p>
                    </div>
                  </div>
                )}
              </motion.div>
            </AnimatePresence>

            {currentIndex < images.length - 1 && (
              <button
                type="button"
                onClick={(e) => handleNext(e)}
                className="absolute right-4 z-[10001] p-3 rounded-full bg-white/5 hover:bg-white/10 text-white transition-all backdrop-blur-sm border border-white/10"
              >
                <ChevronRight size={28} />
              </button>
            )}
          </div>

          {/* Indicators */}
          <div className="h-20 px-6 flex items-center justify-center gap-2 z-[10000]">
            {images.length > 1 &&
              images.map((img, idx) => (
                <div
                  key={img.id}
                  className={cn(
                    'h-1.5 transition-all duration-300 rounded-full',
                    idx === currentIndex ? 'w-8 bg-blue-500' : 'w-1.5 bg-white/20',
                  )}
                />
              ))}
          </div>
        </motion.div>
      )}
    </AnimatePresence>
  );

  return createPortal(modalContent, document.body);
}
</file>

<file path="src/components/SupabaseAuthProvider.tsx">
'use client';

import type { User, AuthChangeEvent, Session } from '@supabase/supabase-js';
import { createContext, useContext, useEffect, useState } from 'react';
import { useGlobalRealtime } from '@/hooks/useGlobalRealtime';
import { supabase } from '@/lib/supabase/client';

interface SupabaseAuthContextType {
  user: User | null;
  loading: boolean;
}

const SupabaseAuthContext = createContext<SupabaseAuthContextType>({ 
  user: null, 
  loading: true 
});

export const useSupabaseAuth = () => useContext(SupabaseAuthContext);

export function SupabaseAuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —Ä–µ–∞–ª—Ç–∞–π–º
  useGlobalRealtime(user);

  useEffect(() => {
    // –¢–∏–ø—ñ–∑—É—î–º–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–µ—Å—ñ—ó
    supabase.auth.getSession().then(({ data: { session } }: { data: { session: Session | null } }) => {
      setUser(session?.user ?? null);
      setLoading(false);
    });

    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      (_event: AuthChangeEvent, session: Session | null) => {
        setUser(session?.user ?? null);
        setLoading(false);
      }
    );

    return () => {
      subscription.unsubscribe();
    };
  }, []);

  return (
    <SupabaseAuthContext.Provider value={{ user, loading }}>
      {children}
    </SupabaseAuthContext.Provider>
  );
}
</file>

<file path="src/lib/supabase.ts">
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL ?? '';
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ?? '';
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY ?? '';

if (!supabaseUrl || !supabaseAnonKey) {
  console.error('Supabase env variables are missing! Check your .env.local file.');
}

// Client for browser-side public operations (e.g., getting public URLs)
export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    persistSession: false, // –¶–µ –≤–∏–º–∫–Ω–µ —Å–ø—Ä–æ–±–∏ –∫–ª—ñ—î–Ω—Ç–∞ –∑–Ω–∞–π—Ç–∏ —Å–µ—Å—ñ—é —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ
    autoRefreshToken: false,
    detectSessionInUrl: false,
  },
});

// Client for server-side secure operations (e.g., uploading files via Server Actions)
// This client bypasses RLS and should ONLY be used in server-side code.
export const supabaseService = supabaseServiceKey
  ? createClient(supabaseUrl, supabaseServiceKey)
  : null;
</file>

<file path="src/lib/supabase/client.ts">
'use client';

import { createBrowserClient } from '@supabase/ssr';
import { camelizeKeys, decamelizeKeys } from 'humps';
import { toast } from 'sonner';

let client: any;

export function createClient() {
  if (client) return client;

  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL ?? '';
  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ?? '';

  client = createBrowserClient(supabaseUrl, supabaseAnonKey, {
    global: {
      fetch: async (url, options) => {
        // 1. OUTBOUND: Convert camelCase from JS to snake_case for DB
        if (options?.body && typeof options.body === 'string') {
          try {
            const body = JSON.parse(options.body);
            options.body = JSON.stringify(decamelizeKeys(body));
          } catch {
            /* Keep as is if not JSON */
          }
        }

        const response = await fetch(url, options);

        // --- GLOBAL ERROR HANDLING ---
        if (!response.ok) {
          // Silent handling for 401 Unauthorized (Auth listener handles redirects)
          if (response.status === 401) {
            return response;
          }

          // Robust error parsing
          let errorMessage = response.statusText;
          try {
            const text = await response.clone().text();
            if (text) {
              const errorBody = JSON.parse(text);
              errorMessage = 
                errorBody?.message || 
                errorBody?.error_description || 
                errorBody?.msg || 
                errorMessage;
            }
          } catch {
            // If body parsing fails, stick to statusText or default
          }

          // Trigger Toast for non-401 errors
          if (response.status >= 500) {
            toast.error(`Server Error (${response.status})`, {
              description: 'Something went wrong on our end. Please try again later.',
            });
          } else if (response.status >= 400) {
            toast.error('Request Failed', {
              description: errorMessage || 'Unable to complete this action.',
            });
          }

          return response;
        }

        // --- SUCCESSFUL RESPONSE HANDLING ---
        // If status between 200-299, return immediately if no body or not JSON
        if (response.status === 204 || response.status === 205) {
          return response;
        }

        const contentType = response.headers.get('content-type');
        if (contentType?.includes('application/json')) {
          try {
            const text = await response.clone().text();
            if (!text) return response;
            
            const json = JSON.parse(text);
            return new Response(JSON.stringify(camelizeKeys(json)), {
              status: response.status,
              statusText: response.statusText,
              headers: response.headers,
            });
          } catch (err) {
            console.error('[Supabase Interceptor] Failed to parse success JSON:', err);
            return response;
          }
        }

        return response;
      },
    },
  });

  return client;
}

// Export a constant instance for use in hooks to reinforce singleton usage
export const supabase = createClient();
</file>

<file path="src/actions/auth.ts">
'use client';

import { createClient } from '@/lib/supabase/client';

export async function handleSignIn() {
  const supabase = createClient();
  const { error } = await supabase.auth.signInWithOAuth({
    provider: 'google',
    options: {
      redirectTo: `${window.location.origin}/auth/callback`,
    },
  });

  if (error) {
    console.error('Error signing in:', error.message);
  }
}

export async function handleSignOut() {
  const supabase = createClient();

  // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–¥ –≤–∏—Ö–æ–¥–æ–º
  try {
    await supabase.rpc('update_last_seen');
  } catch (e) {
    console.error('Failed to update last seen on sign out', e);
  }

  const { error } = await supabase.auth.signOut();

  if (error) {
    console.error('Error signing out:', error.message);
  } else {
    window.location.href = '/';
  }
}
</file>

<file path="src/components/layout/ChatLayoutWrapper.tsx">
'use client';

import { usePathname } from 'next/navigation';
import { useCallback, useEffect, useState } from 'react';
import Navbar from './Navbar';

interface ChatLayoutWrapperProps {
  children: React.ReactNode;
  sidebar?: React.ReactNode;
  user?: {
    id: string;
    name?: string | null;
    email?: string | null;
    image?: string | null;
  } | null;
}

export default function ChatLayoutWrapper({ children, sidebar, user }: ChatLayoutWrapperProps) {
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [prevPathname, setPrevPathname] = useState<string | null>(null);
  const pathname = usePathname();

  // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–º—ñ–Ω—ñ —à–ª—è—Ö—É
  if (pathname !== prevPathname) {
    if (isSidebarOpen) setIsSidebarOpen(false);
    setPrevPathname(pathname);
  }

  const handleClose = useCallback(() => {
    setIsSidebarOpen(false);
  }, []);

  useEffect(() => {
    window.addEventListener('close-mobile-sidebar', handleClose);
    return () => window.removeEventListener('close-mobile-sidebar', handleClose);
  }, [handleClose]);

  const toggleSidebar = () => setIsSidebarOpen((prev) => !prev);

  return (
    <div className="flex flex-col min-h-[100dvh]">
      <Navbar user={user} onMenuClick={toggleSidebar} />

      <div className="flex flex-1 pt-16 relative overflow-hidden">
        {/* Overlay for mobile */}
        <button
          type="button"
          id="sidebar-overlay"
          className={`
            fixed inset-0 bg-black/60 backdrop-blur-sm lg:hidden
            transition-opacity duration-300
            z-[80] 
            ${isSidebarOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}
          `}
          onClick={() => setIsSidebarOpen(false)}
          onKeyDown={(e) => {
            if (e.key === 'Escape') setIsSidebarOpen(false);
          }}
          aria-label="Close Sidebar"
        />

        {/* Sidebar Container with smooth transition */}
        <aside
          className={`
            fixed lg:static inset-y-0 left-0 
            z-[90] 
            transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}
            transition-all duration-300 ease-in-out
            h-[calc(100dvh-64px)] mt-16 lg:mt-0
            bg-black lg:bg-transparent
            border-r border-white/5
            ${user ? 'w-80 opacity-100 visible' : 'w-0 opacity-0 invisible overflow-hidden border-none'}
          `}
        >
          <div className="w-80 h-full overflow-hidden">
            {sidebar}
          </div>
        </aside>

        <main className="flex-1 w-full min-w-0 relative z-0 transition-all duration-300">
          {children}
        </main>
      </div>
    </div>
  );
}
</file>

<file path="src/components/Providers.tsx">
'use client';

import { MutationCache, QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';
import { useState, useEffect, useRef } from 'react';
import { toast, Toaster } from 'sonner';
import { GlobalErrorBoundary } from '@/components/GlobalErrorBoundary';

/**
 * –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç-–∑–∞–ø–æ–±—ñ–∂–Ω–∏–∫.
 * –í—ñ–Ω –≤—ñ–¥—Å—Ç–µ–∂—É—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–Ω–¥–µ—Ä—ñ–≤ —É –≤—Å—å–æ–º—É –¥–æ–¥–∞—Ç–∫—É.
 */
function RenderGuard({ children }: { children: React.ReactNode }) {
  const renderCount = useRef(0);
  const startTime = useRef(Date.now());

  useEffect(() => {
    renderCount.current += 1;
    const now = Date.now();

    // –°–∫–∏–¥–∞—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –∫–æ–∂–Ω—ñ 5 —Å–µ–∫—É–Ω–¥
    if (now - startTime.current > 5000) {
      renderCount.current = 1;
      startTime.current = now;
      return;
    }

    // –Ø–∫—â–æ —Ä–µ–Ω–¥–µ—Ä—ñ–≤ –∑–∞–Ω–∞–¥—Ç–æ –±–∞–≥–∞—Ç–æ (–±—ñ–ª—å—à–µ 30 –∑–∞ 5 —Å–µ–∫) ‚Äî —Ü–µ "–ø–µ—Ç–ª—è"
    if (renderCount.current > 30) {
      console.error("‚õî [RenderGuard] Detected an infinite loop.");
      
      toast.error("–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –∫–ª—ñ—î–Ω—Ç–∞", {
        description: "–í–∏—è–≤–ª–µ–Ω–æ –≤—ñ—á–Ω–∏–π —Ü–∏–∫–ª. –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –Ω–∞ –≥–æ–ª–æ–≤–Ω—É...",
        duration: 5000,
      });

      // –†–æ–±–∏–º–æ –∂–æ—Ä—Å—Ç–∫–∏–π —Ä–µ–¥—ñ—Ä–µ–∫—Ç, —â–æ–± —Ä–æ–∑—ñ—Ä–≤–∞—Ç–∏ —Ü–∏–∫–ª
      setTimeout(() => {
        window.location.replace('/'); 
      }, 1500);
    }
  }); // –ú–∞—Å–∏–≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π –ø–æ—Ä–æ–∂–Ω—ñ–π (–≤—ñ–¥—Å—É—Ç–Ω—ñ–π), —â–æ–± —Å–ø—Ä–∞—Ü—å–æ–≤—É–≤–∞—Ç–∏ –Ω–∞ –∫–æ–∂–µ–Ω —Ä–µ–Ω–¥–µ—Ä

  return <>{children}</>;
}

export default function Providers({ children }: { children: React.ReactNode }) {
  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ QueryClient –æ–¥–∏–Ω —Ä–∞–∑ —á–µ—Ä–µ–∑ useState
  const [queryClient] = useState(() => {
    return new QueryClient({
      mutationCache: new MutationCache({
        onError: (error: any) => {
          // If the error has a 'status' property, it was likely handled by the Supabase fetch interceptor
          // We only want to toast for client-side errors or unexpected issues here.
          if (!error?.status) {
            toast.error('Error', {
              description: error.message || 'An unexpected error occurred.',
            });
          }
        },
      }),
      defaultOptions: {
        queries: {
          staleTime: 60 * 1000,
          // –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –∑–∞–π–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
          retry: (failureCount, error: any) => {
            if (error?.status === 401) return false;
            return failureCount < 3;
          },
        },
      },
    });
  });

  return (
    <QueryClientProvider client={queryClient}>
      <GlobalErrorBoundary>
        <RenderGuard>
          {children}
        </RenderGuard>
        <Toaster 
          position="top-right" 
          richColors 
          closeButton 
          expand={true}
          visibleToasts={3}
          toastOptions={{
            style: { zIndex: 9999 }
          }}
        />
      </GlobalErrorBoundary>
      <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  );
}
</file>

<file path="src/components/sidebar/Sidebar.tsx">
import { createClient } from '@/lib/supabase/server';
import SidebarShell from './SidebarShell';

export default async function Sidebar() {
  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) return null;

  return <SidebarShell />;
}
</file>

<file path="src/hooks/useAttachment.ts">
'use client';

import imageCompression from 'browser-image-compression';
import { useCallback, useEffect, useState } from 'react';
import { toast } from 'sonner';
import { useSupabaseAuth } from '@/components/SupabaseAuthProvider';
import { createClient } from '@/lib/supabase/client';
import type { Attachment } from '@/types';

export interface PendingAttachment extends Attachment {
  file: File;
  previewUrl: string;
  uploading: boolean;
  error?: string;
}

export function useAttachment(chatId: string) {
  const [attachments, setAttachments] = useState<PendingAttachment[]>([]);
  const { user } = useSupabaseAuth();
  const supabase = createClient();

  // –û—á–∏—â–µ–Ω–Ω—è URL-–ø—Ä–µ–≤'—é –ø—Ä–∏ —Ä–æ–∑–º–æ–Ω—Ç—É–≤–∞–Ω–Ω—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
  useEffect(() => {
    return () => {
      attachments.forEach((a) => {
        if (a.previewUrl) URL.revokeObjectURL(a.previewUrl);
      });
    };
  }, [attachments]);

  const uploadFile = useCallback(
    async (file: File) => {
      if (!user) {
        toast.error('–í–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ');
        return;
      }

      const id = crypto.randomUUID();
      const previewUrl = URL.createObjectURL(file);
      const isImage = file.type.startsWith('image/');

      // –§–æ—Ä–º—É—î–º–æ —á–∏—Å—Ç–µ —ñ–º'—è —Ñ–∞–π–ª—É (–±–µ–∑–ø–µ—á–Ω–æ –¥–ª—è URL)
      const timestamp = Date.now();
      const safeName = file.name.replace(/[^a-zA-Z0-9.\-_]/g, '');
      const fileName = `${timestamp}_${safeName}`;

      // –®–ª—è—Ö –í–ê–ñ–õ–ò–í–ò–ô: –ø–µ—Ä—à–∏–º –º–∞—î –π—Ç–∏ chatId –¥–ª—è –Ω–∞—à–æ—ó RLS –ø–æ–ª—ñ—Ç–∏–∫–∏
      const filePath = `${chatId}/${user.id}/${fileName}`;

      const newAttachment: PendingAttachment = {
        id,
        type: isImage ? 'image' : 'file',
        url: '',
        metadata: { name: file.name, size: file.size },
        file,
        previewUrl,
        uploading: true,
      };

      setAttachments((prev) => [...prev, newAttachment]);

      try {
        let fileToUpload: File | Blob = file;

        // –°—Ç–∏—Å–Ω–µ–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ –¥–ª—è –∑–æ–±—Ä–∞–∂–µ–Ω—å
        if (isImage && file.size > 1024 * 1024) {
          // –°—Ç–∏—Å–∫–∞—Ç–∏, —è–∫—â–æ > 1MB
          try {
            fileToUpload = await imageCompression(file, {
              maxSizeMB: 0.8,
              maxWidthOrHeight: 1920,
              useWebWorker: true,
            });
          } catch (e) {
            console.warn('–°—Ç–∏—Å–Ω–µ–Ω–Ω—è –Ω–µ –≤–¥–∞–ª–æ—Å—è, –≤–∞–Ω—Ç–∞–∂–∏–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª', e);
          }
        }

        const { error } = await supabase.storage
          .from('attachments')
          .upload(filePath, fileToUpload, {
            cacheControl: '3600',
            upsert: false,
          });

        if (error) {
          // –û–±—Ä–æ–±–∫–∞ –Ω–∞—à–æ–≥–æ SQL-—Ç—Ä–∏–≥–µ—Ä–∞ –Ω–∞ –ª—ñ–º—ñ—Ç 10 –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—å
          if (error.message.toLowerCase().includes('rate limit')) {
            throw new Error('–õ—ñ–º—ñ—Ç –≤–∏—á–µ—Ä–ø–∞–Ω–æ: –Ω–µ –±—ñ–ª—å—à–µ 10 —Ñ–∞–π–ª—ñ–≤ –Ω–∞ —Ö–≤–∏–ª–∏–Ω—É.');
          }
          throw error;
        }

        // –û—Ç—Ä–∏–º—É—î–º–æ –ø—Ä—è–º–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
        const { data: publicData } = supabase.storage.from('attachments').getPublicUrl(filePath);

        setAttachments((prev) =>
          prev.map((a) =>
            a.id === id ? { ...a, url: publicData.publicUrl, uploading: false } : a,
          ),
        );
      } catch (err: unknown) {
        const errorMessage = err instanceof Error ? err.message : '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è';
        toast.error(errorMessage);

        setAttachments((prev) =>
          prev.map((a) => (a.id === id ? { ...a, uploading: false, error: errorMessage } : a)),
        );
      }
    },
    [chatId, user, supabase],
  );

  const removeAttachment = useCallback((id: string) => {
    setAttachments((prev) => {
      const target = prev.find((a) => a.id === id);
      if (target?.previewUrl) URL.revokeObjectURL(target.previewUrl);
      return prev.filter((a) => a.id !== id);
    });
  }, []);

  const clearAttachments = useCallback(() => {
    attachments.forEach((a) => {
      if (a.previewUrl) URL.revokeObjectURL(a.previewUrl);
    });
    setAttachments([]);
  }, [attachments]);

  return {
    attachments,
    uploadFile,
    removeAttachment,
    clearAttachments,
    isUploading: attachments.some((a) => a.uploading),
  };
}
</file>

<file path="src/lib/date-utils.ts">
// src/lib/date-utils.ts
import { format, isToday, isYesterday } from 'date-fns';
import { uk } from 'date-fns/locale';

type DateInput = string | number | Date | null | undefined;

/**
 * –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î –±—É–¥—å-—è–∫—É –¥–∞—Ç—É –≤—ñ–¥ Supabase —É –≤–∞–ª—ñ–¥–Ω–∏–π —Ç–∞–π–º—Å—Ç–∞–º–ø (ms)
 */
export function getSafeTimestamp(date: DateInput): number {
  if (!date) return 0;
  try {
    // –¢–≤–æ—è —Ñ—ñ—Ä–º–æ–≤–∞ –ª–æ–≥—ñ–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ä—è–¥–∫–∞
    const dateString = typeof date === 'string' && !date.includes('Z') && !date.includes('+') 
      ? `${date.replace(' ', 'T')}Z` 
      : date;

    const d = new Date(dateString);
    return Number.isNaN(d.getTime()) ? 0 : d.getTime();
  } catch {
    return 0;
  }
}

export function formatMessageDate(date: DateInput) {
  const ts = getSafeTimestamp(date);
  if (!ts) return '';
  const d = new Date(ts);

  if (isToday(d)) return format(d, 'HH:mm');
  if (isYesterday(d)) return `–í—á–æ—Ä–∞, ${format(d, 'HH:mm')}`;
  
  return format(d, 'd MMM, HH:mm', { locale: uk });
}

export function formatRelativeTime(date: DateInput) {
  const ts = getSafeTimestamp(date);
  if (!ts) return '';
  const d = new Date(ts);

  if (isToday(d)) return format(d, 'HH:mm');
  if (isYesterday(d)) return '–í—á–æ—Ä–∞';
  
  return format(d, 'dd.MM.yy');
}
</file>

<file path=".env.example">
# üåê App Configuration
NEXT_PUBLIC_SITE_URL=http://localhost:3000
PORT=3000

# ‚ö° Supabase (–û—Ç—Ä–∏–º–∞—Ç–∏ –≤ Project Settings > API)
NEXT_PUBLIC_SUPABASE_URL=https://your-project-url.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key-here


# üóÑÔ∏è Database (PostgreSQL)
DATABASE_URL=postgresql://user:password@host/dbname?sslmode=require


# Google OAuth (Register at console.cloud.google.com)
# AUTH_GOOGLE_ID=your-google-client-id
# AUTH_GOOGLE_SECRET=your-google-client-secret
</file>

<file path="src/components/chat/MessageMediaGrid.tsx">
'use client';

import { FileX, ImageOff, PlayCircle } from 'lucide-react';
import Image from 'next/image';
import { useState } from 'react';
import { cn } from '@/lib/utils';
import type { Attachment } from '@/types';
import { ImageModal } from './ImageModal';

interface MessageMediaGridProps {
  items: Attachment[];
}

const MediaPlaceholder = ({ reason = 'deleted' }: { reason?: 'deleted' | 'error' }) => {
  const Icon = reason === 'deleted' ? FileX : ImageOff;
  return (
    <div className="flex flex-col items-center justify-center w-full h-full bg-neutral-100 dark:bg-neutral-800 border border-neutral-200 dark:border-white/5 rounded-xl p-4 text-center min-h-[150px]">
      <Icon className="w-5 h-5 text-neutral-500 mb-2" />
      <p className="text-[10px] font-bold uppercase tracking-wider text-neutral-500">
        {reason === 'deleted' ? 'Deleted' : 'Error'}
      </p>
    </div>
  );
};

export function MessageMediaGrid({ items }: MessageMediaGridProps) {
  const [selectedIndex, setSelectedIndex] = useState<number | null>(null);
  const [failedUrls, setFailedUrls] = useState<Set<string>>(new Set());

  if (!items || items.length === 0) return null;

  const handleImageError = (url: string) => {
    setFailedUrls((prev) => new Set(prev).add(url));
  };

  const activeMedia = items.filter((item) => !item.isDeleted && !failedUrls.has(item.url));
  const count = items.length;

  const handleMediaClick = (index: number) => {
    const clickedItem = items[index];
    if (clickedItem.isDeleted || failedUrls.has(clickedItem.url)) return;
    const activeIndex = activeMedia.findIndex((m) => m.id === clickedItem.id);
    if (activeIndex !== -1) setSelectedIndex(activeIndex);
  };

  const modalImages = activeMedia.filter(item => item.type === 'image');

  const renderItem = (item: Attachment, index: number, isLarge = false) => {
    const isFailed = failedUrls.has(item.url) || item.isDeleted;

    return (
      <div 
        key={item.id}
        className={cn(
          "relative overflow-hidden group bg-neutral-200 dark:bg-neutral-800",
          isLarge ? "col-span-2 aspect-video" : "aspect-square"
        )}
      >
        {isFailed ? (
          <MediaPlaceholder reason={item.isDeleted ? 'deleted' : 'error'} />
        ) : (
          <button
            type="button"
            className="w-full h-full relative block"
            onClick={() => handleMediaClick(index)}
          >
            {item.type === 'video' ? (
              <div className="w-full h-full relative bg-black">
                <video src={item.url} className="w-full h-full object-cover text-white">
                  <track kind="captions" />
                </video>
                <div className="absolute inset-0 flex items-center justify-center bg-black/20 group-hover:bg-black/40 transition-colors">
                  <PlayCircle className="w-10 h-10 text-white/80" />
                </div>
              </div>
            ) : (
              <Image
                src={item.url}
                alt=""
                fill
                className="object-cover group-hover:scale-105 transition-transform duration-500"
                unoptimized
                onError={() => handleImageError(item.url)}
              />
            )}
            {index === 3 && count > 4 && (
              <div className="absolute inset-0 bg-black/60 flex items-center justify-center text-white z-10">
                <span className="text-xl font-bold">+{count - 4}</span>
              </div>
            )}
          </button>
        )}
      </div>
    );
  };

  return (
    <>
      <div className={cn(
        "grid gap-1 overflow-hidden rounded-2xl w-[400px] max-w-full max-sm:w-[280px]",
        count === 1 ? "grid-cols-1" : "grid-cols-2"
      )}>
        {count === 1 && (
          <div 
            className="relative overflow-hidden bg-neutral-200 dark:bg-neutral-800 rounded-2xl"
            style={{ 
              aspectRatio: items[0].metadata?.width && items[0].metadata?.height 
                ? `${items[0].metadata.width}/${items[0].metadata.height}` 
                : '16/10',
              maxHeight: '500px'
            }}
          >
             {items[0].isDeleted || failedUrls.has(items[0].url) ? (
               <MediaPlaceholder reason="error" />
             ) : (
               <button type="button" onClick={() => handleMediaClick(0)} className="w-full h-full relative block">
                 {items[0].type === 'video' ? (
                    <video src={items[0].url} className="w-full h-full object-contain bg-black">
                      <track kind="captions" />
                    </video>
                 ) : (
                    <Image 
                      src={items[0].url} 
                      alt="" 
                      fill 
                      className="object-contain bg-neutral-900/10" 
                      unoptimized 
                      onError={() => handleImageError(items[0].url)}
                    />
                 )}
               </button>
             )}
          </div>
        )}

        {count === 2 && items.map((item, i) => renderItem(item, i))}
        
        {count === 3 && (
          <>
            {renderItem(items[0], 0, true)}
            {renderItem(items[1], 1)}
            {renderItem(items[2], 2)}
          </>
        )}

        {count >= 4 && items.slice(0, 4).map((item, i) => renderItem(item, i))}
      </div>

      <ImageModal
        isOpen={selectedIndex !== null}
        images={modalImages}
        initialIndex={selectedIndex ?? 0}
        onClose={() => setSelectedIndex(null)}
      />
    </>
  );
}
</file>

<file path="src/app/page.tsx">
import { redirect } from 'next/navigation';
import { createClient } from '@/lib/supabase/server';

export default async function Home() {
  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (user) {
    redirect('/chat?tab=chats');
  }

  // If not authenticated, show sign-in page
  return (
    <div className="flex flex-col items-center justify-center min-h-[calc(100vh-80px)] text-center px-4">
      <h1 className="text-4xl font-bold text-white mb-4">Welcome to Trace</h1>
      <p className="text-gray-400 mb-8">Sign in to start chatting</p>

      <form
        action={async () => {
          'use server';
          const supabase = await createClient();
          const { data, error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
              redirectTo: `${process.env.NEXT_PUBLIC_SITE_URL}/auth/callback`,
            },
          });

          if (error) {
            console.error('Sign in error:', error);
            return;
          }

          if (data.url) {
            redirect(data.url);
          }
        }}
      >
        <button
          type="submit"
          className="flex items-center gap-3 px-6 py-3 bg-white text-gray-900 rounded-xl font-semibold hover:bg-gray-100 transition-colors shadow-lg"
        >
          <svg className="w-5 h-5" viewBox="0 0 24 24">
            <title>Google Logo</title>
            <path
              fill="currentColor"
              d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
            />
            <path
              fill="currentColor"
              d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
            />
            <path
              fill="currentColor"
              d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
            />
            <path
              fill="currentColor"
              d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
            />
          </svg>
          Sign in with Google
        </button>
      </form>
    </div>
  );
}
</file>

<file path="src/components/layout/Navbar.tsx">
import { Menu } from 'lucide-react';
import Image from 'next/image';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { SignInButton, SignOutButton } from '../auth/auth-buttons';
import Logo from '../ui/Logo';

interface NavbarProps {
  user?: {
    name?: string | null;
    email?: string | null;
    image?: string | null;
  } | null;
  onMenuClick?: () => void;
}

export default function Navbar({ user, onMenuClick }: NavbarProps) {
  return (
    <nav className="fixed top-0 left-0 right-0 z-[800] flex items-center justify-between px-4 sm:px-6 py-4 border-b border-white/10 bg-black/50 backdrop-blur-lg">
      {/* Left: Menu & Logo */}
      <div className="flex items-center gap-2 sm:gap-4">
        {user && (
          <button
            type="button"
            onClick={onMenuClick}
            className="p-2 -ml-2 hover:bg-white/10 rounded-lg text-gray-400 hover:text-white transition-colors lg:hidden"
            aria-label="Toggle Menu"
          >
            <Menu className="w-5 h-5" />
          </button>
        )}
        <Logo />
      </div>

      {/* Right: Auth */}
      <div className="flex items-center gap-4">
        {user ? (
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <button
                type="button"
                className="flex items-center gap-3 hover:opacity-80 transition-opacity focus:outline-none group"
              >
                <span className="hidden sm:block text-sm font-medium text-gray-200 group-hover:text-white transition-colors">
                  {user.name}
                </span>
                <div className="relative w-9 h-9 rounded-full overflow-hidden border border-white/20 group-hover:border-white/40 transition-all">
                  <Image
                    src={user.image || '/default-avatar.png'}
                    alt="avatar"
                    fill
                    className="object-cover"
                  />
                </div>
              </button>
            </DropdownMenuTrigger>

            <DropdownMenuContent align="end" className="w-56">
              <div className="px-3 py-2.5">
                <p className="text-[10px] uppercase tracking-wider text-gray-500 font-bold">
                  –ê–∫—Ç–∏–≤–Ω–∏–π –∞–∫–∫–∞—É–Ω—Ç
                </p>
                <p className="text-sm font-medium text-white truncate mt-0.5">{user.email}</p>
              </div>

              <DropdownMenuSeparator />

              {/* –¢—É—Ç –º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç–≤—ñ–π SignOutButton, –∞–ª–µ —Å—Ç–∏–ª—ñ–∑—É—î–º–æ –π–æ–≥–æ –ø—ñ–¥ –ø—É–Ω–∫—Ç –º–µ–Ω—é */}
              <div className="p-0">
                <SignOutButton />
              </div>
            </DropdownMenuContent>
          </DropdownMenu>
        ) : (
          <SignInButton />
        )}
      </div>
    </nav>
  );
}
</file>

<file path="src/components/sidebar/SidebarShell.tsx">
'use client';

import { MessageSquare, Users } from 'lucide-react';
import { useRouter, useSearchParams } from 'next/navigation';
import { useEffect } from 'react';
import ChatList from './ChatList';
import ContactsList from './ContactsList';
import SearchInput from './SearchInput';

export default function SidebarShell() {
  const router = useRouter();
  const searchParams = useSearchParams();



  const tab = searchParams.get('tab') || 'chats';
  const query = searchParams.get('q') || '';

  useEffect(() => {
    if (!searchParams.get('tab')) {
      const params = new URLSearchParams(searchParams.toString());
      params.set('tab', 'chats');
      router.replace(`?${params.toString()}`, { scroll: false });
    }
  }, [searchParams, router]);

  const setTab = (newTab: 'chats' | 'contacts') => {
    const params = new URLSearchParams(searchParams.toString());
    params.set('tab', newTab);
    if (newTab === 'chats') {
      params.delete('q');
    }
    router.push(`?${params.toString()}`, { scroll: false });
  };

  return (
    <aside
      className="h-screen lg:h-[calc(100vh-64px)] w-80 backdrop-blur-md bg-black/40 border-r border-white/10 flex flex-col z-40 shrink-0 overflow-hidden"
      style={{ willChange: 'transform' }}
    >
      {/* Header */}
      <div className="pt-6 pb-2 lg:pt-8 lg:pb-4">
        {/* View Toggle */}
        <div className="px-4 mb-6">
          <div className="flex p-1 bg-white/5 rounded-xl border border-white/10">
            <button
              type="button"
              onClick={() => setTab('chats')}
              className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-xs font-bold transition-all duration-300 ${
                tab === 'chats'
                  ? 'bg-white text-black shadow-lg shadow-white/5'
                  : 'text-gray-400 hover:text-white'
              }`}
            >
              <MessageSquare className="w-3.5 h-3.5" />
              –î—ñ–∞–ª–æ–≥–∏
            </button>
            <button
              type="button"
              onClick={() => setTab('contacts')}
              className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-xs font-bold transition-all duration-300 ${
                tab === 'contacts'
                  ? 'bg-white text-black shadow-lg shadow-white/5'
                  : 'text-gray-400 hover:text-white'
              }`}
            >
              <Users className="w-3.5 h-3.5" />
              –ö–æ–Ω—Ç–∞–∫—Ç–∏
            </button>
          </div>
        </div>

        {/* Contacts Specific UI */}
        {tab === 'contacts' && <SearchInput />}

        {/* Chats Specific UI */}
        {tab === 'chats' && <div className="h-4" />}
      </div>

      {/* Lists */}
      <div className="flex-1 flex flex-col min-h-0 py-2 overflow-hidden">
        {tab === 'chats' ? (
          <>
            <div className="px-6 mb-2">
              <h2 className="text-[10px] font-bold uppercase tracking-widest text-gray-500 letter-spacing-wide">
                –í–∞—à—ñ –¥—ñ–∞–ª–æ–≥–∏
              </h2>
            </div>
            <ChatList />
          </>
        ) : (
          <ContactsList query={query} />
        )}
      </div>
    </aside>
  );
}

SidebarShell.whyDidYouRender = true;
</file>

<file path="src/middleware.ts">
import { createServerClient, type CookieOptions } from '@supabase/ssr';
import { NextResponse, type NextRequest } from 'next/server';

export async function middleware(request: NextRequest) {
  let response = NextResponse.next({
    request: { headers: request.headers },
  });

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return request.cookies.get(name)?.value;
        },
        set(name: string, value: string, options: CookieOptions) {
          request.cookies.set({ name, value, ...options });
          response = NextResponse.next({
            request: { headers: request.headers },
          });
          response.cookies.set({ name, value, ...options });
        },
        remove(name: string, options: CookieOptions) {
          request.cookies.set({ name, value: '', ...options });
          response = NextResponse.next({
            request: { headers: request.headers },
          });
          response.cookies.set({ name, value: '', ...options });
        },
      },
    }
  );

  // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ try/catch, —â–æ–± Middleware –Ω–µ "–ø–∞–¥–∞–≤", —è–∫—â–æ –∑ —Å–µ—Å—ñ—î—é —â–æ—Å—å –Ω–µ —Ç–∞–∫
  try {
    const { data: { session } } = await supabase.auth.getSession();
    const user = session?.user ?? null;

    const url = request.nextUrl.clone();
    const path = url.pathname;

    const isPublicPage = path === '/' || path.startsWith('/auth');

    // –Ø–∫—â–æ —é–∑–µ—Ä–∞ –Ω–µ–º–∞—î —ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –∑–∞—Ö–∏—â–µ–Ω–∞ ‚Äî –Ω–∞ –≥–æ–ª–æ–≤–Ω—É
    if (!user && !isPublicPage) {
      url.pathname = '/';
      return NextResponse.redirect(url);
    }

    // –Ø–∫—â–æ —é–∑–µ—Ä –≤–∂–µ —î —ñ –≤—ñ–Ω –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –ª–æ–≥—ñ–Ω—É ‚Äî –≤ —á–∞—Ç
    if (user && isPublicPage) {
      url.pathname = '/chat';
      return NextResponse.redirect(url);
    }

  } catch (e) {
    // –Ø–∫—â–æ —Å—Ç–∞–ª–∞—Å—è –±—É–¥—å-—è–∫–∞ –ø–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó (—Å–µ—Å—ñ—è –±—ñ—Ç–∞ —Ç–æ—â–æ)
    // –ü—Ä–æ—Å—Ç–æ –∫–∏–¥–∞—î–º–æ –Ω–∞ –≥–æ–ª–æ–≤–Ω—É, —è–∫—â–æ –º–∏ –Ω–µ –Ω–∞ –ø—É–±–ª—ñ—á–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ
    const url = request.nextUrl.clone();
    if (url.pathname !== '/' && !url.pathname.startsWith('/auth')) {
      url.pathname = '/';
      return NextResponse.redirect(url);
    }
  }

  return response;
}

export const config = {
  matcher: [
    '/((?!api|_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
};
</file>

<file path="src/app/layout.tsx">
import '@/wdyr';
import type { Metadata } from 'next';
import { Geist, Geist_Mono } from 'next/font/google';
import AuthProvider from '@/components/auth/AuthProvider';
import ChatLayoutWrapper from '@/components/layout/ChatLayoutWrapper';
import Providers from '@/components/Providers';
import Sidebar from '@/components/sidebar/Sidebar';
import { createClient } from '@/lib/supabase/server';
import './globals.css';

const geistSans = Geist({
  variable: '--font-geist-sans',
  subsets: ['latin'],
});

const geistMono = Geist_Mono({
  variable: '--font-geist-mono',
  subsets: ['latin'],
});

export const metadata: Metadata = {
  title: 'Trace',
  description: 'A modern messaging app',
};

export default async function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased bg-black text-white`}
      >
        <Providers>
          <AuthProvider>
            <ChatLayoutWrapper
              user={
                user
                  ? {
                      id: user.id,
                      email: user.email,
                      name:
                        user.user_metadata.full_name ||
                        user.user_metadata.name ||
                        user.email?.split('@')[0],
                      image: user.user_metadata.avatar_url || user.user_metadata.picture,
                    }
                  : null
              }
              sidebar={user ? <Sidebar /> : null}
            >
              {children}
            </ChatLayoutWrapper>
          </AuthProvider>
        </Providers>
      </body>
    </html>
  );
}
</file>

<file path="src/components/sidebar/ContactsList.tsx">
'use client';

import { Loader2, User as UserIcon } from 'lucide-react';
import { useState } from 'react';
import { useSearchUsers } from '@/hooks/useChatHooks';
import { ContactItem } from './ContactItem';

interface ContactsListProps {
  query: string;
}

export default function ContactsList({ query }: ContactsListProps) {
  const { data: users, isLoading } = useSearchUsers(query);
  // const { onlineUsers } = usePresence(); // REMOVED

  // –°—Ç–∞–Ω –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è —á–∏ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –∑–∞—Ä–∞–∑ —è–∫–∏–π—Å—å —á–∞—Ç
  const [isCreatingChat, setIsCreatingChat] = useState(false);

  if (isLoading) {
    return (
      <div className="flex-1 flex items-center justify-center p-8 text-gray-500 text-sm">
        <Loader2 className="w-4 h-4 animate-spin mr-2" />
        –®—É–∫–∞—î–º–æ...
      </div>
    );
  }

  if (query && query.length < 2) {
    return (
      <div className="flex flex-col items-center justify-center p-8 text-center mt-10">
        <div className="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center mb-3">
          <UserIcon className="w-6 h-6 text-gray-400" />
        </div>
        <p className="text-sm text-gray-500">–í–≤–µ–¥—ñ—Ç—å –ø—Ä–∏–Ω–∞–π–º–Ω—ñ 2 —Å–∏–º–≤–æ–ª–∏ –¥–ª—è –ø–æ—à—É–∫—É</p>
      </div>
    );
  }

  if (!users || users.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center p-8 text-center mt-10">
        <div className="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center mb-3">
          <UserIcon className="w-6 h-6 text-gray-600" />
        </div>
        <p className="text-sm text-gray-500">
          {query ? '–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ' : '–£ –≤–∞—Å —â–µ –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –¥—ñ–∞–ª–æ–≥—ñ–≤'}
        </p>
      </div>
    );
  }

  return (
    <div className="flex-1 overflow-y-auto px-2 space-y-1">
      <div className="px-4 mb-2">
        <h2 className="text-[10px] font-bold uppercase tracking-widest text-gray-400">
          {query ? '–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–æ—à—É–∫—É' : '–í–∞—à—ñ –∫–æ–Ω—Ç–∞–∫—Ç–∏'}
        </h2>
      </div>
      {users.map((user) => (
        <ContactItem
          key={user.id}
          user={user}
          disabled={isCreatingChat}
          onActionStart={() => setIsCreatingChat(true)}
          onActionEnd={() => setIsCreatingChat(false)}
        />
      ))}
    </div>
  );
}

ContactsList.whyDidYouRender = true;
</file>

<file path="src/components/chat/ChatInput.tsx">
'use client';

import { type InfiniteData, useQueryClient } from '@tanstack/react-query';
import { Paperclip, Send } from 'lucide-react';
import { useEffect, useMemo, useRef, useState } from 'react';
import { useAttachment } from '@/hooks/useAttachment';
import { useSendMessage, useEditMessage } from '@/hooks/useChatHooks';
import { cn } from '@/lib/utils';
import type { Message } from '@/types';
import { useSupabaseAuth } from '@/components/SupabaseAuthProvider';
import { ComposerAddons } from './ComposerAddons';

interface ChatInputProps {
  chatId: string;
  setTyping: (typing: boolean) => void;
  replyToId?: string | null;
  onReplyCancel?: () => void;
  editingMessage?: Message | null;
  onEditCancel?: () => void;
  onMessageSent?: () => void;
}

export default function ChatInput({
  chatId,
  setTyping,
  replyToId,
  onReplyCancel,
  editingMessage, // Added editingMessage prop
  onEditCancel, // Added onEditCancel prop
  onMessageSent,
}: ChatInputProps) {
  const { user } = useSupabaseAuth(); // Ensure user is available if needed, though useSendMessage handles it
  const [content, setContent] = useState('');
  const { attachments, uploadFile, removeAttachment, clearAttachments, isUploading } =
    useAttachment(chatId);
  
  // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–∏–π —Ö—É–∫ –∑ Optimistic UI
  const sendMessage = useSendMessage(chatId);
  const editMessage = useEditMessage(chatId);

  // Update content when editingMessage changes
  useEffect(() => {
    if (editingMessage) {
      setContent(editingMessage.content || '');
      if (textareaRef.current) {
        textareaRef.current.focus();
      }
    } else {
      setContent('');
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [editingMessage]);

  const textareaRef = useRef<HTMLTextAreaElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const queryClient = useQueryClient();

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –≤–∏—Å–æ—Ç–∞ textarea
  useEffect(() => {
    const textarea = textareaRef.current;
    content
    if (textarea) {
      textarea.style.height = 'inherit';
      const scrollHeight = textarea.scrollHeight;
      textarea.style.height = `${Math.min(scrollHeight, 200)}px`;
    }
  }, [content]);

  // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è —Ä–µ–ø–ª–∞—é –≤ –∫–µ—à—ñ
  const replyToMessage = useMemo(() => {
    if (!replyToId) return null;

    // –ß—ñ—Ç–∫–æ –≤–∫–∞–∑—É—î–º–æ —Ç–∏–ø –¥–∞–Ω–∏—Ö —É –∫–µ—à—ñ: InfiniteData, —â–æ –º—ñ—Å—Ç–∏—Ç—å –º–∞—Å–∏–≤–∏ Message
    const data = queryClient.getQueryData<InfiniteData<Message[]>>([
      'messages',
      chatId,
    ]);

    if (!data?.pages) return null;

    // .flat() –∑–±–∏—Ä–∞—î –≤—Å—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ —É—Å—ñ—Ö —Å—Ç–æ—Ä—ñ–Ω–æ–∫ –≤ –æ–¥–∏–Ω –º–∞—Å–∏–≤
    // .find() —à—É–∫–∞—î —Ç–æ–π —Å–∞–º–∏–π –æ–±'—î–∫—Ç, —è–∫–∏–π —á–µ–∫–∞—î ComposerAddons
    return data.pages.flat().find((m) => m.id === replyToId) || null;
  }, [replyToId, chatId, queryClient]);

  const handleSubmit = async (e?: React.FormEvent) => {
    e?.preventDefault();
    const trimmed = content.trim();
    const hasAttachments = attachments.length > 0;

    // –í–∞–ª—ñ–¥–∞—Ü—ñ—è
    if ((!trimmed && !hasAttachments) || isUploading) return;

    // 1. –û—á–∏—â—É—î–º–æ UI –º–∏—Ç—Ç—î–≤–æ (–¥–ª—è –≤—ñ–¥—á—É—Ç—Ç—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ)
    setContent('');
    setTyping(false);
    if (onReplyCancel) onReplyCancel();

    const attachmentsBackup = attachments
      .filter((a) => a.url && !a.error && !a.uploading)
      .map(({ id, type, url, metadata }) => ({ id, type, url, metadata }));
    
    clearAttachments();

    try {
      if (editingMessage) {
        // –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø
        await editMessage.mutateAsync({
          messageId: editingMessage.id,
          content: trimmed,
        });
        if (onEditCancel) onEditCancel();
      } else {
        // –í–Ü–î–ü–†–ê–í–ö–ê –ù–û–í–û–ì–û
        await sendMessage.mutateAsync({
          content: trimmed,
          replyToId: replyToId || undefined,
          attachments: attachmentsBackup,
        });
      }
      
      if (onMessageSent) onMessageSent();
    } catch (error) {
      // –Ø–∫—â–æ –≤–ø–∞–ª–æ ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ —Ç–µ–∫—Å—Ç –Ω–∞–∑–∞–¥, —â–æ–± —é–∑–µ—Ä –Ω–µ –≤—Ç—Ä–∞—Ç–∏–≤ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
      console.error('Failed to process:', error);
      setContent(trimmed);
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSubmit();
    }
  };

  useEffect(() => {
    setTyping(content.length > 0);
  }, [content, setTyping]);

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (files) {
      Array.from(files).forEach(uploadFile);
    }
    e.target.value = '';
  };

  const isButtonVisible = content.trim().length > 0 || attachments.length > 0;

  return (
    <div className="flex flex-col relative" style={{ willChange: 'transform' }}>
      <ComposerAddons
        attachments={attachments}
        onAttachmentRemove={removeAttachment}
        replyTo={replyToMessage}
        onReplyCancel={onReplyCancel}
        editingMessage={editingMessage || null}
        onEditCancel={onEditCancel}
        otherParticipantName="–°–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫" 
      />

      <form onSubmit={handleSubmit} className="p-3 sm:p-4 flex gap-2 items-end">
        <input
          type="file"
          ref={fileInputRef}
          onChange={handleFileChange}
          multiple
          className="hidden"
          accept="image/*,.pdf,.docx"
        />

        <button
          type="button"
          onClick={() => fileInputRef.current?.click()}
          className="p-3 mb-0.5 rounded-full text-gray-400 hover:bg-white/10 hover:text-white transition-all"
          title="–î–æ–¥–∞—Ç–∏ —Ñ–∞–π–ª"
        >
          <Paperclip size={20} />
        </button>

        <div className="flex-1 relative">
          <textarea
            ref={textareaRef}
            rows={1}
            value={content}
            onChange={(e) => setContent(e.target.value)}
            onKeyDown={handleKeyDown}
            placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."
            className={cn(
              'w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-2.5 text-sm text-white placeholder:text-gray-500',
              'focus:outline-none focus:border-blue-500/50 transition-all duration-300',
              'resize-none overflow-y-auto leading-relaxed',
            )}
            style={{ minHeight: '44px' }}
          />
        </div>

        {isButtonVisible && (
          <button
            type="submit"
            disabled={isUploading || (!content.trim() && attachments.length === 0)}
            className="p-3 mb-0.5 rounded-full bg-blue-600 text-white hover:bg-blue-500 disabled:opacity-50 transition-all shadow-lg shadow-blue-600/20 shrink-0"
          >
            <Send size={20} className={isUploading ? 'animate-pulse' : ''} />
          </button>
        )}
      </form>
    </div>
  );
}
</file>

<file path="src/types/index.ts">
export interface User {
  id: string;
  name?: string | null;
  email: string;
  image?: string | null;
  lastSeen?: Date | null;
}

export interface Attachment {
  id: string;
  type: 'image' | 'video' | 'file';
  url: string;
  isDeleted?: boolean;
  metadata: {
    name: string;
    size: number;
    width?: number;
    height?: number;
    expired?: boolean;
  };
}

export interface Message {
  id: string;
  chatId: string;
  senderId: string;
  content: string;
  attachments: Attachment[];
  createdAt: string;
  updatedAt?: string | null;
  replyToId?: string | null;
  replyDetails?: {
    id: string;
    sender: { name?: string | null };
    content: string;
    senderId?: string;
    attachments?: Attachment[];
  } | null;
  replyTo?: Message;
  sender?: User | null;
  isOptimistic?: boolean;
}

export interface Chat {
  id: string;
  userId: string;
  recipientId?: string | null;
  userLastReadId?: string | null;
  recipientLastReadId?: string | null;
  userLastRead?: { id: string; createdAt: string } | null;
  recipientLastRead?: { id: string; createdAt: string } | null;
  title: string;
  createdAt: string;
}

export interface FullChat extends Chat {
  messages: Message[];
  participants: User[];
  recipient?: User | null;
  user?: User | null;
}
</file>

<file path="src/actions/chat-actions.ts">
'use server';

import { and, eq, or } from 'drizzle-orm';
import { revalidatePath } from 'next/cache';
import { redirect } from 'next/navigation';
import { db } from '@/db';
import { chats, users } from '@/db/schema';
import { createClient } from '@/lib/supabase/server';

/**
 * –û—Ç—Ä–∏–º—É—î –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —ñ–∑ Supabase SSR —Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î –π–æ–≥–æ –∑ –Ω–∞—à–æ—é –ë–î Drizzle.
 */
async function getCurrentUser() {
  try {
    const supabase = await createClient();

    // 1. –°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º—É—î–º–æ —Å–µ—Å—ñ—é (getSession –Ω–∞–¥—ñ–π–Ω—ñ—à–∞ –¥–ª—è –ø–æ—á–∞—Ç–∫–æ–≤–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤ SSR)
    const {
      data: { session },
      error: sessionError,
    } = await supabase.auth.getSession();

    if (sessionError || !session?.user) {
      console.log('No active session found');
      return null;
    }

    // 2. –î–ª—è –±–µ–∑–ø–µ–∫–∏ –æ—Ç—Ä–∏–º—É—î–º–æ —Å–≤—ñ–∂—ñ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    const user = session.user;

    // –ë–µ–∑–ø–µ—á–Ω–µ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –º–µ—Ç–∞–¥–∞–Ω–∏—Ö (–¥–æ–¥–∞–≤ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏)
    const userName =
      user.user_metadata?.full_name ||
      user.user_metadata?.name ||
      user.email?.split('@')[0] ||
      '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á';

    const userImage = user.user_metadata?.avatar_url || user.user_metadata?.picture || null;

    // 3. –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ Drizzle
    const [dbUser] = await db
      .insert(users)
      .values({
        id: user.id,
        email: user.email ?? '',
        name: userName,
        image: userImage,
        lastSeen: new Date(),
      })
      .onConflictDoUpdate({
        target: users.id,
        set: {
          name: userName,
          image: userImage,
          lastSeen: new Date(),
        },
      })
      .returning();

    return dbUser;
  } catch (err) {
    // –Ø–∫—â–æ –ø—Ä–∏–ª–µ—Ç–∏—Ç—å —Ç–æ–π —Å–∞–º–∏–π TypeError –ø—Ä–æ "string", –º–∏ –π–æ–≥–æ –∑–ª–æ–≤–∏–º–æ —Ç—É—Ç
    // —ñ –Ω–µ –¥–∞–º–æ –≤—Å—å–æ–º—É —Å–µ—Ä–≤–µ—Ä—É "–≤–ø–∞—Å—Ç–∏"
    console.error('Critical error in getCurrentUser:', err);
    return null;
  }
}

export async function getOrCreateChatAction(targetUserId: string) {
  const user = await getCurrentUser();
  if (!user?.id) throw new Error('Unauthorized');

  const myId = user.id;
  let targetChatId: string | null = null;

  try {
    const existingChat = await db.query.chats.findFirst({
      where: or(
        and(eq(chats.userId, myId), eq(chats.recipientId, targetUserId)),
        and(eq(chats.userId, targetUserId), eq(chats.recipientId, myId)),
      ),
    });

    if (existingChat) {
      targetChatId = existingChat.id;
    } else {
      const targetUser = await db.query.users.findFirst({
        where: eq(users.id, targetUserId),
      });

      const [newChat] = await db
        .insert(chats)
        .values({
          userId: myId,
          recipientId: targetUserId,
          title: targetUser?.name || '–ü—Ä–∏–≤–∞—Ç–Ω–∏–π —á–∞—Ç',
        })
        .returning();

      targetChatId = newChat.id;
    }
  } catch (error) {
    console.error('Error in getOrCreateChatAction:', error);
    // –ú–∏ –Ω–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º–æ –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ, —â–æ–± –Ω–µ –≤–∏—Å—ñ–ª–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –±–µ–∑ –ø—Ä–∏—á–∏–Ω–∏
    throw new Error('Failed to create or find chat');
  }

  // –†–µ–¥–∏—Ä–µ–∫—Ç –º–∞—î –±—É—Ç–∏ –≤ —Å–∞–º–æ–º—É –∫—ñ–Ω—Ü—ñ, –ø–æ–∑–∞ try/catch
  if (targetChatId) {
    revalidatePath('/chat');
    redirect(`/chat/${targetChatId}`);
  }
}

// All other actions have been removed as part of the Client-First Supabase Architecture refactor.
</file>

<file path="src/components/chat/MessageBubble.tsx">
import Linkify from 'linkify-react';
import { Check, CheckCheck, Clock, Download, FileIcon, Reply, Trash2 } from 'lucide-react';
import { memo } from 'react';
import { AnimatePresence, motion } from 'framer-motion';

import {
  ContextMenu,
  ContextMenuContent,
  ContextMenuItem,
  ContextMenuSeparator,
  ContextMenuTrigger,
} from '@/components/ui/context-menu';
import { formatMessageDate } from '@/lib/date-utils';
import { cn } from '@/lib/utils';
import type { Message } from '@/types';
import { MessageMediaGrid } from './MessageMediaGrid';

interface MessageBubbleProps {
  message: Message;
  currentUserId: string | undefined;
  isRead?: boolean;
  onReply: (message: Message) => void;
  onEdit: (message: Message) => void;
  onDelete: (messageId: string) => void;
  onScrollToMessage: (messageId: string) => void;
  isHighlighed?: boolean;
  otherParticipantName?: string;
}

export const MessageBubble = memo(
  ({
    message,
    currentUserId,
    isRead,
    onReply,
    onEdit,
    onDelete,
    onScrollToMessage,
    isHighlighed,
    otherParticipantName,
  }: MessageBubbleProps) => {
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –æ–±–∏–¥–≤–∞ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –Ω–∞–ø–∏—Å–∞–Ω–Ω—è ID –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑ –ë–î —Ç–∞ –æ–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–∏–º –æ–±'—î–∫—Ç–æ–º
    const senderId = message.senderId || message.sender_id;
    const isMe = senderId === currentUserId;

    const mediaAttachments = message.attachments?.filter((a) => a.type === 'image' || a.type === 'video') || [];
    const fileAttachments = message.attachments?.filter((a) => a.type === 'file') || [];

    return (
      <motion.div
        id={`message-${message.id}`}
        data-highlighted={isHighlighed}
        layout
        transition={{ duration: 0.3, ease: [0.4, 0, 0.2, 1] }}
        className={cn(
          'flex w-full mb-3 px-2.5 sm:px-4 transition-colors duration-500',
          isMe ? 'justify-end' : 'justify-start',
          isHighlighed ? 'bg-white/10 py-2 rounded-lg' : '',
        )}
      >
        <ContextMenu>
          <ContextMenuTrigger className="max-w-[88%] sm:max-w-[70%] lg:max-w-[60%] min-w-0 block">
            <div className={cn('flex flex-col min-w-0 w-full', isMe ? 'items-end' : 'items-start')}>
              <div
                className={cn(
                  'relative px-4 py-2.5 shadow-2xl border border-white/10 min-w-0 max-w-full flex flex-col',
                  isMe
                    ? 'bg-blue-600 text-white rounded-2xl rounded-tr-sm'
                    : 'bg-neutral-900/80 backdrop-blur-md text-gray-100 rounded-2xl rounded-tl-sm',
                  mediaAttachments.length > 0 && !message.content ? 'p-1.5 bg-neutral-900/50' : '',
                )}
                style={{ willChange: 'transform' }}
              >
                {/* Reply Context */}
                {(() => {
                  const rId = message.replyToId || message.reply_to_id;
                  if (!rId) return null;

                  const reply = message.replyDetails || message.replyTo;
                  if (!reply) return null;

                  const replySenderId =
                    'senderId' in reply
                      ? reply.senderId
                      : 'sender_id' in reply
                        ? (reply as { sender_id: string }).sender_id
                        : undefined;

                  const senderName =
                    reply.sender?.name || (replySenderId === currentUserId ? 'You' : otherParticipantName);

                  return (
                    <button
                      type="button"
                      onClick={(e) => {
                        e.stopPropagation();
                        onScrollToMessage(reply.id);
                      }}
                      className="mb-2 w-full flex flex-col items-start px-2 py-1 rounded-md bg-black/20 border-l-2 border-blue-400/50 cursor-pointer hover:bg-black/40 transition-colors text-[11px] text-left overflow-hidden min-w-0"
                    >
                      <span className="font-bold text-blue-300 mb-0.5 truncate w-full block">
                        {senderName || 'Unknown'}
                      </span>
                      <span className="text-white/60 line-clamp-1 italic">
                        {reply.content || (reply.attachments?.length ? 'üìé Attachment' : '...')}
                      </span>
                    </button>
                  );
                })()}

                {mediaAttachments.length > 0 && (
                  <div className="rounded-xl overflow-hidden mb-1 w-full">
                    <MessageMediaGrid items={mediaAttachments} />
                  </div>
                )}

                {message.content && (
                  <div className="text-[15px] leading-relaxed whitespace-pre-wrap break-all sm:break-words block w-full max-w-full overflow-hidden min-w-0">
                    <Linkify
                      options={{
                        target: '_blank',
                        rel: 'noopener noreferrer',
                        className:
                          'text-blue-400 hover:text-blue-300 underline underline-offset-4 transition-colors cursor-pointer',
                      }}
                    >
                      {message.content}
                    </Linkify>
                  </div>
                )}

                {fileAttachments.length > 0 && (
                  <div className="mt-2 space-y-1.5 w-full min-w-0">
                    {fileAttachments.map((file) => (
                      <a
                        key={file.id}
                        href={file.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="flex items-center gap-3 p-2.5 rounded-xl bg-black/30 hover:bg-black/40 transition-all border border-white/5 w-full min-w-0 group"
                      >
                        <div className="p-2 bg-blue-500/10 group-hover:bg-blue-500/20 rounded-lg shrink-0 transition-colors">
                          <FileIcon className="w-5 h-5 text-blue-400" />
                        </div>
                        <div className="flex-1 min-w-0 overflow-hidden">
                          <p className="text-sm font-medium text-blue-100 truncate w-full block">
                            {file.metadata?.name || 'File'}
                          </p>
                          <p className="text-[10px] text-white/30 uppercase tracking-wider mt-0.5">
                            {file.metadata?.size
                              ? `${(file.metadata.size / 1024 / 1024).toFixed(2)} MB`
                              : 'Size unknown'}
                          </p>
                        </div>
                        <Download className="w-4 h-4 text-white/20 group-hover:text-white/50 shrink-0 transition-colors" />
                      </a>
                    ))}
                  </div>
                )}

                <div
                  className={cn(
                    'flex items-center justify-end gap-1 mt-1.5 select-none w-full',
                    isMe ? 'text-blue-100/50' : 'text-white/40',
                  )}
                >
                  <span className="text-[9px] font-medium">{formatMessageDate(message.createdAt)}</span>
                  {message.updated_at &&
                    new Date(message.updated_at).getTime() - new Date(message.createdAt).getTime() > 1000 && (
                      <span className="text-[9px] italic opacity-70 ml-1">(–≤—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ)</span>
                    )}

                  {isMe && (
                    <div className="flex items-center ml-1">
                      <AnimatePresence mode="wait">
                        {isRead ? (
                          <motion.div
                            key="read"
                            initial={{ opacity: 0, scale: 0.5, rotate: -15 }}
                            animate={{ opacity: 1, scale: 1, rotate: 0 }}
                            exit={{ opacity: 0, scale: 0.5 }}
                            transition={{
                              type: 'spring',
                              stiffness: 500,
                              damping: 30,
                            }}
                          >
                            <CheckCheck className="w-3 h-3 text-blue-400" strokeWidth={3} />
                          </motion.div>
                        ) : (
                          <motion.div
                            key="sent"
                            initial={{ opacity: 0, scale: 0.5 }}
                            animate={{ opacity: 1, scale: 1 }}
                            exit={{ opacity: 0, scale: 0.5 }}
                            transition={{ duration: 0.15 }}
                          >
                            <Check className="w-3 h-3 text-blue-100/40" strokeWidth={3} />
                          </motion.div>
                        )}
                      </AnimatePresence>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </ContextMenuTrigger>

          <ContextMenuContent className="w-48">
            <ContextMenuItem onClick={() => onReply(message)} className="gap-2">
              <Reply className="w-4 h-4" /> Reply
            </ContextMenuItem>
            {isMe && (
              <>
                <ContextMenuSeparator />
                <ContextMenuItem onClick={() => onEdit(message)} className="gap-2">
                  <Clock className="w-4 h-4" /> Edit Message
                </ContextMenuItem>
                <ContextMenuItem
                  onClick={() => onDelete(message.id)}
                  className="gap-2 text-red-400 focus:text-red-400 focus:bg-red-500/10"
                >
                  <Trash2 className="w-4 h-4" /> Delete Message
                </ContextMenuItem>
              </>
            )}
          </ContextMenuContent>
        </ContextMenu>
      </motion.div>
    );
  },
  (prev, next) => {
    // 1. Core content identity
    if (prev.message.id !== next.message.id) return false;
    if (prev.message.updated_at !== next.message.updated_at) return false;
    if (prev.message.content !== next.message.content) return false;
    
    // 2. State & Context
    if (prev.isRead !== next.isRead) return false;
    if (prev.isHighlighed !== next.isHighlighed) return false;
    if (prev.currentUserId !== next.currentUserId) return false;
    if (prev.otherParticipantName !== next.otherParticipantName) return false;

    // 3. Stable callbacks
    if (prev.onReply !== next.onReply) return false;
    if (prev.onEdit !== next.onEdit) return false;
    if (prev.onDelete !== next.onDelete) return false;
    if (prev.onScrollToMessage !== next.onScrollToMessage) return false;

    return true;
  },
);

MessageBubble.displayName = 'MessageBubble';
</file>

<file path="src/components/sidebar/ChatList.tsx">
'use client';

import { MessageSquare, Trash2, User } from 'lucide-react';
import Image from 'next/image';
import Link from 'next/link';
import { useState } from 'react';
import { useSupabaseAuth } from '@/components/SupabaseAuthProvider';
import { ConfirmationDialog } from '@/components/ui/confirmation-dialog';
import {
  ContextMenu,
  ContextMenuContent,
  ContextMenuItem,
  ContextMenuSeparator,
  ContextMenuTrigger,
} from '@/components/ui/context-menu';
import { useChats, useDeleteChat } from '@/hooks/useChatHooks';
import { PresenceIndicator } from './PresenceIndicator';
import { formatRelativeTime } from '@/lib/date-utils';

export default function ChatList() {
  const { data: chats, isLoading } = useChats();
  const { user } = useSupabaseAuth();

  const deleteChat = useDeleteChat();
  // const { onlineUsers } = usePresence(); // REMOVED: Caused full re-renders
  const [chatToDelete, setChatToDelete] = useState<string | null>(null);

  const currentUserId = user?.id;

  const handleChatClick = () => {
    window.dispatchEvent(new CustomEvent('close-mobile-sidebar'));
  };

  if (isLoading)
    return <div className="p-8 text-center text-sm text-gray-500 mt-10">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>;
  if (!chats?.length)
    return <div className="p-8 text-center text-sm text-gray-500 mt-10">–ù–µ–º–∞—î –¥—ñ–∞–ª–æ–≥—ñ–≤</div>;

  return (
    <>
      <div className="flex-1 overflow-y-auto px-2 space-y-1">
        {chats.map((chat) => {
          const partner = chat.userId === currentUserId ? chat.recipient : chat.user;
          const chatDisplayTitle = partner?.name || chat.title || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á Trace';
          const partnerImage = partner?.image;

          const lastMessage = chat.messages?.[0];
          
          const userLastReadAt = chat.userLastRead?.createdAt;
          const isUnread = lastMessage && 
                          (lastMessage.senderId || lastMessage.sender_id) !== currentUserId && 
                          (!userLastReadAt || new Date(lastMessage.createdAt) > new Date(userLastReadAt));

          return (
            <ContextMenu key={chat.id}>
              <ContextMenuTrigger>
                <Link
                  href={`/chat/${chat.id}`}
                  onClick={handleChatClick}
                  className="flex items-center gap-3 px-3 py-3 rounded-xl hover:bg-white/5 transition-all border border-transparent hover:border-white/5 group"
                >
                  <div className="relative shrink-0">
                    <div className="w-10 h-10 rounded-full bg-gradient-to-br from-white/10 to-transparent flex items-center justify-center border border-white/10 overflow-hidden">
                      {partnerImage ? (
                        <div className="relative w-full h-full">
                          <Image
                            src={partnerImage}
                            alt={chatDisplayTitle}
                            fill
                            className="object-cover"
                          />
                        </div>
                      ) : (
                        <User className="w-5 h-5 text-gray-400 group-hover:text-white transition-colors" />
                      )}
                     </div>
                    {partner?.id && (
                      <PresenceIndicator 
                        userId={partner.id} 
                        className="absolute bottom-0 right-0 w-2.5 h-2.5" 
                      />
                    )}
                  </div>

                  <div className="flex-1 min-w-0">
                    <div className="flex items-center justify-between gap-2">
                      <p className="text-sm font-medium text-gray-200 truncate group-hover:text-white">
                        {chatDisplayTitle}
                      </p>

                      {lastMessage && (
                        <span className="text-[10px] text-gray-500 whitespace-nowrap">
                          {formatRelativeTime(lastMessage.createdAt)}
                        </span>
                      )}
                    </div>

                    <div className="flex items-center justify-between gap-2 mt-0.5">
                      <p className="text-[11px] text-gray-500 truncate flex-1">
                        {(lastMessage?.senderId || lastMessage?.sender_id) === currentUserId && '–í–∏: '}
                        {lastMessage?.content ||
                          (lastMessage?.attachments?.length ? 'üìé –ú–µ–¥—ñ–∞' : '–ù–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å')}
                      </p>
                      {isUnread && (
                        <div className="w-2 h-2 bg-blue-500 rounded-full shadow-[0_0_8px_rgba(59,130,246,0.5)] shrink-0" />
                      )}
                    </div>
                  </div>
                </Link>
              </ContextMenuTrigger>

              <ContextMenuContent className="z-[110]">
                <ContextMenuItem onClick={handleChatClick} className="gap-2">
                  <MessageSquare className="w-4 h-4" /> Open Chat
                </ContextMenuItem>
                <ContextMenuSeparator />
                <ContextMenuItem
                  onClick={() => setChatToDelete(chat.id)}
                  className="text-red-400 focus:text-red-400 focus:bg-red-500/10 gap-2"
                >
                  <Trash2 className="w-4 h-4" /> Delete Chat
                </ContextMenuItem>
              </ContextMenuContent>
            </ContextMenu>
          );
        })}
      </div>

      <ConfirmationDialog
        open={!!chatToDelete}
        onOpenChange={(open) => !open && setChatToDelete(null)}
        title="Delete Chat"
        description="Are you sure? This action cannot be undone."
        onConfirm={() => {
          if (chatToDelete) {
            deleteChat.mutate(chatToDelete);
            setChatToDelete(null);
          }
        }}
        isLoading={deleteChat.isPending}
      />
    </>
  );
}
</file>

<file path="src/hooks/useGlobalRealtime.ts">
'use client';

import { type InfiniteData, useQueryClient } from '@tanstack/react-query';
import { useEffect } from 'react';

import { supabase } from '@/lib/supabase/client';
import { normalizePayload } from '@/lib/supabase/utils';
import { usePresenceStore } from '@/store/usePresenceStore';
import type { FullChat, Message } from '@/types';
import type { User } from '@supabase/supabase-js';

interface RealtimePayload<T = Record<string, unknown>> {
  eventType: 'INSERT' | 'UPDATE' | 'DELETE';
  new: T;
  old: Partial<T>;
  errors?: string[];
}

interface ChatPayload {
  id: string;
  user_id: string;
  recipient_id: string;
  user_last_read_id?: string | null;
  recipient_last_read_id?: string | null;
  user_last_read_at?: string | null;
  recipient_last_read_at?: string | null;
  created_at: string;
  [key: string]: unknown;
}

interface MessagePayload {
  id: string;
  chat_id: string;
  sender_id: string;
  content: string;
  created_at: string;
  [key: string]: unknown;
}

export function useGlobalRealtime(user: User | null) {
  const queryClient = useQueryClient();
  const setOnlineUsers = usePresenceStore((state) => state.setOnlineUsers);

  useEffect(() => {
    if (!user?.id) return;
    const userId = user.id;

    const channel = supabase.channel('db-global-updates', {
      config: { presence: { key: userId } },
    });

    const updateLastSeen = async () => {
      await supabase.rpc('update_last_seen');
    };

    const heartbeatInterval = setInterval(() => {
      if (document.visibilityState === 'visible') {
        updateLastSeen();
      }
    }, 1000 * 60 * 5);

    const handleVisibilityChange = () => {
      if (document.visibilityState === 'hidden') {
        updateLastSeen();
      }
    };

    window.addEventListener('visibilitychange', handleVisibilityChange);
    window.addEventListener('beforeunload', updateLastSeen);

    channel
      .on('presence', { event: 'sync' }, () => {
        const state = channel.presenceState();
        const onlineIds = new Set<string>();
        for (const key of Object.keys(state)) {
          onlineIds.add(key);
        }
        setOnlineUsers(onlineIds);
      })
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'user' },
        () => {
          queryClient.invalidateQueries({ queryKey: ['contacts'], exact: false });
        },
      )
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'chats' },
        (payload: RealtimePayload<ChatPayload>) => {
          console.log('üöÄ Realtime: Chats update received:', payload);

          const normalizedNew = payload.new ? normalizePayload<ChatPayload>(payload.new) : null;
          const normalizedOld = payload.old ? normalizePayload<Partial<ChatPayload>>(payload.old) : null;

          if (payload.eventType === 'DELETE') {
            const deletedId = normalizedOld?.id;
            queryClient.removeQueries({ queryKey: ['chat', deletedId] });
            queryClient.setQueryData(['chats'], (old: FullChat[] | undefined) => 
              old ? old.filter(c => c.id !== deletedId) : []
            );
            return;
          }

          if (payload.eventType === 'UPDATE') {
            const updatedChat = normalizedNew;
            if (!updatedChat) return;

            const messagesCache = queryClient.getQueryData<InfiniteData<Message[]>>(['messages', updatedChat.id]);
            const allMessages = messagesCache?.pages.flat() || [];
            let shouldInvalidate = false;

            const resolveReadStatus = (newId: string | undefined | null, oldStatus: { id: string; createdAt: string } | null | undefined) => {
              if (!newId || newId === oldStatus?.id) return oldStatus;

              // Check for message in strict typed array first, but handle potentially raw data structure if needed
              // casting to 'any' for the find search to support _id fallback if accidentally present
              const message = allMessages.find((m) => m.id === newId) as (Message & { _id?: string }) | undefined;
              
              if (message) {
                 // Try standard 'createdAt' first (Project convention), fallback to 'created_at' if raw
                const timestamp = message.createdAt || (message as any).created_at || (message as any).timestamp;
                if (timestamp) {
                  console.log('‚úÖ Found message for status:', newId, timestamp);
                  return { id: newId, createdAt: timestamp };
                }
              }

              console.warn('‚ö†Ô∏è Message not found in cache for ID:', newId);
              shouldInvalidate = true; 
              return oldStatus; 
            };

            // 1. Update Detailed Chat Cache
            queryClient.setQueryData(['chat', updatedChat.id], (oldData: FullChat | undefined) => {
              if (!oldData) return oldData;
              return {
                ...oldData,
                recipientLastRead: resolveReadStatus(updatedChat.recipientLastReadId as string | null | undefined, oldData.recipientLastRead),
                userLastRead: resolveReadStatus(updatedChat.userLastReadId as string | null | undefined, oldData.userLastRead),
                recipientLastReadId: updatedChat.recipientLastReadId ?? oldData.recipientLastReadId,
                userLastReadId: updatedChat.userLastReadId ?? oldData.userLastReadId,
              } as FullChat;
            });

            // 2. Update Sidebar Chat List
            queryClient.setQueryData(['chats'], (oldChats: FullChat[] | undefined) => {
              if (!oldChats) return oldChats;
              return oldChats.map((c) => {
                if (c.id !== updatedChat.id) return c;
                return {
                  ...c,
                  recipientLastRead: resolveReadStatus(updatedChat.recipientLastReadId as string | null | undefined, c.recipientLastRead),
                  userLastRead: resolveReadStatus(updatedChat.userLastReadId as string | null | undefined, c.userLastRead),
                  recipientLastReadId: updatedChat.recipientLastReadId ?? c.recipientLastReadId,
                  userLastReadId: updatedChat.userLastReadId ?? c.userLastReadId,
                };
              });
            });

            // 3. FORCE RE-RENDER of messages to update "isRead" status in UI
            // We're expecting InfiniteData structure here
            queryClient.setQueryData(['messages', updatedChat.id], (oldData: InfiniteData<Message[]> | undefined) => {
              if (!oldData) return oldData;
              // We need to trigger a reference change for the data consumption hooks
              return {
                ...oldData,
                // Adding a property to the root object might not be valid for InfiniteData type strictly, 
                // but if we just want to re-trigger, copying the array is safer in React Query
                pages: [...oldData.pages]
              };
            });

            if (shouldInvalidate) {
              queryClient.invalidateQueries({ queryKey: ['chat', updatedChat.id] });
              queryClient.invalidateQueries({ queryKey: ['chats'] });
            }
            return;
          }

          if (payload.eventType === 'INSERT') {
            const newChat = normalizedNew;
            if (!newChat) return;
            const isParticipant = !newChat.user_id || newChat.user_id === userId || newChat.recipient_id === userId;
            if (isParticipant) {
              queryClient.invalidateQueries({ queryKey: ['chats'] });
            }
          }
        },
      )
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'messages' },
        (payload: RealtimePayload<MessagePayload>) => {
          const chatId = payload.new?.chat_id || payload.old?.chat_id;
          if (!chatId) return;

          const normalizedNew = payload.new ? normalizePayload<MessagePayload>(payload.new) : null;
          const normalizedOld = payload.old ? normalizePayload<Partial<MessagePayload>>(payload.old) : null;

          if (payload.eventType === 'DELETE') {
            const deletedId = normalizedOld?.id;
            queryClient.setQueryData(['messages', chatId], (oldData: InfiniteData<Message[]> | undefined) => {
              if (!oldData) return oldData;
              return {
                ...oldData,
                pages: oldData.pages.map((page) => page.filter((m) => m.id !== deletedId)),
              };
            });
            queryClient.invalidateQueries({ queryKey: ['chats'] });
            return;
          }

          if (payload.eventType === 'INSERT') {
            const newMessage = normalizedNew;
            if (!newMessage) return;
            queryClient.setQueryData(['messages', chatId], (oldData: InfiniteData<Message[]> | undefined) => {
               if (!oldData) return oldData;
               const newPages = [...oldData.pages];
               const lastPageIdx = newPages.length - 1;
               const exists = newPages.some(page => page.some((m) => m.id === newMessage.id));
               if (exists) return oldData;
               
               // Ensure the last page exists before appending
               if (lastPageIdx >= 0) {
                 newPages[lastPageIdx] = [...newPages[lastPageIdx], newMessage as unknown as Message];
               } else {
                 newPages[0] = [newMessage as unknown as Message];
               }
               
               return { ...oldData, pages: newPages };
            });
            queryClient.invalidateQueries({ queryKey: ['chats'] });
            return;
          }

          if (payload.eventType === 'UPDATE') {
            const updatedMessage = normalizedNew;
            if (!updatedMessage) return;
            queryClient.setQueryData(['messages', chatId], (oldData: InfiniteData<Message[]> | undefined) => {
               if (!oldData) return oldData;
               return {
                 ...oldData,
                 pages: oldData.pages.map((page) => 
                   page.map((msg) => msg.id === updatedMessage.id ? updatedMessage as unknown as Message : msg)
                 )
               };
            });
          }
        },
      )
      .subscribe(async (status: string) => {
        if (status === 'SUBSCRIBED') {
          await channel.track({
            user_id: userId,
            online_at: new Date().toISOString(),
          });
        }
        if (status === 'CLOSED' || status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
           updateLastSeen();
        }
      });

    return () => {
      clearInterval(heartbeatInterval);
      updateLastSeen();
      window.removeEventListener('visibilitychange', handleVisibilityChange);
      window.removeEventListener('beforeunload', updateLastSeen);
      supabase.removeChannel(channel);
    };
  }, [user?.id, queryClient, setOnlineUsers]);
}
</file>

<file path="src/db/schema.ts">
import { relations } from 'drizzle-orm';
import { 
  boolean, 
  jsonb, 
  pgTable, 
  text, 
  timestamp, 
  uuid, 
  index,
  type AnyPgColumn 
} from 'drizzle-orm/pg-core';
import type { Attachment } from '@/types';

// --- –¢–ê–ë–õ–ò–¶–Ø –ö–û–†–ò–°–¢–£–í–ê–ß–Ü–í ---
export const users = pgTable('user', {
  id: uuid('id').primaryKey(), 
  name: text('name'),
  email: text('email').notNull().unique(),
  emailVerified: timestamp('emailVerified', { mode: 'date' }),
  image: text('image'),
  lastSeen: timestamp('last_seen', { mode: 'date' }).defaultNow(),
}, (table) => ({
  emailIdx: index('idx_user_email').on(table.email), // –î–ª—è —à–≤–∏–¥–∫–æ–≥–æ –ø–æ—à—É–∫—É –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤
}));

// --- –¢–ê–ë–õ–ò–¶–Ø –ß–ê–¢–Ü–í ---
export const chats = pgTable('chats', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id')
    .notNull()
    .references(() => users.id, { onDelete: 'cascade' }),
  recipientId: uuid('recipient_id')
    .references(() => users.id, { onDelete: 'cascade' }),
  
  userLastReadId: uuid('user_last_read_id')
    .references((): AnyPgColumn => messages.id, { onDelete: 'set null' }),
  recipientLastReadId: uuid('recipient_last_read_id')
    .references((): AnyPgColumn => messages.id, { onDelete: 'set null' }),

  title: text('title').notNull().default('New Chat'),
  createdAt: timestamp('created_at').notNull().defaultNow(),
}, (table) => ({
  // –î–ª—è —à–≤–∏–¥–∫–æ–≥–æ –≤–∏–≤–µ–¥–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —á–∞—Ç—ñ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —é–∑–µ—Ä–∞
  userRecipientIdx: index('idx_chats_users').on(table.userId, table.recipientId),
}));

// --- –¢–ê–ë–õ–ò–¶–Ø –ü–û–í–Ü–î–û–ú–õ–ï–ù–¨ ---
export const messages = pgTable('messages', {
  id: uuid('id').primaryKey().defaultRandom(),
  chatId: uuid('chat_id')
    .notNull()
    .references((): AnyPgColumn => chats.id, { onDelete: 'cascade' }),
  senderId: uuid('sender_id')
    .notNull()
    .references(() => users.id, { onDelete: 'cascade' }),
  content: text('content'),
  attachments: jsonb('attachments').$type<Attachment[]>().notNull().default([]),
  
  replyToId: uuid('reply_to_id')
    .references((): AnyPgColumn => messages.id, { onDelete: 'set null' }),
  
  createdAt: timestamp('created_at').notNull().defaultNow(),
}, (table) => ({
  // –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–∏—à–≤–∏–¥—à—É—î —Ä–µ–Ω–¥–µ—Ä —á–∞—Ç—É —Ç–∞ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –∑–∞ —á–∞—Å–æ–º
  chatCreatedIdx: index('idx_messages_chat_created').on(table.chatId, table.createdAt),
  // –ü—Ä–∏—à–≤–∏–¥—à—É—î –ø–æ—à—É–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –≤—ñ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫–∞
  senderIdx: index('idx_messages_sender').on(table.senderId),
}));

// --- –í–Ü–î–ù–û–°–ò–ù–ò (RELATIONS) ---
export const usersRelations = relations(users, ({ many }) => ({
  chats: many(chats, { relationName: 'creator' }),
  messages: many(messages),
}));

export const chatsRelations = relations(chats, ({ one, many }) => ({
  user: one(users, { 
    fields: [chats.userId], 
    references: [users.id], 
    relationName: 'creator' 
  }),
  recipient: one(users, {
    fields: [chats.recipientId],
    references: [users.id],
    relationName: 'recipient',
  }),
  userLastReadMessage: one(messages, {
    fields: [chats.userLastReadId],
    references: [messages.id],
  }),
  recipientLastReadMessage: one(messages, {
    fields: [chats.recipientLastReadId],
    references: [messages.id],
  }),
  messages: many(messages),
}));

export const messagesRelations = relations(messages, ({ one }) => ({
  chat: one(chats, { 
    fields: [messages.chatId], 
    references: [chats.id] 
  }),
  sender: one(users, { 
    fields: [messages.senderId], 
    references: [users.id] 
  }),
  replyTo: one(messages, {
    fields: [messages.replyToId],
    references: [messages.id],
    relationName: 'replyingTo',
  }),
}));

export const uploadAudit = pgTable('upload_audit', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').references(() => users.id).notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
}, (table) => ({
  userTimeIdx: index('idx_upload_audit_user_time').on(table.userId, table.createdAt),
}));
</file>

<file path="package.json">
{
  "name": "my-messenger",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "preinstall": "npx only-allow pnpm",
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint src",
    "format": "biome format --write ./src",
    "check": "biome check --write ./src && pnpm lint",
    "setup": "pnpm install --frozen-lockfile",
    "xml": "npx repomix"
  },
  "dependencies": {
    "@radix-ui/react-alert-dialog": "^1.1.15",
    "@radix-ui/react-context-menu": "^2.2.16",
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-dropdown-menu": "^2.1.16",
    "@radix-ui/react-slot": "^1.2.4",
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.91.0",
    "@tanstack/react-query": "^5.90.20",
    "@tanstack/react-query-devtools": "^5.91.2",
    "@welldone-software/why-did-you-render": "^10.0.1",
    "browser-image-compression": "^2.0.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "date-fns": "^4.1.0",
    "dotenv": "^17.2.3",
    "drizzle-orm": "^0.45.1",
    "framer-motion": "^12.29.0",
    "humps": "^2.0.1",
    "linkify-react": "^4.3.2",
    "linkifyjs": "^4.3.2",
    "lru-cache": "^11.2.5",
    "lucide-react": "^0.563.0",
    "next": "16.1.4",
    "postcss": "^8.5.6",
    "postgres": "^3.4.8",
    "react": "19.2.3",
    "react-dom": "19.2.3",
    "react-virtuoso": "^4.18.1",
    "sonner": "^2.0.7",
    "tailwind-merge": "^3.4.0",
    "tailwindcss-animate": "^1.0.7",
    "zod": "^4.3.6",
    "zustand": "^5.0.10"
  },
  "devDependencies": {
    "@biomejs/biome": "^2.3.11",
    "@tailwindcss/postcss": "^4.1.18",
    "@types/humps": "^2.0.6",
    "@types/node": "^20",
    "@types/pg": "^8.16.0",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "babel-plugin-react-compiler": "1.0.0",
    "drizzle-kit": "^0.31.8",
    "eslint": "^9",
    "eslint-config-next": "16.1.4",
    "eslint-plugin-react-compiler": "19.1.0-rc.2",
    "tailwindcss": "^4.1.18",
    "typescript": "^5"
  }
}
</file>

<file path="src/app/chat/[id]/page.tsx">
'use client';

import { AnimatePresence, motion } from 'framer-motion';
import { ChevronDown } from 'lucide-react';
import Image from 'next/image';
import { useRouter } from 'next/navigation';
import { use, useCallback, useEffect, useMemo, useRef, useState } from 'react';
import { Virtuoso, type VirtuosoHandle } from 'react-virtuoso';

import ChatInput from '@/components/chat/ChatInput';
import { MessageBubble } from '@/components/chat/MessageBubble';
import { useSupabaseAuth } from '@/components/SupabaseAuthProvider';
import { ConfirmationDialog } from '@/components/ui/confirmation-dialog';
import {
  useChatDetails,
  useChatTyping,
  useDeleteMessage,
  useMessages,
  usePresence,
  useScrollToMessage,
} from '@/hooks/useChatHooks';
import { formatRelativeTime, getSafeTimestamp } from '@/lib/date-utils';
import type { Message, User } from '@/types';

export default function ChatPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = use(params);
  const router = useRouter();
  const { user } = useSupabaseAuth();

  const { data: chat, isLoading: isChatLoading, isError } = useChatDetails(id);
  const {
    data: messagesData,
    isLoading: isMessagesLoading,
    fetchPreviousPage,
    hasPreviousPage,
    isFetchingPreviousPage,
  } = useMessages(id);

  const { isTyping: typingUsers, setTyping } = useChatTyping(id);
  const messages = messagesData?.pages.flat() || [];
  const { onlineUsers } = usePresence();
  const deleteMessage = useDeleteMessage(id);

  const virtuosoRef = useRef<VirtuosoHandle>(null);
  const { scrollToMessage, highlightedId } = useScrollToMessage(
    virtuosoRef,
    messages,
    fetchPreviousPage,
    hasPreviousPage,
  );

  const [replyingTo, setReplyingTo] = useState<Message | null>(null);
  const [editingMessage, setEditingMessage] = useState<Message | null>(null);
  const [messageToDelete, setMessageToDelete] = useState<string | null>(null);
  const [showScrollButton, setShowScrollButton] = useState(false);

  // –†–µ–¥—ñ—Ä–µ–∫—Ç –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
  useEffect(() => {
    if (!isChatLoading && (isError || (!chat && !isMessagesLoading))) {
      router.replace('/');
    }
  }, [isChatLoading, chat, isError, router, isMessagesLoading]);

  // Interaction Handlers
  const handleReply = useCallback((message: Message) => {
    setEditingMessage(null);
    setReplyingTo(message);
  }, []);

  const handleEdit = useCallback((message: Message) => {
    setReplyingTo(null);
    setEditingMessage(message);
  }, []);

  const handleScrollToMessage = useCallback((messageId: string) => {
    scrollToMessage(messageId, { align: 'center' });
  }, [scrollToMessage]);

  // --- –õ–û–ì–Ü–ö–ê –û–ù–û–í–õ–ï–ù–ù–Ø –ì–ê–õ–û–ß–û–ö ---
  const recipientLastReadAt = useMemo(() => {
    if (!chat || !user) return null;
    
    // –í–∏–∑–Ω–∞—á–∞—î–º–æ, —á–∏–π timestamp —á–∏—Ç–∞–Ω–Ω—è –Ω–∞—Å —Ü—ñ–∫–∞–≤–∏—Ç—å (—Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞)
    const isUserCreator = chat.userId === user.id;
    return isUserCreator 
      ? chat.recipientLastRead?.createdAt 
      : chat.userLastRead?.createdAt;
  }, [chat, user]);

  if (isChatLoading || (isMessagesLoading && !messages.length)) {
    return (
      <div className="flex items-center justify-center h-full text-gray-400 bg-background">
        <div className="flex flex-col items-center gap-2">
          <div className="w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin" />
          <p className="text-sm font-medium animate-pulse">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —á–∞—Ç—É...</p>
        </div>
      </div>
    );
  }

  if (!chat || isError) return null;

  const otherParticipant = chat.participants.find((p: User) => p.id !== user?.id);
  const isOnline = otherParticipant && onlineUsers.has(otherParticipant.id);
  const isTypingNow = otherParticipant && typingUsers[otherParticipant.id];

  return (
    <div className="flex flex-col h-[calc(100dvh-64px)] w-full bg-background relative overflow-hidden">
      {/* Header */}
      <div className="px-3 sm:px-6 py-3 sm:py-4 border-b border-white/5 flex items-center justify-between backdrop-blur-xl bg-black/40 sticky top-0 z-20">
        <div className="flex items-center gap-3 sm:gap-4">
          <div className="relative w-10 h-10 sm:w-11 sm:h-11 rounded-full overflow-hidden border border-white/10 shadow-lg">
            <Image
              src={otherParticipant?.image || '/default-avatar.png'}
              alt={otherParticipant?.name || 'User'}
              fill
              className="object-cover"
              sizes="(max-width: 640px) 40px, 44px"
            />
          </div>
          <div className="min-w-0">
            <h2 className="text-sm sm:text-base font-bold text-white tracking-tight truncate leading-tight">
              {otherParticipant?.name || '–ù–µ–≤—ñ–¥–æ–º–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á'}
            </h2>
            <div className="text-[10px] sm:text-[11px] font-medium transition-colors">
              {isTypingNow ? (
                <span className="text-blue-400 animate-pulse">–¥—Ä—É–∫—É—î...</span>
              ) : isOnline ? (
                <span className="text-green-400">–≤ –º–µ—Ä–µ–∂—ñ</span>
              ) : (
                <span className="text-gray-500">
                  {otherParticipant?.lastSeen ? `–±—É–≤(–ª–∞) ${formatRelativeTime(otherParticipant.lastSeen)}` : '–Ω–µ –≤ –º–µ—Ä–µ–∂—ñ'}
                </span>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* Messages Area */}
      <div className="flex-1 relative min-h-0">
        {messages.length === 0 && !isMessagesLoading ? (
          <div className="absolute inset-0 flex flex-col items-center justify-center text-center p-4">
            <div className="w-20 h-20 bg-white/5 rounded-3xl flex items-center justify-center mb-4 border border-white/10 shadow-2xl">
              <span className="text-3xl">üí¨</span>
            </div>
            <h3 className="text-white font-semibold text-lg mb-1">–ü–æ–∫–∏ —â–æ –ø–æ—Ä–æ–∂–Ω—å–æ</h3>
            <p className="text-gray-500 text-sm max-w-[280px]">–ù–∞–ø–∏—à—ñ—Ç—å —â–æ—Å—å, —â–æ–± —Ä–æ–∑–ø–æ—á–∞—Ç–∏ –±–µ—Å—ñ–¥—É!</p>
          </div>
        ) : (
          <Virtuoso
            ref={virtuosoRef}
            data={messages}
            initialTopMostItemIndex={messages.length - 1}
            followOutput={(isAtBottom) => (isAtBottom ? 'smooth' : false)}
            className="no-scrollbar"
            atBottomStateChange={(atBottom) => setShowScrollButton(!atBottom)}
            startReached={() => {
              if (hasPreviousPage && !isFetchingPreviousPage) {
                fetchPreviousPage();
              }
            }}
            itemContent={(_index, message) => (
              <div className="px-2 sm:px-6 lg:px-8 max-w-5xl mx-auto w-full py-0.5">
                <MessageBubble
                  key={message.id}
                  message={message}
                  currentUserId={user?.id}
                  isRead={
  // 1. –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–∏–≤ –Ø
  (message.senderId || message.sender_id) === user?.id &&
  // 2. –£ –Ω–∞—Å –Ñ –¥–∞—Ç–∞ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—è –≤—ñ–¥ —ñ–Ω—à–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  !!recipientLastReadAt && 
  // 3. –¶—è –¥–∞—Ç–∞ ‚Äî —Ü–µ –Ω–µ –ø–æ—Ä–æ–∂–Ω—ñ–π —Ä—è–¥–æ–∫ —ñ –Ω–µ –ø–æ–º–∏–ª–∫–∞
  getSafeTimestamp(recipientLastReadAt) !== 0 &&
  // 4. –¢–Ü–õ–¨–ö–ò –¢–û–î–Ü –ø–æ—Ä—ñ–≤–Ω—é—î–º–æ
  getSafeTimestamp(message.createdAt || message.created_at) <= getSafeTimestamp(recipientLastReadAt)
}
                  onReply={handleReply}
                  onEdit={handleEdit}
                  onDelete={setMessageToDelete}
                  onScrollToMessage={handleScrollToMessage}
                  isHighlighed={highlightedId === message.id}
                  otherParticipantName={otherParticipant?.name || undefined}
                />
              </div>
            )}
            components={{
              Header: () => (
                <div className="py-10 text-center">
                  {isFetchingPreviousPage ? (
                    <span className="text-[10px] text-gray-600 uppercase tracking-widest animate-pulse">
                      –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...
                    </span>
                  ) : !hasPreviousPage && messages.length > 0 ? (
                    <span className="text-[10px] text-gray-600 uppercase tracking-widest opacity-50 italic">
                      –ü–æ—á–∞—Ç–æ–∫ —ñ—Å—Ç–æ—Ä—ñ—ó
                    </span>
                  ) : null}
                </div>
              ),
              Footer: () => <div className="h-6 w-full" />,
            }}
          />
        )}

        <AnimatePresence>
          {showScrollButton && messages.length > 0 && (
            <motion.button
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: 10 }}
              onClick={() => {
                virtuosoRef.current?.scrollToIndex({
                  index: messages.length,
                  behavior: 'smooth',
                  align: 'end',
                });
              }}
              className="absolute bottom-6 right-6 p-3 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 backdrop-blur-2xl text-white shadow-2xl z-10"
            >
              <ChevronDown className="w-5 h-5" />
            </motion.button>
          )}
        </AnimatePresence>
      </div>

      {/* Input Section */}
      <div className="w-full border-t border-white/5 bg-black/40 backdrop-blur-2xl z-20">
        <div className="max-w-5xl mx-auto px-1.5 sm:px-4 py-2 sm:py-4">
          <ChatInput
            chatId={id}
            setTyping={setTyping}
            replyToId={replyingTo?.id}
            onReplyCancel={() => setReplyingTo(null)}
            editingMessage={editingMessage}
            onEditCancel={() => setEditingMessage(null)}
            onMessageSent={() => {
              const wasEditing = !!editingMessage;
              setReplyingTo(null);
              setEditingMessage(null);
              
              if (!wasEditing) {
                requestAnimationFrame(() => {
                  virtuosoRef.current?.scrollToIndex({
                    index: messages.length,
                    behavior: 'smooth',
                    align: 'end',
                  });
                });
              }
            }}
          />
        </div>
        <div className="h-[env(safe-area-inset-bottom,16px)]" />
      </div>

      <ConfirmationDialog
        open={!!messageToDelete}
        onOpenChange={(open) => !open && setMessageToDelete(null)}
        title="–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è?"
        description="–¶—è –¥—ñ—è –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω–∞. –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑–Ω–∏–∫–Ω–µ –¥–ª—è –æ–±–æ—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤."
        onConfirm={() => {
          if (messageToDelete) {
            deleteMessage.mutate(messageToDelete);
            setMessageToDelete(null);
          }
        }}
        isLoading={deleteMessage.isPending}
      />
    </div>
  );
}
</file>

<file path="src/hooks/useChatHooks.ts">
'use client';

import { useState, useEffect, useRef, useCallback } from 'react';
import { 
  useInfiniteQuery, 
  useMutation, 
  useQuery, 
  useQueryClient 
} from '@tanstack/react-query';
import { toast } from 'sonner';
import { useRouter } from 'next/navigation';

// –ó–∞–ª–∏—à–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –û–î–ò–ù –≤–∞—Ä—ñ–∞–Ω—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó —Ç–∞ –∫–ª—ñ—î–Ω—Ç–∞
import { useSupabaseAuth } from '@/components/SupabaseAuthProvider';
import { supabase } from '@/lib/supabase/client';
import { usePresenceStore } from '@/store/usePresenceStore';
import { normalizePayload } from '@/lib/supabase/utils';
import type { FullChat, Message, User } from '@/types';

// 1. –û—Ç—Ä–∏–º–∞–Ω–Ω—è —á–∞—Ç—ñ–≤
export function useChats() {
  const { user } = useSupabaseAuth();

  return useQuery({
    queryKey: ['chats'],
    queryFn: async () => {
      if (!user) return [];

      const { data, error } = await supabase
        .from('chats')
        .select(`
          *,
          user:user_id(*),      
          recipient:recipient_id(*),
          userLastRead:user_last_read_id(id, createdAt:created_at),
          recipientLastRead:recipient_last_read_id(id, createdAt:created_at),
          messages!messages_chat_id_chats_id_fk(
            id, 
            content, 
            createdAt:created_at, 
            senderId:sender_id, 
            chat_id:chat_id, 
            attachments
          )
        `)
        .or(`user_id.eq.${user.id},recipient_id.eq.${user.id}`)
        .order('created_at', { foreignTable: 'messages', ascending: false })
        .limit(1, { foreignTable: 'messages' });

      if (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É —á–∞—Ç—ñ–≤:', error.message);
        throw error;
      }

      const normalizedChats = normalizePayload<FullChat[]>(data);
      
      // –°–æ—Ä—Ç—É—î–º–æ –∑–∞ –¥–∞—Ç–æ—é –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (Bubble to top)
      return normalizedChats.sort((a, b) => {
        const dateA = a.messages?.[0]?.createdAt || a.createdAt;
        const dateB = b.messages?.[0]?.createdAt || b.createdAt;
        return new Date(dateB).getTime() - new Date(dateA).getTime();
      });
    },
    enabled: !!user,
  });
}

export function useMarkAsRead() {
  const queryClient = useQueryClient();
  const { user } = useSupabaseAuth();

  return useMutation({
    mutationFn: async ({ chatId, messageId }: { chatId: string; messageId: string }) => {
      if (!user?.id) return;

      const { error } = await supabase.rpc('mark_chat_as_read', {
        p_chat_id: chatId,        // –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ p_ –¥–ª—è —á—ñ—Ç–∫–æ—Å—Ç—ñ –∑ SQL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        p_message_id: messageId,
        p_user_id: user.id        // –ü–ï–†–ï–î–ê–Ñ–ú–û ID –Ø–í–ù–û, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ NULL —Å–µ—Å—ñ—ó
      });

      if (error) {
        console.error('Error marking as read:', error);
        throw error;
      }
    },
    onSuccess: (_, { chatId }) => {
      // –û–Ω–æ–≤–ª—é—î–º–æ –∫–µ—à, —â–æ–± MessageBubble –ø–æ–±–∞—á–∏–≤ –Ω–æ–≤—É –¥–∞—Ç—É –≤ recipientLastReadAt
      queryClient.invalidateQueries({ queryKey: ['chats'] });
      queryClient.invalidateQueries({ queryKey: ['chat', chatId] });
    },
  });
}

export function useChatDetails(chatId: string) {
  const { user } = useSupabaseAuth();

  return useQuery({
    queryKey: ['chat', chatId],
    queryFn: async () => {
      if (!user) throw new Error('Unauthorized');

      const { data, error } = await supabase
        .from('chats')
        .select(`
          *,
          participants:user!user_id(*),
          recipient:user!recipient_id(*),
          userLastRead:user_last_read_id(id, created_at),
          recipientLastRead:recipient_last_read_id(id, created_at)
        `)
        .eq('id', chatId)
        .single();

      if (error) throw error;

      const normalizedData = normalizePayload<FullChat>(data);
      
      // Normalize participants for the UI
      const participants = [normalizedData.participants, normalizedData.recipient].filter(Boolean) as User[];

      return { ...normalizedData, participants } as FullChat;
    },
    enabled: !!chatId && !!user,
  });
}

export function useMessages(chatId: string) {
  const { user } = useSupabaseAuth();
  const markAsReadMutation = useMarkAsRead();
  const lastProcessedId = useRef<string | null>(null);

  const query = useInfiniteQuery({
    queryKey: ['messages', chatId],
    queryFn: async ({ pageParam }) => {
      if (!chatId) return [];

      const { data, error } = await supabase
        .from('messages')
        /**
         * –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø PGRST200:
         * –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ 'replyTo:reply_to_id(*)' –∑–∞–º—ñ—Å—Ç—å —ñ–º–µ–Ω—ñ –∫–ª—é—á–∞ fkey.
         */
        .select('*, replyTo:reply_to_id(*)')
        .eq('chat_id', chatId)
        .order('created_at', { ascending: false })
        .limit(50)
        .lt('created_at', pageParam || '9999-12-31');

      if (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å:", error.message);
        throw error;
      }
      const normalizedData = normalizePayload<Message[]>(data || []);
      
      // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –º–∞—Å–∏–≤ (–Ω–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –±—É–¥—É—Ç—å –≤ –∫—ñ–Ω—Ü—ñ –º–∞—Å–∏–≤—É —Å—Ç–æ—Ä—ñ–Ω–∫–∏)
      return normalizedData.reverse();
    },
    initialPageParam: undefined as string | undefined,
    getPreviousPageParam: (firstPage) => {
      if (!firstPage || firstPage.length < 50) return undefined;
      return (firstPage[0] as Message).createdAt;
    },
    getNextPageParam: () => undefined,
    enabled: !!chatId,
    refetchOnWindowFocus: false,
  });

  // --- –ê–í–¢–û–ú–ê–¢–ò–ß–ù–ï –ü–†–û–ß–ò–¢–ê–ù–ù–Ø (–û–ù–û–í–õ–ï–ù–û) ---
  useEffect(() => {
    const allMessages = query.data?.pages.flat() || [];
    if (allMessages.length === 0 || !user?.id) return;

    const latestMessage = allMessages.reduce((prev, current) => {
      return (new Date(current.createdAt) > new Date(prev.createdAt)) ? current : prev;
    });
    
    const msgId = latestMessage.id;
    const msgSenderId = latestMessage.senderId;

    if (msgId && msgSenderId !== user.id && lastProcessedId.current !== msgId) {
      lastProcessedId.current = msgId;
      markAsReadMutation.mutate({ chatId, messageId: msgId });
    }
  }, [query.data?.pages, user?.id, chatId, markAsReadMutation.mutate]);

  return query;
}

// 3. –ü–æ—à—É–∫ (–¥–ª—è ContactsList)
export function useSearchUsers(queryText: string) {
  const { user: currentUser } = useSupabaseAuth();

  return useQuery({
    queryKey: ['contacts', queryText, currentUser?.id],
    queryFn: async () => {
      // 1. –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ undefined UUID
      if (!currentUser?.id) return [];

      let query = supabase
        .from('user')
        .select('id, name, email, image, last_seen') // –í–∏–±–∏—Ä–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ç—ñ –ø–æ–ª—è, —â–æ —ñ—Å–Ω—É—é—Ç—å
        .neq('id', currentUser.id);

      if (queryText.trim().length > 1) {
        // –ü–æ—à—É–∫ –∑–∞ —ñ–º'—è–º –∞–±–æ –ø–æ—à—Ç–æ—é
        query = query.or(`name.ilike.%${queryText}%,email.ilike.%${queryText}%`).limit(10);
      } else if (!queryText.trim()) {
        // Task 2: 20 —é–∑–µ—Ä—ñ–≤, —è–∫—ñ –∑–∞—Ö–æ–¥–∏–ª–∏ –Ω–µ—â–æ–¥–∞–≤–Ω–æ (—Å–æ—Ä—Ç—É—î–º–æ –∑–∞ last_seen)
        // –Ø–∫—â–æ –≤ –±–∞–∑—ñ –ø–æ–ª–µ –∑–≤–µ—Ç—å—Å—è last_seen ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –π–æ–≥–æ
        query = query.order('last_seen', { ascending: false, nullsFirst: false }).limit(20);
      } else {
        return [];
      }

      const { data, error } = await query;

      if (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ useSearchUsers:', error.message);
        throw error;
      }

      return data as User[];
    },
    // –ó–∞–ø–∏—Ç —Å–ø—Ä–∞—Ü—é—î —Ç—ñ–ª—å–∫–∏ –∫–æ–ª–∏ —î —é–∑–µ—Ä —ñ –∞–±–æ –ø–æ—Ä–æ–∂–Ω—ñ–π —Ä—è–¥–æ–∫, –∞–±–æ > 1 —Å–∏–º–≤–æ–ª–∞
    enabled: !!currentUser?.id && (queryText.trim().length === 0 || queryText.trim().length > 1),
  });
}

// 4. –ü—Ä–∏—Å—É—Ç–Ω—ñ—Å—Ç—å (–¥–ª—è ContactsList)
export function usePresence() {
  const onlineUsers = usePresenceStore((state) => state.onlineUsers);
  return { onlineUsers };
}

export function useChatTyping(chatId: string) {
  const { user } = useSupabaseAuth();
  const [isTyping, setIsTyping] = useState<Record<string, boolean>>({});
  const channelRef = useRef<any>(null);
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);

  useEffect(() => {
    if (!chatId || !user?.id) return;

    const channel = supabase.channel(`typing:${chatId}`, {
      config: { presence: { key: user.id } },
    });

    channel
      .on('presence', { event: 'sync' }, () => {
        const state = channel.presenceState();
        const typingMap: Record<string, boolean> = {};
        
        for (const id in state) {
          typingMap[id] = (state[id] as any[]).some((p) => p.isTyping);
        }
        setIsTyping(typingMap);
      })
      .subscribe(async (status: string) => {
        if (status === 'SUBSCRIBED') {
          await channel.track({ isTyping: false });
        }
      });

    channelRef.current = channel;

    return () => {
      if (timeoutRef.current) clearTimeout(timeoutRef.current);
      channel.unsubscribe();
      channelRef.current = null;
    };
  }, [chatId, user]);

  const setTyping = useCallback((typing: boolean) => {
    if (channelRef.current) {
      channelRef.current.track({ isTyping: typing });

      // Auto-cleanup timer: 3 seconds
      if (timeoutRef.current) clearTimeout(timeoutRef.current);
      
      if (typing) {
        timeoutRef.current = setTimeout(() => {
          channelRef.current?.track({ isTyping: false });
        }, 3000);
      }
    }
  }, []);

  return { isTyping, setTyping };
}

export function useEditMessage(chatId: string) {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ messageId, content }: { messageId: string; content: string }) => {
      const { data, error } = await supabase
        .from('messages')
        .update({ content, updated_at: new Date().toISOString() })
        .eq('id', messageId)
        .select('*, replyTo:reply_to_id(*)')
        .single();

      if (error) throw error;
      return data;
    },
    onMutate: async (newEdit) => {
      await queryClient.cancelQueries({ queryKey: ['messages', chatId] });
      const previousData = queryClient.getQueryData(['messages', chatId]);

      queryClient.setQueryData(['messages', chatId], (old: any) => {
        if (!old) return old;
        return {
          ...old,
          pages: old.pages.map((page: any) =>
            page.map((msg: any) =>
              msg.id === newEdit.messageId ? { ...msg, content: newEdit.content, updated_at: new Date().toISOString() } : msg
            )
          ),
        };
      });

      return { previousData };
    },
    onError: (error: any, _, context) => {
      if (context?.previousData) {
        queryClient.setQueryData(['messages', chatId], context.previousData);
      }
      toast.error(`–ü–æ–º–∏–ª–∫–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è: ${error.message}`);
    },
    onSuccess: () => {
      toast.success('–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ');
    },
  });
}

// 5. –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
export function useSendMessage(chatId: string) {
  const { user } = useSupabaseAuth();
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ 
      content, 
      replyToId,
      attachments 
    }: { 
      content: string; 
      replyToId?: string;
      attachments?: any[];
    }) => {
      if (!user) throw new Error('–í–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ');

      // 1. –í—Å—Ç–∞–≤–ª—è—î–º–æ –¥–∞–Ω—ñ. 
      // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ .select() –∑ —è–≤–Ω–∏–º –≤–∫–∞–∑–∞–Ω–Ω—è–º –∑–≤'—è–∑–∫—É, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –¥—É–±–ª—ñ–≤ –∫–ª—é—á—ñ–≤
      const { error, data } = await supabase
        .from('messages')
        .insert({
          chat_id: chatId,
          sender_id: user.id,
          content,
          reply_to_id: replyToId || null,
          attachments: attachments || [],
        })
        .select('*, replyTo:reply_to_id(*)')
        .single();

      if (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏:", error.message);
        throw error;
      }
      return data;
    },

    onMutate: async (newMessage) => {
      // –°–∫–∞—Å–æ–≤—É—î–º–æ –∞–∫—Ç–∏–≤–Ω—ñ –∑–∞–ø–∏—Ç–∏, —â–æ–± –≤–æ–Ω–∏ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–ª–∏ –Ω–∞—à –æ–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–∏–π —Å—Ç–µ–π—Ç
      await queryClient.cancelQueries({ queryKey: ['messages', chatId] });

      // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –¥–∞–Ω—ñ –¥–ª—è –≤—ñ–¥–∫–∞—Ç—É —É —Ä–∞–∑—ñ –ø–æ–º–∏–ª–∫–∏
      const previousData = queryClient.getQueryData(['messages', chatId]);

      // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –Ω–∞ —è–∫–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î–º–æ (–¥–ª—è UI)
      const allMessages = (previousData as any)?.pages?.flat() || [];
      const parentMessage = newMessage.replyToId 
        ? allMessages.find((m: any) => m.id === newMessage.replyToId)
        : null;

      // –°—Ç–≤–æ—Ä—é—î–º–æ "—Ñ–µ–π–∫–æ–≤–µ" –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –º–∏—Ç—Ç—î–≤–æ–≥–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
      const optimisticMessage = {
        id: `temp-${Date.now()}`,
        content: newMessage.content,
        senderId: user?.id,
        chatId: chatId,
        createdAt: new Date().toISOString(),
        replyTo: parentMessage,
        attachments: newMessage.attachments || [],
        isOptimistic: true 
      };

      // –û–Ω–æ–≤–ª—é—î–º–æ –∫–µ—à React Query
      queryClient.setQueryData(['messages', chatId], (old: any) => {
        if (!old) return { pages: [[optimisticMessage]], pageParams: [undefined] };
        
        const newPages = [...old.pages];
        const lastPageIdx = newPages.length - 1;
        
        // –î–æ–¥–∞—î–º–æ –≤ –∫—ñ–Ω–µ—Ü—å –æ—Å—Ç–∞–Ω–Ω—å–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        newPages[lastPageIdx] = [...newPages[lastPageIdx], optimisticMessage];
  
        return { ...old, pages: newPages };
      });

      // --- –û–ü–¢–ò–ú–Ü–°–¢–ò–ß–ù–ï –û–ù–û–í–õ–ï–ù–ù–Ø –°–ü–ò–°–ö–£ –ß–ê–¢–Ü–í (Bubble to top) ---
      queryClient.setQueryData(['chats'], (old: any) => {
        if (!old) return old;
        const chatIndex = old.findIndex((c: any) => c.id === chatId);
        if (chatIndex === -1) return old;

        const updatedChat = {
          ...old[chatIndex],
          messages: [optimisticMessage], // –û–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–µ–≤'—é
        };

        const otherChats = old.filter((c: any) => c.id !== chatId);
        return [updatedChat, ...otherChats]; // –°—Ç–∞–≤–∏–º–æ –Ω–∞ –ø–æ—á–∞—Ç–æ–∫
      });

      return { previousData };
    },

    onError: (error: Error, _, context) => {
      // –Ø–∫—â–æ –ø–æ–º–∏–ª–∫–∞ ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ —Å—Ç–∞—Ä—ñ –¥–∞–Ω—ñ
      if (context?.previousData) {
        queryClient.setQueryData(['messages', chatId], context.previousData);
      }
      toast.error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏: ${error.message}`);
    },

    onSuccess: (savedMessage) => {
      // –ö–æ–ª–∏ –ø—Ä–∏–π—à–ª–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ –±–∞–∑–∏, –∑–∞–º—ñ–Ω—é—î–º–æ "temp" –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞ —Ä–µ–∞–ª—å–Ω–µ
      queryClient.setQueryData(['messages', chatId], (old: any) => {
        if (!old) return old;
        return {
          ...old,
          pages: old.pages.map((page: any[]) =>
            page.map((msg) => 
              msg.id.toString().startsWith('temp-') && msg.content === savedMessage.content 
                ? savedMessage 
                : msg
            )
          ),
        };
      });
    },

    onSettled: () => {
      // –§—ñ–Ω–∞–ª—å–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
      // queryClient.invalidateQueries({ queryKey: ['messages', chatId] });
    }
  });
}

export function useDeleteMessage(chatId: string) {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (messageId: string) => {
      const { data, error } = await supabase
        .from('messages')
        .delete()
        .eq('id', messageId)
        .select(); 

      if (error) throw error;
      if (!data || data.length === 0) {
        throw new Error('–ù–µ–º–∞—î –ø—Ä–∞–≤ –Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∞–±–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∂–µ –≤–∏–¥–∞–ª–µ–Ω–æ');
      }
      return data;
    },
    // –ß—ñ—Ç–∫–æ –≤–∫–∞–∑—É—î–º–æ, —â–æ —á–µ–∫–∞—î–º–æ string
    onMutate: async (messageId: string) => {
      await queryClient.cancelQueries({ queryKey: ['messages', chatId] });

      const previousData = queryClient.getQueryData(['messages', chatId]);

      queryClient.setQueryData(['messages', chatId], (old: any) => {
        if (!old) return old;
        return {
          ...old,
          pages: old.pages.map((page: any) =>
            // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ messageId –∑ –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤ –º—É—Ç–∞—Ü—ñ—ó
            page.filter((msg: any) => msg.id !== messageId)
          ),
        };
      });

      return { previousData };
    },
    onError: (error: any, messageId, context) => {
      if (context?.previousData) {
        queryClient.setQueryData(['messages', chatId], context.previousData);
      }
      toast.error('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è', {
        description: error.message,
      });
    },
    onSuccess: () => {
      toast.success('–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ');
    },
  });
}

export function useDeleteChat() {
  const router = useRouter();
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (chatId: string) => {
      const { error } = await supabase
        .from('chats')
        .delete()
        .eq('id', chatId);

      if (error) throw error;
      return chatId;
    },
    onSuccess: (chatId) => {
      // 1. –ü–†–ï–í–ï–ù–¢–ò–í–ù–û –≤–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –∑–∞–ø–∏—Ç–∏, –ø–æ–≤'—è–∑–∞–Ω—ñ –∑ —Ü–∏–º —á–∞—Ç–æ–º
      // –¶–µ –∑—É–ø–∏–Ω–∏—Ç—å –±—É–¥—å-—è–∫—ñ —Å–ø—Ä–æ–±–∏ React Query —Ä–µ—Ñ–µ—Ç—á–∏—Ç–∏ –¥–∞–Ω—ñ, –ø–æ–∫–∏ –º–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –Ω–∞ —ñ–Ω—à—É —Å—Ç–æ—Ä—ñ–Ω–∫—É
      queryClient.removeQueries({ queryKey: ['chat', chatId] });
      queryClient.removeQueries({ queryKey: ['messages', chatId] });

      // 2. –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ —á–∞—Ç—ñ–≤ –ª–æ–∫–∞–ª—å–Ω–æ (–æ–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–æ)
      queryClient.setQueryData(['chats'], (old: any) => {
        if (!old) return old;
        return old.filter((chat: any) => chat.id !== chatId);
      });

      // 3. –í–∏–≤–æ–¥–∏–º–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
      toast.success('–ß–∞—Ç –≤–∏–¥–∞–ª–µ–Ω–æ');

      // 4. –†–µ–¥—ñ—Ä–µ–∫—Ç –Ω–∞ –≥–æ–ª–æ–≤–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É –º–µ—Å–µ–Ω–¥–∂–µ—Ä–∞
      router.push('/chat'); 
    },
    onError: (error: Error) => {
      toast.error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ —á–∞—Ç: ${error.message}`);
    }
  });
}


export function useUpdateLastSeen() {
  const { user } = useSupabaseAuth();

  return useMutation({
    mutationFn: async () => {
      if (!user) return;

      const { error } = await supabase.rpc('update_last_seen');

      if (error) throw error;
    },
    onError: (error: Error) => {
      console.error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø—Ä–∏—Å—É—Ç–Ω–æ—Å—Ç—ñ:', error);
    },
  });
}

export function useScrollToMessage(
  virtuosoRef: React.RefObject<any>,
  messages: Message[],
  fetchPreviousPage: () => void,
  hasPreviousPage: boolean,
) {
  const [highlightedId, setHighlightedId] = useState<string | null>(null);

  const scrollToMessage = useCallback(
    async (messageId: string, options?: { align?: 'start' | 'center' | 'end'; behavior?: 'smooth' | 'auto' }) => {
      const index = messages.findIndex((m: Message) => m.id === messageId);

      if (index !== -1) {
        virtuosoRef.current?.scrollToIndex({
          index,
          behavior: options?.behavior || 'smooth',
          align: options?.align || 'center',
        });
        setHighlightedId(messageId);
        setTimeout(() => setHighlightedId(null), 2000);
      } else {
        if (hasPreviousPage) {
          fetchPreviousPage();
          toast.info('–ü—ñ–¥–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é...');
        }
      }
    },
    [messages, hasPreviousPage, fetchPreviousPage, virtuosoRef],
  );

  return { scrollToMessage, highlightedId };
}
</file>

</files>
