'use client';

import { usePathname } from 'next/navigation';
import { useCallback, useEffect, useState } from 'react';
import Navbar from './Navbar';

interface ChatLayoutWrapperProps {
  children: React.ReactNode;
  sidebar?: React.ReactNode;
  user?: {
    id: string;
    name?: string | null;
    email?: string | null;
    image?: string | null;
  } | null;
}

export default function ChatLayoutWrapper({ children, sidebar, user }: ChatLayoutWrapperProps) {
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [prevPathname, setPrevPathname] = useState<string | null>(null);
  const pathname = usePathname();

  // Синхронізація при зміні шляху (без useEffect)
  if (pathname !== prevPathname) {
    if (isSidebarOpen) setIsSidebarOpen(false); // Закриваємо тільки якщо був відкритий
    setPrevPathname(pathname);
  }

  // Використовуємо useCallback, щоб посилання на функцію не змінювалося
  const handleClose = useCallback(() => {
    setIsSidebarOpen(false);
  }, []);

  useEffect(() => {
    window.addEventListener('close-mobile-sidebar', handleClose);
    return () => window.removeEventListener('close-mobile-sidebar', handleClose);
  }, [handleClose]);

  const toggleSidebar = () => setIsSidebarOpen((prev) => !prev);

  return (
    <div className="flex flex-col min-h-[100dvh]">
      <Navbar user={user} onMenuClick={toggleSidebar} />

      <div className="flex flex-1 pt-16 relative overflow-hidden">
        {user && (
          <>
            <button
              type="button"
              id="sidebar-overlay"
              className={`
                fixed inset-0 bg-black/60 backdrop-blur-sm lg:hidden
                transition-opacity duration-300
                z-[80] 
                ${isSidebarOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}
              `}
              onClick={() => setIsSidebarOpen(false)}
              onKeyDown={(e) => {
                if (e.key === 'Escape') setIsSidebarOpen(false);
              }}
              aria-label="Close Sidebar"
            />

            <div
              className={`
                fixed lg:static inset-y-0 left-0 
                z-[90] 
                transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}
                transition-transform duration-300 ease-in-out
                w-80 h-[calc(100dvh-64px)] mt-16 lg:mt-0
                bg-black lg:bg-transparent
              `}
            >
              {sidebar}
            </div>
          </>
        )}

        <main className="flex-1 w-full min-w-0 relative z-0">{children}</main>
      </div>
    </div>
  );
}
