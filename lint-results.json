
> my-messenger@0.1.0 lint
> eslint src --format json

[{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\actions\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\actions\\chat-actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\app\\api\\auth\\[...nextauth]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\app\\chat\\[id]\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'markAsRead'. Either include it or remove the dependency array.","line":21,"column":6,"nodeType":"ArrayExpression","endLine":21,"endColumn":29,"suggestions":[{"desc":"Update the dependencies array to be: [id, markAsRead, markAsRead.mutate]","fix":{"range":[754,777],"text":"[id, markAsRead, markAsRead.mutate]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport Image from 'next/image';\nimport { useSession } from 'next-auth/react';\nimport { use, useEffect } from 'react';\nimport ChatInput from '@/components/chat/ChatInput';\nimport { useChatDetails, useMarkAsRead, useMessages, useTyping } from '@/hooks/useChatHooks';\n\nexport default function ChatPage({ params }: { params: Promise<{ id: string }> }) {\n  const { id } = use(params);\n  const { data: session } = useSession();\n  const { data: chat, isLoading: isChatLoading } = useChatDetails(id);\n  const { data: messages, isLoading: isMessagesLoading } = useMessages(id);\n  const markAsRead = useMarkAsRead();\n  const { isTyping } = useTyping(id, session?.user?.id);\n\n  useEffect(() => {\n    if (id) {\n      markAsRead.mutate(id);\n    }\n  }, [id, markAsRead.mutate]);\n\n  if (isChatLoading || isMessagesLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-[calc(100vh-80px)] text-gray-400\">\n        Loading chat...\n      </div>\n    );\n  }\n\n  if (!chat) {\n    return (\n      <div className=\"flex items-center justify-center h-[calc(100vh-80px)] text-gray-400\">\n        Chat not found\n      </div>\n    );\n  }\n\n  const otherParticipant = chat.participants[0];\n  const typingUser = chat.participants.find((p) => isTyping[p.id]);\n\n  return (\n    <div className=\"flex flex-col h-[calc(100vh-80px)] max-w-4xl mx-auto\">\n      {/* Header */}\n      <div className=\"px-6 py-4 border-b border-white/10 flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <div className=\"relative w-10 h-10 rounded-full overflow-hidden border border-white/10\">\n            <Image\n              src={otherParticipant?.image || '/default-avatar.png'}\n              alt={otherParticipant?.name || 'User'}\n              fill\n              className=\"object-cover\"\n              sizes=\"40px\"\n            />\n          </div>\n          <div>\n            <h2 className=\"text-xl font-bold text-white\">\n              {otherParticipant?.name || 'Unknown User'}\n            </h2>\n            <p className=\"text-xs text-gray-400\">\n              {otherParticipant?.lastSeen\n                ? `Last seen ${new Date(otherParticipant.lastSeen).toLocaleTimeString()}`\n                : 'Offline'}\n            </p>\n          </div>\n        </div>\n      </div>\n\n      {/* Messages */}\n      <div className=\"flex-1 overflow-y-auto p-6 space-y-4 flex flex-col-reverse\">\n        {typingUser && (\n          <div className=\"flex justify-start\">\n            <div className=\"bg-white/5 px-4 py-2 rounded-2xl text-xs text-gray-400 animate-pulse\">\n              {typingUser.name} is typing...\n            </div>\n          </div>\n        )}\n\n        {!messages || messages.length === 0 ? (\n          <div className=\"flex items-center justify-center h-full text-gray-500 text-sm\">\n            Немає повідомлень. Почніть спілкування!\n          </div>\n        ) : (\n          messages.map((message) => {\n            const isMe = message.senderId === session?.user?.id || message.senderId === 'me';\n            return (\n              <div key={message.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>\n                <div\n                  className={`max-w-[70%] px-4 py-2 rounded-2xl ${\n                    isMe\n                      ? 'bg-blue-600 text-white rounded-br-none'\n                      : 'bg-white/10 text-gray-200 rounded-bl-none'\n                  }`}\n                >\n                  <p className=\"text-sm\">{message.content}</p>\n                  <div className=\"flex items-center justify-between gap-2 mt-1\">\n                    <span className=\"text-[10px] opacity-70 block\">\n                      {new Date(message.createdAt).toLocaleTimeString('en-US', {\n                        hour: '2-digit',\n                        minute: '2-digit',\n                      })}\n                    </span>\n                    {isMe && (\n                      <span className=\"text-[10px] opacity-70\">\n                        {message.isRead ? 'Read' : 'Sent'}\n                      </span>\n                    )}\n                  </div>\n                </div>\n              </div>\n            );\n          })\n        )}\n      </div>\n\n      {/* Input */}\n      <ChatInput chatId={id} />\n    </div>\n  );\n}\n\nChatPage.whyDidYouRender = true;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\app\\chat\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\app\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\components\\Providers.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\components\\auth\\AuthProvider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\components\\auth\\auth-buttons.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\components\\chat\\ChatInput.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\components\\layout\\Navbar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\components\\layout\\Sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\components\\sidebar\\ChatList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\components\\sidebar\\ContactsList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\components\\sidebar\\NewChatButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\components\\sidebar\\SearchInput.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\components\\sidebar\\Sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\components\\sidebar\\SidebarShell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\components\\ui\\Logo.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\db\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\db\\schema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\hooks\\useChatHooks.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_data' is defined but never used.","line":146,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":146,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_chatId' is defined but never used.","line":146,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":146,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';\nimport { useEffect, useState } from 'react';\nimport {\n  getChatsAction,\n  getFullChatAction,\n  markAsReadAction,\n  searchUsersAction,\n  sendMessageAction,\n  updateLastSeenAction,\n} from '@/actions/chat-actions';\nimport { supabase } from '@/lib/supabase';\nimport type { Message } from '@/types';\n\ninterface ExtendedMessage extends Message {\n  isOptimistic?: boolean;\n}\n\nexport function useChats() {\n  return useQuery({\n    queryKey: ['chats'],\n    queryFn: async () => {\n      const result = await getChatsAction();\n      if (!result.success) throw new Error(result.error);\n      return result.data;\n    },\n  });\n}\n\nexport function useMessages(chatId: string) {\n  const queryClient = useQueryClient();\n\n  useEffect(() => {\n    if (!chatId) return;\n\n    const channel = supabase\n      .channel(`chat:${chatId}`)\n      .on(\n        'postgres_changes',\n        {\n          event: 'INSERT',\n          schema: 'public',\n          table: 'messages',\n          filter: `chat_id=eq.${chatId}`,\n        },\n        (payload: { new: Message }) => {\n          const newMessage = payload.new;\n          queryClient.setQueryData<ExtendedMessage[]>(['messages', chatId], (old) => {\n            if (!old) return [newMessage];\n\n            // Check if message ID already exists (deduplication)\n            if (old.some((m) => m.id === newMessage.id)) return old;\n\n            // Check for matching optimistic record\n            const matchIndex = old.findIndex(\n              (m) =>\n                m.isOptimistic &&\n                m.senderId === newMessage.senderId &&\n                m.content === newMessage.content,\n            );\n\n            if (matchIndex !== -1) {\n              const updated = [...old];\n              updated[matchIndex] = newMessage;\n              return updated;\n            }\n\n            return [newMessage, ...old];\n          });\n          queryClient.invalidateQueries({ queryKey: ['chats'] });\n        },\n      )\n      .subscribe();\n\n    return () => {\n      supabase.removeChannel(channel);\n    };\n  }, [chatId, queryClient]);\n\n  return useQuery({\n    queryKey: ['messages', chatId],\n    queryFn: async () => {\n      const result = await getFullChatAction(chatId);\n      if (!result.success) throw new Error(result.error);\n      return result.data.messages;\n    },\n    enabled: !!chatId,\n  });\n}\n\nexport function useChatDetails(chatId: string) {\n  return useQuery({\n    queryKey: ['chat', chatId],\n    queryFn: async () => {\n      const result = await getFullChatAction(chatId);\n      if (!result.success) throw new Error(result.error);\n      return result.data;\n    },\n    enabled: !!chatId,\n  });\n}\n\nexport function useSendMessage(chatId: string) {\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: ({ content }: { content: string }) => sendMessageAction(chatId, content),\n    onMutate: async ({ content }) => {\n      await queryClient.cancelQueries({ queryKey: ['messages', chatId] });\n\n      const previousMessages = queryClient.getQueryData<ExtendedMessage[]>(['messages', chatId]);\n\n      const optimisticMessage: ExtendedMessage = {\n        id: crypto.randomUUID(),\n        chatId,\n        senderId: 'me', // UI will handle this\n        content,\n        isRead: false,\n        createdAt: new Date(),\n        isOptimistic: true,\n      };\n\n      queryClient.setQueryData<ExtendedMessage[]>(['messages', chatId], (old) => [\n        optimisticMessage,\n        ...(old || []),\n      ]);\n\n      return { previousMessages };\n    },\n    onError: (_err, _variables, context) => {\n      if (context?.previousMessages) {\n        queryClient.setQueryData(['messages', chatId], context.previousMessages);\n      }\n    },\n    onSettled: () => {\n      queryClient.invalidateQueries({ queryKey: ['messages', chatId] });\n      queryClient.invalidateQueries({ queryKey: ['chats'] });\n    },\n  });\n}\n\nexport function useMarkAsRead() {\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: (chatId: string) => markAsReadAction(chatId),\n    onSuccess: (_data, _chatId) => {\n      queryClient.invalidateQueries({ queryKey: ['chats'] });\n    },\n  });\n}\n\nexport function usePresence(userId: string | undefined) {\n  const [onlineUsers, setOnlineUsers] = useState<Set<string>>(new Set());\n\n  useEffect(() => {\n    if (!userId) return;\n\n    const channel = supabase.channel('online-users');\n\n    channel\n      .on('presence', { event: 'sync' }, () => {\n        const state = channel.presenceState();\n        const ids = new Set<string>();\n        for (const id in state) {\n          const presences = state[id] as unknown as { user_id: string }[];\n          for (const p of presences) {\n            ids.add(p.user_id);\n          }\n        }\n        setOnlineUsers(ids);\n      })\n      .on('presence', { event: 'join' }, () => {})\n      .on('presence', { event: 'leave' }, () => {})\n      .subscribe(async (status) => {\n        if (status === 'SUBSCRIBED') {\n          await channel.track({\n            user_id: userId,\n            online_at: new Date().toISOString(),\n          });\n        }\n      });\n\n    return () => {\n      supabase.removeChannel(channel);\n    };\n  }, [userId]);\n\n  return { onlineUsers };\n}\n\nexport function useTyping(chatId: string, userId: string | undefined) {\n  const [isTyping, setIsTyping] = useState<Record<string, boolean>>({});\n\n  useEffect(() => {\n    if (!chatId || !userId) return;\n\n    const channel = supabase\n      .channel(`typing:${chatId}`)\n      .on('broadcast', { event: 'typing' }, ({ payload }) => {\n        if (payload.userId !== userId) {\n          setIsTyping((prev) => ({ ...prev, [payload.userId]: payload.isTyping }));\n          // Clear typing after 3 seconds of no updates\n          if (payload.isTyping) {\n            setTimeout(() => {\n              setIsTyping((prev) => ({ ...prev, [payload.userId]: false }));\n            }, 3000);\n          }\n        }\n      })\n      .subscribe();\n\n    return () => {\n      supabase.removeChannel(channel);\n    };\n  }, [chatId, userId]);\n\n  const setTyping = (typing: boolean) => {\n    supabase.channel(`typing:${chatId}`).send({\n      type: 'broadcast',\n      event: 'typing',\n      payload: { userId, isTyping: typing },\n    });\n  };\n\n  return { isTyping, setTyping };\n}\n\nexport function useSearchUsers(query: string) {\n  return useQuery({\n    queryKey: ['users', query],\n    queryFn: async () => {\n      // Only search if empty (initial list) or >= 2 characters\n      if (query && query.length < 2) return [];\n\n      const result = await searchUsersAction(query);\n      if (!result.success) throw new Error(result.error);\n      return result.data;\n    },\n    staleTime: 30 * 1000,\n  });\n}\n\nconst LAST_SEEN_THROTTLE = 1000 * 60 * 5; // 5 minutes\n\nexport function useUpdateLastSeen(userId: string | undefined) {\n  useEffect(() => {\n    if (!userId) return;\n\n    const update = async () => {\n      const lastUpdate = localStorage.getItem(`lastSeenUpdate:${userId}`);\n      const now = Date.now();\n\n      if (!lastUpdate || now - Number(lastUpdate) > LAST_SEEN_THROTTLE) {\n        await updateLastSeenAction();\n        localStorage.setItem(`lastSeenUpdate:${userId}`, now.toString());\n      }\n    };\n\n    update();\n    const interval = setInterval(update, LAST_SEEN_THROTTLE);\n    return () => clearInterval(interval);\n  }, [userId]);\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\lib\\supabase.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\store\\useChatStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\types\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\types\\next-auth.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\f4u4b\\Desktop\\Projects\\Trace\\src\\wdyr.ts","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":7,"column":29,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":7,"endColumn":77}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React from 'react';\n\nif (process.env.NODE_ENV === 'development') {\n  if (typeof window !== 'undefined') {\n    const whyDidYouRender = require('@welldone-software/why-did-you-render');\n    whyDidYouRender(React, {\n      trackAllPureComponents: true,\n    });\n  }\n}\n","usedDeprecatedRules":[]}]
